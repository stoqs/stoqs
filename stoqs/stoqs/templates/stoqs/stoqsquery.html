<!DOCTYPE html> <!--  HTML5 Doctype -->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <title>{{request.META.dbAlias}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Spatial Temporal Oceanographic Query System - User Interface" />
    <meta name="author" content="Mike McCann, MBARI" />

    <!-- The styles -->
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="{{STATIC_URL}}media/font/orbitron.css" rel="stylesheet">
    <style>
        body {
            padding-top: 35px;  /* 35px to make the container go all the way to the bottom of the topbar */
            height: 100%;       /* make the percentage height on flot placeholder work */
        }
        .stoqs-toggle {
            width: 100%;
        }
        .stoqs-background-ajax-loader-pulse {
            background-image: url({{STATIC_URL}}images/ajax-loader-pulse.gif);
        }
        .stoqs-background-ajax-loader-pp {
            background-image: url({{STATIC_URL}}images/ajax-loader-rotating1.gif);
            margin-left: 50%;
            margin-top: 30%;
            position: relative;
            background-position:center;
            background-repeat:no-repeat;
        }
        .stoqs-background-ajax-loader-3d {
            background-image: url({{STATIC_URL}}images/ajax-loader-rotating1.gif);
            background-position:center;
            background-repeat:no-repeat;
        }
        .stoqs-background-ajax-loader-3d-topright {
            background-image: url({{STATIC_URL}}images/ajax-loader.gif);
            background-position:80% 10%;
            background-repeat:no-repeat;
        }
        .olControlLoadingPanel {
            background-image:url({{STATIC_URL}}images/ajax-loader-rotating1.gif);
            margin-left: 50%;
            margin-top: 30%;
            width: 100px;
            height: 100px;
            position: relative;
            background-position:center;
            background-repeat:no-repeat;
            display: none;
        }
        .olControlAttribution {
            left:10em;
            top:10em;
        }
        .nav-tabs li.active a { 
            color: black;
        }
        .nav-tabs li.disabled a { 
            color: grey;
            cursor: no-drop;
        }
        .nav-tabs li.disabled a:hover { 
            border-color: transparent; 
            background-color: transparent; 
        }
        .stoqs-color-limit-input {
            width: 60px;
            height:15px;
        }
        .fail-text { 
            color: red;
        };
        x3d { margin-right:10px; margin-bottom:10px; }
        .webfont {font-family:'Orbitron';}
    </style>
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap.icon-large.min.css" rel="stylesheet">
    <link type="text/css" href="{{ STATIC_URL }}jquery/css/custom-theme/jquery-ui-1.8.17.custom.css" rel="stylesheet">
    <link type="text/css" href="{{ STATIC_URL }}jquery/css/jquery.dataTables.css" rel="stylesheet">
    <link type="text/css" href="{{ STATIC_URL }}x3dom-1.7.1/x3dom.css" rel="stylesheet">
    <!--<link type="text/css" href="http://www.x3dom.org/x3dom/dist/x3dom.css" rel="stylesheet">
    

    <!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <script language="javascript" type="text/javascript" src="{{STATIC_URL}}excanvas_r3/excanvas.js"></script>
    <![endif]-->

    <!-- The fav and touch icons -->
    <link rel="shortcut icon" href="{{STATIC_URL}}media/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-57-precomposed.png">

    {% if google_analytics_code %}
    <!-- Google Analytics -->
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', '{{google_analytics_code}}']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
    {% endif %}
  </head>

  <body style="background-color:#f5f5f5;">

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner" style="height:34px;">
        <div class="container" style="margin-left:20px;">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="{{home_page_link}}" style="padding-top:4px;"><img src="{{STATIC_URL}}images/{{home_page_logo}}" alt="{{home_page_alt}}"></a>
          <a class="brand" href="#">{{request.META.dbAlias}}</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="{% url 'stoqs:show-default' %}"><i class="icon-list-alt icon-white"></i> Campaign list</a></li>
            </ul>
            <ul class="nav">
              <li><a id="permalink" data-toggle="modal" href="#permalink-popup" data-action="{% url 'stoqs:generate_permalink' dbAlias=request.META.dbAlias %}">
                <i class="icon-eye-open icon-white"></i> Share this view</a></li>
            </ul>
            <ul class="nav">
              <li>
                <a href="https://github.com/stoqs/stoqs" target="_new">
                <i class="icon-edit icon-white"></i> STOQS Software</a>
              </li>
            </ul>
            <!--
            <form action="">
                <input type="text" placeholder="Search" />
            </form>
            -->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>


  <div id="permalink-popup" class="modal hide fade in" style="display:none;width:700px;">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">Ã—</a>
        <h3>Share this view</h3>
    </div>
    <div class="modal-body">
        <h4>Copy this link to your clipboard to and use it in e-mail, etc. to share this view of the data</h4>
        <div id="permalink-box" style="display:none">
            <input type="text" name="permalink" style="width: 100%">
        </div>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
  </div>

  <div class="container-fluid">

    <div class="row-fluid">

        <div id="left-column" class="span6 stoqs-zoom-width">

            <div id="accordion1" class="accordion well" style="border:none;">

                <div id="spatial-group" class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="spatial-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapseSpatial">
                        Spatial
                        </a></h3>
                    </div>
                    <div id="collapseSpatial" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul id="spatialTabs" class="nav nav-tabs">
                                <li class="active"><a href="#map2d" data-toggle="tab">Map</a></li>
                                <li id="spatial-3d-li" style="display:none"><a id="spatial-3d-anchor" href="#geo3d" data-toggle="tab">3D</a></li>
                            </ul>

                            <div class="tab-content">
                                <div class="tab-pane active" id="map2d">
                                    <div class="row-fluid" id="map" style="height:500px;">
                                    </div>
                                    <div class="row-fluid">
                                        <div class="span12">
                                            <form class="form-inline">
                                                <label class="checkbox">
                                                    <input type="checkbox" id="zoomtoextentonupdate" checked /> Zoom to extent on update
                                                </label>&nbsp;
                                                <label class="checkbox disabled" id="sensor-tracks-checkbox" style="display:none;">
                                                    <input type="checkbox" id="showsensortracks" disabled /><span id="showsensortrackstext">Sensor Tracks</span>
                                                </label>
                                            </form>
                                        </div>
                                        <div id="sensortracks-colorbar" class="span6">
                                        </div>
                                    </div>
                                    <div id="samplePoint"></div>
                                </div>
                                <div class="tab-pane" id="geo3d" style="height:100%;">
                                    <div id="geo-3dplot" style="height:500px;">
                                        <div id="geo-3dplot-control" class="span6" style='position:absolute;z-index:1000;;margin:0px;'>
                                        <div id="limit-div-width" class="span6" style="padding:0px;margin:0px;">
                                            <!-- Uncomment and comment out next div for video capture -->
                                            <!--
                                            <div class="span2">
                                                <img src="{{STATIC_URL}}images/logo_blue_200_tr.gif"/>
                                            </div>
                                            <div class="span2">
                                                <img src="{{STATIC_URL}}images/X3dSpecificationLogo.png"/>
                                            </div>
                                            -->
                                            <div class="accordion-heading">
                                                <div class="row-fluid">
                                                    <h2>
                                                        <a id="controls-3d" class="accordion-toggle btn-mini" data-toggle="collapse" href="#collapseContols3D" title="Show/Hide Controls" style="padding:0px;color:black;display:inline;"><i class="icon-th-list"></i></a>
                                                        <a id="nav-instr-3d" class="accordion-toggle btn-mini" data-toggle="collapse" href="#navInstr3D" title="Show cheat sheet" style="padding:0px;color:black;display:inline;"><i class="icon-info-sign"></i></a>
                                                        <a id="geo-zoom-lc-button" class="btn-mini zoom-lc-button" style="padding:0px;"><i class="icon-resize-full" title="Full Screen"></i></a>
                                                    </h2>
                                                    </div>
                                                    <div id="navInstr3D" class="accordion-body collapse in" style="margin:0px;background-color:rgba(128, 128, 128, 0.20);">
                                                        Select a Measured Parameter for plotting (radio button) to see it in 3D.
                                                        <br>
                                                        Check Platforms to animate their positions.
                                                        <br>
                                                        Open the Terrain section for terrain visualization options.
                                                        <br>
                                                        Navigation hints for <a href="http://doc.x3dom.org/tutorials/animationInteraction/navigation/index.html" target="_new">X3DOM</a>'s Examine mode:
                                                        <ul>
                                                        <em>Rotate: Left mouse</em><br>
                                                        <em>Translate: Ctrl + left mouse</em><br>
                                                        <em>Zoom: Alt + left mouse</em><br>
                                                        <em>Recenter rotation: double click</em><br>
                                                        <em>Navigation speed: +/-</em><br>
                                                        <em>Reset viewpoint: R</em><br>
                                                        </ul>
                                                        Experimental: <a id="geo-rift-button" class="btn btn-mini rift-button">Enter VR</a>
                                                    </div>
                                            </div>
                                            <div id="collapseContols3D" class="accordion-body in">
                                                <div class="row-fluid" style="margin:0px;background-color:rgba(128, 128, 128, 0.20);">
                                                    <h5><a id="data-3d" class="accordion-toggle" data-toggle="collapse" href="#data3D" title="Data Options" style="padding:0px;color:black;">
                                                        Data
                                                    </a></h5>
                                                    <div id="data3D" class="accordion-body in">
                                                        <form class="form-inline" style="margin:0px;">
                                                            <label class="checkbox disabled">
                                                                <input type="checkbox" id="showgeox3dmeasurement" />
                                                                <span id="showgeox3dmeasurementtext">Measurements</span>
                                                            </label>
                                                            <label class="checkbox disabled">
                                                                <input type="checkbox" id="showgeox3dsample" />
                                                                <span id="showgeox3dsampletext">Samples</span>
                                                            </label>
                                                            <span>
                                                                <label class="checkbox disabled">
                                                                    <input type="checkbox" id="showplatforms" />
                                                                    <span id="showplatformstext">Platforms</span>
                                                                </label>
                                                                <label class="checkbox" style="display:none;">
                                                                    <input type="checkbox" id="showgeox3dlabels" checked />
                                                                    <span id="showplatformstext">Labels</span>
                                                                </label>
                                                                <label class="checkbox" style="display:none;">
                                                                    <input type="checkbox" id="showgeox3denuaxes" checked />
                                                                    <span id="showplatformstext">ENU Axes</span>
                                                                </label>
                                                            </span>
                                                        </form>
                                                        <div id="geo3d-colorbar"></div>
                                                        <div id="spatial-3d-x3d-pp-slider" class="row-fluid" style="display:none;">
                                                            <div class="span1" style="padding:0px;margin-left:5px;"><i id="spatial-3d-x3d-pause-play" class="icon-play"></i></div>
                                                            <div class="span9" style="margin:0px;margin-top:3px;"><input id="spatial-3d-x3d-slider" type="range" min="0" max="1" step="0.001" value="0" style="height:1px;width:100%;"></div>
                                                            <div class="span2"><span id="spatial-3d-x3d-speedup"></span></div>
                                                        </div>
                                                        <div><span id="spatial-3d-x3d-message"></span></div>
                                                    </div>
                                                    <h5><a id="terrain-3d" class="accordion-toggle" data-toggle="collapse" href="#terrain3D" title="Show Terrain Options" style="padding:0px;color:black;">
                                                        Terrain
                                                    </a></h5>
                                                    <div id="terrain3D" class="accordion-body collapse in" style="float:none;display:inline-block;overflow-x:auto;white-space:nowrap;" >
                                                        <form id="terrain3D-choices" class="form-inline" style="margin:0px;">
                                                        </form>
                                                        <div id="x3d-ve"></div><br>
                                                    </div>
                                                </div> <!-- row-fluid -->
                                            </div> <!-- collapseContols3D -->
                                        </div> <!-- limit-div-width -->
                                        </div> <!-- geo-3dplot-control -->
                                        <div style="height:100%;">
                                        <X3D id="spatial-3d-x3d" style="width:100%;height:100%;margin:0px auto;display:block;border:none;" ondownloadsfinished="downloadsFinished(event)"> 
                                            <Scene>
                                                <Environment frustumCulling="false"></Environment>
                                                <NavigationInfo></NavigationInfo>
                                                <Viewpoint id="mp-x3d-viewpoint1" def="vp" onviewpointChanged="setScale(event)"></Viewpoint>
                                                <!-- Test GeoViewpoint for Monterey Bay area, user must page-down to bind to it -->
                                                <GeoViewpoint id="mp-x3d-geoviewpoint1" def="gvp" position="36.8 -122.1 100000" orientation="1 0 0 -1.57" centerofrotation="36.8 -122.1 0">
                                                </GeoViewpoint>
                                                <Background DEF='bgnd' skyColor=".9608 .9608 .9608"></Background>
                                                <Group id='spatial-3d-root' render='true'>
                                                    <Group id='spatial-3d-scene' def="spatial-3d-scene">
                                                        <GeoOriginTransform containerField='children'>
                                                            <Group id="mp-x3d-terrain">
                                                            </Group>
                                                        </GeoOriginTransform>
                                                        <Group id="platform-animations"></Group>
                                                        <Group id="platform-models"></Group>
                                                    </Group>
                                                </Group>

        <!-- Elements for Rift - Orientations routed to GeoViewpoint, so must page down to that Viewpoint -->
        <group id='spatial-3d-left' DEF='left' render='false'>
            <shape>
                <appearance>
                    <renderedTexture id="rtLeft" stereoMode="LEFT_EYE" update='ALWAYS'
                                     dimensions='640 800 4' repeatS='false' repeatT='false'>
                        <!--<viewpoint USE='vp' containerField='viewpoint'></viewpoint>-->
                        <geoviewpoint USE='gvp' containerField='GeoViewpoint'></geoviewpoint>
                        <background USE='bgnd' containerField='background'></background>
                        <!--group USE='left' containerField="excludeNodes"></group-->
                        <group USE='spatial-3d-scene' containerField="scene"></group>
                    </renderedTexture>

                    <composedShader>
                        <field name='tex' type='SFInt32' value='0'></field>
                        <field name='leftEye' type='SFFloat' value='1'></field>
                        <shaderPart type='VERTEX'>
                            attribute vec3 position;
                            attribute vec2 texcoord;

                            uniform mat4 modelViewProjectionMatrix;
                            varying vec2 fragTexCoord;

                            void main()
                            {
                                vec2 pos = sign(position.xy);
                                fragTexCoord = texcoord;

                                gl_Position = vec4((pos.x - 1.0) / 2.0, pos.y, 0.0, 1.0);
                                //gl_Position = vec4(pos.xy / 4.0 + vec2(-0.75,0.75), 0.0, 1.0);
                            }
                        </shaderPart>
                        <shaderPart DEF="frag" type='FRAGMENT'>
                            #ifdef GL_ES
                            precision highp float;
                            #endif

                            uniform sampler2D tex;
                            uniform float leftEye;
                            varying vec2 fragTexCoord;

                            void main()
                            {
                                float distortionScale = 0.7; //0.685;
                                //float distortionK[4] = float[](1.0, 0.22, 0.24, 0.0);
                                vec2 lensCenter = vec2(0.151976495726, 0.0);
                                if (leftEye == 0.0) {
                                    lensCenter.x *= -1.0;
                                }

                                vec2 theta = (fragTexCoord * 2.0) - 1.0;
                                float rSq = theta.x * theta.x + theta.y * theta.y;
                                vec2 rvec = theta * (1.0 + 0.22 * rSq + 0.24 * rSq * rSq); //+ 0.0 * rSq * rSq * rSq);
                                vec2 texCoord = (distortionScale*rvec+(1.0-distortionScale)*lensCenter + 1.0) / 2.0;

                                if (any(notEqual(clamp(texCoord, vec2(0.0, 0.0), vec2(1.0, 1.0)) - texCoord,
                                                       vec2(0.0, 0.0)))) {
                                    //if (leftEye == 0.0) gl_FragColor = vec4(1.0,1.0,0.0,1.0);
                                    //else gl_FragColor = vec4(1.0,0.0,0.0,1.0);
                                    discard;
                                }
                                else {
                                    vec3 col = texture2D(tex, texCoord).rgb;
                                    gl_FragColor = vec4(col, 1.0);
                                }
                                //gl_FragColor = texture2D(tex, fragTexCoord);
                            }
                        </shaderPart>
                    </composedShader>

                </appearance>
                <plane solid="false"></plane>
            </shape>
        </group>

        <group id='spatial-3d-right' DEF='right' render='false'>
            <shape>
                <appearance>
                    <renderedTexture id="rtRight" stereoMode="RIGHT_EYE" update='ALWAYS'
                                     dimensions='640 800 4' repeatS='false' repeatT='false'>
                        <!--<viewpoint USE='vp' containerField='viewpoint'></viewpoint>-->
                        <geoviewpoint USE='gvp' containerField='GeoViewpoint'></geoviewpoint>
                        <background USE='bgnd' containerField='background'></background>
                        <group USE='spatial-3d-scene' containerField="scene"></group>
                    </renderedTexture>
                    <composedShader>
                        <field name='tex' type='SFInt32' value='0'></field>
                        <field name='leftEye' type='SFFloat' value='0'></field>
                        <shaderPart type='VERTEX'>
                            attribute vec3 position;
                            attribute vec2 texcoord;

                            uniform mat4 modelViewProjectionMatrix;
                            varying vec2 fragTexCoord;

                            void main()
                            {
                                vec2 pos = sign(position.xy);
                                fragTexCoord = texcoord;

                                gl_Position = vec4((pos.x + 1.0) / 2.0, pos.y, 0.0, 1.0);
                            }
                        </shaderPart>
                        <shaderPart USE="frag" type='FRAGMENT'>
                        </shaderPart>
                    </composedShader>
                </appearance>
                <plane solid="false"></plane>
            </shape>
        </group>

                <!-- Elements for Leap Motion -->
                <transform id="handtrafo1" translation="3.8 1.00905 -5.97228">
                    <transform id="handtrafo" scale="0.0015 0.0015 0.0015" translation="0.1 -0.3 -0.5">
                        <transform id="hand">
                            <transform>
                                <transform>
                                    <transform>
                                        <transform scale="40 10 40" center="0 0 -2">
                                            <shape>
                                                <appearance>
                                                    <material diffuseColor="0.603 0.894 0.909"></material>
                                                </appearance>
                                                <box></box>
                                            </shape>
                                        </transform>
                                    </transform>
                                </transform>
                            </transform>

                            <transform id="bones"></transform>
                        </transform>
                    </transform>
                </transform>

                                            </Scene>
                                        </X3D>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- tab-content -->
                        </div><!-- accordion-inner -->
                    </div>
                </div><!-- accordian-group -->


                <div id="metadata-group" class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="metadata-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseMetadata">
                        Metadata:</a> <span id="metadata-count" style="color:black;"></span>
                        <span id="metadata-ajaxtime" style="color:black;"></span><span id="metadata-loading" style="color:black;"></span>
                        </h3>
                    </div>
                    <div id="collapseMetadata" class="accordion-body collapse in">
                        <div class="accordion-inner">
                                
                            <label class="checkbox">
                                <input type="checkbox" id="getactualcount" /> Get actual count
                            </label>

                            <ul id="resourceTabs" class="nav nav-tabs">
                                <li id="metadata-netcdf-li" class="active"><a href="#metadatanetcdf" data-toggle="tab">NetCDF sources</a></li>
                                <li id="metadata-qlp-li"><a href="#metadataquicklookplots" data-toggle="tab">Quick look plots</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" id="metadatanetcdf">
                                    <div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="metadataquicklookplots">
                                    <div>
                                    </div>
                                </div>
                            </div><!-- tab-content -->

                        </div><!-- accordion-inner -->
                    </div><!-- collapseMetadata -->
                </div><!-- accordian-group -->


                <div id="parameter-parameter-group" class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="parameter-parameter-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseParameterParameter">
                        Parameter-Parameter</a>
                        <button id="clear-pp-button" class="btn btn-mini disabled">Clear Selection</button>
                        </h3>
                    </div>

                    <div id="collapseParameterParameter" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul id="parameterParameterTabs" class="nav nav-tabs">
                                <li><a href="#pp2d" data-toggle="tab">2D</a></li>
                                <li><a href="#pp3d" data-toggle="tab">3D</a></li>
                                <li><a href="#ppsql" data-toggle="tab">sql</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane" id="pp2d">
                                    <div id="parameter-parameter-2dplot" style="overflow: auto; margin:0px auto;">
                                        <input type="checkbox" id="pp-linear-regression" class="pp-options" checked="checked"> Linear regression
                                        <input type="checkbox" id="pp-free-range" class="pp-options" > Free range
                                        <input type="checkbox" id="pp-sample-locations" class="pp-options" checked="checked"> Samples
                                        <img src="" />
                                        <pre class="prettyprint"></pre>
                                    </div>
                                </div>
                                <div class="tab-pane" id="pp3d">
                                    <div id="parameter-parameter-3dplot" style="height:500px;">
                                        <div class="row-fluid">
                                            <div class="span3">
                                                <em> Rotate: Left mouse<br>Translate: Ctrl + left mouse<br>Zoom: Alt + left mouse </em>
                                            </div>
                                            <div class="span2">
                                                <p><a id="pp-zoom-lc-button" class="btn btn-mini zoom-lc-button"><i class="icon-resize-full"></i> Zoom view</a></p>
                                                <p><a id="pp_x3d-reset-view" class="btn btn-mini" onClick="$('#pp_x3d')[0].runtime.resetView();return false;"><i class="icon-home"></i> Reset view</a></p>
                                            </div>
                                            <div class="span7">
                                                <img src="" />
                                            </div>
                                        </div>
                                        <div style="height:100%;">
                                        <!-- This X3D is hard coded with axis size of 10000 - scaling of data on the backend must use this same value -->
                                        <X3D id='pp_x3d' style="width:100%;height:100%;margin:0px auto;display:block;border:none;"> 
                                            <scene id='pp-3d-scene'>
                                                <Viewpoint id='x3d-viewpoint' position="-4907.13027 2788.82661 19473.28714" orientation="0.23484 -0.97195 0.01297 0.42414" centerofrotation='5000 5000 5000'></viewpoint>

                                                <Group DEF='Axis'>
                                                    <Transform translation='0 5000 0'>
                                                        <Shape>
                                                            <Appearance DEF='Grey'>
                                                                <Material diffuseColor='.1 .1 .1' emissiveColor='.2 .2 .2'></Material>
                                                            </Appearance>
                                                            <Cylinder height='10000' radius='20'></Cylinder>
                                                        </Shape>
                                                    </Transform>
                                                </Group>
                                                <Transform translation='0 10600 0' scale='300 300 300'>
                                                    <Shape>
                                                        <Text solid='false' string='Y'>
                                                            <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                        </Text>
                                                        <Appearance USE='Grey'></Appearance>
                                                    </Shape>
                                                </Transform>
                                                <Transform rotation='0 1 0 -0.78539816339'>
                                                    <Transform translation='-400 0 0' scale='300 300 300' rotation='0 0 -1 1.57079632679'>
                                                        <Shape>
                                                            <Text id="x3d-ymin" solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                    <Transform translation='-800 5000 0' scale='400 400 400' rotation='0 0 -1 1.57079632679'>
                                                        <Shape>
                                                            <Text id="x3d-yname" solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                    <Transform translation='-400 10000 0' scale='300 300 300' rotation='0 0 -1 1.57079632679'>
                                                        <Shape>
                                                            <Text id="x3d-ymax" solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                </Transform>

                                                <Transform rotation='0 0 1 -1.57079632679'>
                                                    <Group USE='Axis'></Group>
                                                </Transform>
                                                <Transform translation='10600 0 0' scale='300 300 300'>
                                                    <Shape>
                                                        <Text solid='false' string='X'>
                                                            <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                        </Text>
                                                        <Appearance USE='Grey'></Appearance>
                                                    </Shape>
                                                </Transform>
                                                <Transform rotation='1 0 0 0.78539816339'>
                                                    <Transform translation='0 -400 0' scale='300 300 300'>
                                                        <Shape>
                                                            <Text id='x3d-xmin' solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                    <Transform translation='5000 -800 0' scale='400 400 400'>
                                                        <Shape>
                                                            <Text id="x3d-xname" solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                    <Transform translation='10000 -400 0' scale='300 300 300'>
                                                        <Shape>
                                                            <Text id='x3d-xmax' solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                </Transform>

                                                <Transform rotation='1 0 0 1.57079632679'>
                                                    <Group USE='Axis'></Group>
                                                </Transform>
                                                <Transform translation='0 0 10600' scale='300 300 300'>
                                                    <Shape>
                                                        <Text solid='false' string='Z'>
                                                            <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                        </Text>
                                                        <Appearance USE='Grey'></Appearance>
                                                    </Shape>
                                                </Transform>
                                                <Transform rotation='0 0 1 -0.78539816339'>
                                                    <Transform translation='0 -400 0' scale='300 300 300' rotation='0 1 0 -1.57079632679'>
                                                        <Shape>
                                                            <Text id='x3d-zmin' solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                    <Transform translation='0 -800 5000' scale='400 400 400' rotation='0 1 0 -1.57079632679'>
                                                        <Shape>
                                                            <Text id='x3d-zname' solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                    <Transform translation='0 -400 10000' scale='300 300 300' rotation='0 1 0 -1.57079632679'>
                                                        <Shape>
                                                            <Text id='x3d-zmax' solid='false'>
                                                                <FontStyle size='2' justify='MIDDLE'></FontStyle>
                                                            </Text>
                                                            <Appearance USE='Grey'></Appearance>
                                                        </Shape>
                                                    </Transform>
                                                </Transform>
                                            </scene>
                                        </X3D>
                                        </div>
                                    </div><!-- parameter-parameter-3dplot -->
                                </div><!-- pp3d -->
                                <div class="tab-pane" id="ppsql">
                                    <div>
                                        <pre id="parameter-parameter-sql" style="font-size:xx-small;"></pre>
                                    </div>
                                </div>
                            </div><!-- tab-content -->
                        </div><!-- accordion-inner -->
                    </div><!-- collapseParameterParameter -->

                </div><!-- accordian-group -->


                <div id="sp-data-access-group" class="accordian-group" style="display:none">
                    <div class="accordian-heading">
                        <h3><a id="sp-data-access-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#sp-collapseDataAccess">
                        Sampled Parameter Data Access
                        </a></h3>
                    </div>

                    <div id="sp-collapseDataAccess" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul id="sp-dataaccessdownloadtabs" class="nav nav-tabs">
                                <li class="active"><a href="#table" data-toggle="tab">Table</a></li>
                                {% for format in formats %}
                                    {% if format.0 = 'sql' %}
                                        <li id="spsql" class="sql-tab"><a href="#sp-{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                    {% else %}
                                        <li><a href="#sp-{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                    {% endif %}
                                {% endfor %}            
                            </ul>

                            <div class="tab-content">
                                <div class="tab-pane active" id="table" style="overflow: auto">
                                    <span id="sample-instructions">Click on Sample locations in time-depth plot to get information here</span>
                                    <table id="sample-table" class="table table-striped table-bordered">
                                        <thead>
                                        </thead> 
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                                {% for format in formats %}
                                    {% if format.0 = 'kml' %}
                                <div class="tab-pane active" id="sp-{{format.0}}">
                                    {% else %}
                                <div class="tab-pane" id="sp-{{format.0}}">
                                    {% endif %} 
                                    <table>
                                        <tr>
                                            <th><a target="_blank" id="sp-{{format.0}}-link" href="" title="Click to view"><img src="{{STATIC_URL}}images/{{format.0}}-icon.png" alt="sp-{{format.0}}"/></a></th>
                                            <th style="vertical-align:text-top;"><span>&nbsp;{{format.1}}</span></th>
                                        </tr>
                                    </table>
                                    {% if format.0 = 'kml' %}
                                        <div style="text-align: center;">
                                        <span id="sp-kml-parameter"></span>
                                        <form style="text-align: center;" class="form-inline">
                                            <input id="sp-cmin" type="text" class="stoqs-color-limit-input" style="text-align:right;" title="Initial min value is 2.5 percentile" />
                                            <img style="vertical-align:middle;" src="{{STATIC_URL}}images/jetplus_bar.png" title="jetplus.pal" alt="jetplus" />
                                            <input id="sp-cmax" type="text" class="stoqs-color-limit-input" title="Initial max value is 97.5 percentile" />
                                        </form>
                                        </div>
                                        <pre id="sp-{{format.0}}-field"></pre>
                                    {% else %}
                                        {% if format.0 = 'sql' %}
                                            <pre id="sp-{{format.0}}-field" style="font-size:xx-small;"></pre>
                                        {% else %}
                                            <pre id="sp-{{format.0}}-field"></pre>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                {% endfor %}            
                            </div>
                        </div>
                    </div>

                </div><!-- accordian-group -->


                <div id="mp-data-access-group" class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="mp-data-access-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#mp-collapseDataAccess">
                        Measured Parameter Data Access
                        </a> </h3>
                    </div>
                    <div id="mp-collapseDataAccess" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul id="mp-dataaccessdownloadtabs" class="nav nav-tabs">
                                {% for format in formats %}
                                    {% if format.0 = 'kml' %}
                                        <li class="active"><a href="#mp-{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                    {% else %}
                                        {% if format.0 = 'sql' %}
                                            <li id="mpsql" class="sql-tab"><a href="#mp-{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                        {% else %}
                                            <li><a href="#mp-{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}            
                            </ul>
                            <div class="tab-content">
                                {% for format in formats %}
                                    {% if format.0 = 'kml' %}
                                        <div class="tab-pane active" id="mp-{{format.0}}">
                                    {% else %}
                                        <div class="tab-pane" id="mp-{{format.0}}">
                                    {% endif %} 
                                    <table>
                                        <tr>
                                            <th><a target="_blank" id="mp-{{format.0}}-link" href="" title="Click to view"><img src="{{STATIC_URL}}images/{{format.0}}-icon.png" alt="mp-{{format.0}}"/></a></th>
                                            <th style="vertical-align:text-top;"><span>&nbsp;{{format.1}}</span></th>
                                        </tr>
                                    </table>
                                    {% if format.0 = 'kml' %}
                                        <div style="text-align: center;">
                                        <span id="mp-kml-parameter"></span>
                                        <form style="text-align: center;" class="form-inline">
                                            <input id="mp-cmin" type="text" class="stoqs-color-limit-input" style="text-align:right;" title="Initial min value is 2.5 percentile" />
                                            <img style="vertical-align:middle;" src="{{STATIC_URL}}images/jetplus_bar.png" title="jetplus.pal" alt="jetplus" />
                                            <input id="mp-cmax" type="text" class="stoqs-color-limit-input" title="Initial max value is 97.5 percentile" />
                                        </form>
                                        </div>
                                        <pre id="mp-{{format.0}}-field"></pre>
                                    {% else %}
                                        {% if format.0 = 'sql' %}
                                            <pre id="mp-{{format.0}}-field" style="font-size:xx-small;"></pre>
                                        {% else %}
                                            <pre id="mp-{{format.0}}-field"></pre>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                {% endfor %}            
                            </div>
                            
                        </div>
                    </div>
                </div><!-- accordian-group -->

            </div><!-- accordian well -->

        </div><!-- span6 -->
        
        <div id="right-column" class="span6 stoqs-zoom-width">
            <div class="accordion well" id="accordion2" style="border:none;">

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="temporal-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTemporal">
                        Temporal</a>
                        <button id="zoomed-button" class="btn btn-mini disabled">Clear Selection</button>
                        </h3>
                    </div>
                    <div id="collapseTemporal" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul id="temporalTabs" class="nav nav-tabs temporal-tab">
                                <li class="active" id="temporal-depth-li"><a href="#temporal-depth" data-toggle="tab" id="temporal-depth-label">Depth</a></li>
                                <li id="temporal-parameter-li" style="display:none" title="Hint: Plot Measured Parameter in Depth tab first"><a href="#temporal-parameter" data-toggle="tab">Parameter</a></li>
                            </ul>

                            <div class="tab-content">
                                <div class="tab-pane active" id="temporal-depth">
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <em id="time-depth-instr">Click and drag to zoom</em>
                                            <a id="td-zoom-rc-button" class="btn-mini zoom-rc-button"><i class="icon-resize-full" title="Full Screen"></i></a>
                                        </div>
                                        <div id="temporalparameterstrideinfo" class="span6" style="text-align:right;"></div>
                                    </div>
                                    <div id="time-depth-plot" style="height:400px" class="disabled row-fluid">
                                        <div id="time-depth-flot" style="width:100%;height:90%;" class="disabled"></div>
                                        <div class="row-fluid">
                                            <div class="span5" id="contour-scatter-buttons" style="display:none;">
                                                <span id="temporalparameterplotinfo">&nbsp;</span>
                                                <br>
                                                <input type="radio" name="showdataas" value="contour" style="margin-left:1px;" /> contour
                                                <input type="radio" name="showdataas" value="scatter" checked /> scatter
                                            </div>
                                            <div class="span7"><span style="float:right;">
                                                <a id="colormap" class="accordion-toggle" data-toggle="collapse" href="#collapseColormap"><img id="sectioncolorbarimg" src="" /></a>
                                            </span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="temporal-parameter">
                                    <div class="row-fluid">
                                        <div class="span6">
                                            <em id="time-parameter-instr">Click and drag to zoom</em>
                                            <a id="tp-zoom-rc-button" class="btn-mini zoom-rc-button"><i class="icon-resize-full" title="Full Screen"></i></a>
                                        </div>
                                        <div id="stride-info" class="span6"></div>
                                    </div>
                                    <div class="row-fluid" id="time-parameter-plot" style="height:400px" class="disabled row-fluid">
                                        <div id="time-parameter-flot" style="width:100%;height:90%;" class="disabled"></div>
                                    </div>
                                </div>
                            </div><!-- tab-content -->


                        </div><!-- accordion-inner -->
                    </div>
                </div><!-- accordian-group -->


                <div class="accordian-group" style="display:none;">
                    <!--<div class="accordian-group">-->
                    <div class="accordian-heading">
                        <h3><a id="colormap-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseColormap">
                         Colormaps</a>
                        </h3>
                    </div>
                    <div id="collapseColormap" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul class="nav nav-tabs">
                                {% for category in colormaps %}
                                    {% if category.0 == "Uniform" %}
                                        <li class="active"><a href="#{{category.0}}" data-toggle="tab">{{category.0}}</a></li>
                                    {% else %}
                                        <li><a href="#{{category.0}}" data-toggle="tab">{{category.0}}</a></li>
                                    {% endif %}
                                {% endfor %}            
                            </ul>
                            <div class="tab-content">
                                {% for category in colormaps %}
                                    {% if category.0 == "Uniform" %}
                                        <div class="tab-pane active" id="{{category.0}}">
                                    {% else %}
                                        <div class="tab-pane" id="{{category.0}}">
                                    {% endif %}
                                    <fieldset>
                                    <table class="table table-condensed">
                                    {% for cm in category.1 %}
                                        <tr style="white-space:nowrap;">
                                            <td style="white-space:nowrap;border-top:0px;">
                                                <input type="radio" name="colormap_choice" value="{{cm}}" id="{{cm}}" style="float:left;clear:none;display:block;margin-right:5px;"/>
                                                <label for="{{cm}}">{{cm}}</label>
                                            </td>
                                            <td style="border-top:0px;"><label for="{{cm}}"><img src="{{STATIC_URL}}images/colormaps/{{cm}}.png"></label></td>
                                        </label></tr>
                                    {% endfor %}            
                                    </table>
                                    </fieldset>
                                    </div>
                                {% endfor %}            
                            </div>
                        </div>
                    </div>
                </div>




                <div class="accordian-group" style="display:none">
                    <div class="accordian-heading">
                        <h3><a id="sampledparameters-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseSampledParameter">
                        Sampled Parameters</a>
                        <button id="clear-sampledparameter-button" class="btn btn-mini disabled">Clear Selection</button>
                        </h3>
                    </div>
                    <div id="collapseSampledParameter" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <input type="checkbox" id="show-parameter-parameter-sp-checkbox" /> Show Parameter-Parameter
                            <input type="checkbox" id="show-coordinates-sp-checkbox" /> Show coordinates
                            <input type="checkbox" id="show-filtered-sp-checkbox" /> Filtered out parameters
                            <input type="checkbox" id="show-sp-standardnames" /> Standard Names
                            <fieldset>
                            <table id="sampledparameter-table" class="table table-condensed">
                                <thead>
                                    <tr>
                                        <th colspan="4" style="text-align:center; text-decoration:underline; font-style:italic;display:none;" class="pp-header">Parameter-Parameter</th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic"></th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic"></th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic">Filter &amp; Select for data access</th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic"></th>
                                    </tr>
                                    <tr>
                                        <th style="text-align:center;display:none;" class="pp-header">X</th>
                                        <th style="text-align:center;display:none;" class="pp-header">Y</th>
                                        <th style="text-align:center;display:none;" class="pp-header">Z</th>
                                        <th style="text-align:center;display:none;" class="pp-header">C</th>
                                        <th style="text-align:center;">Plot Data</th>
                                        <th style="text-align:center;"></th>
                                        <th style="text-align:center;"></th>
                                        <th style="text-align:center;"></th>
                                    </tr>
                                </thead>                             
                                <tbody>
                                    <tr>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;">
                                            <input type="radio" name="parameters_plot" value="" class="parameter-plot-radio" />
                                            <input type="checkbox" name="sp_all_parameters_plot_cb" value="" class="parameter-plot-checkbox checkall_parametertime" style="display:none;"/>
                                        </td>
                                        <td colspan="3" class="all-plot-instruction">Clear Selection</td>
                                    </tr>
                                    <tr class="sp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Longitude</td>
                                    </tr>
                                    <tr class="sp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Latitude</td>
                                    </tr>
                                    <tr class="sp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Depth</td>
                                    </tr>
                                    <tr class="sp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Time</td>
                                    </tr>
                                </tbody>
                            </table>
                            </fieldset>
                        </div>
                    </div>
                </div><!-- accordian-group -->


                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="measuredparameters-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseMeasuredParameter">
                        Measured Parameters</a>
                        <button id="clear-measuredparameter-button" class="btn btn-mini disabled">Clear Selection</button>
                        </h3>
                    </div>
                    <div id="collapseMeasuredParameter" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <input type="checkbox" id="show-parameter-parameter-mp-checkbox" /> Show Parameter-Parameter
                            <input type="checkbox" id="show-coordinates-mp-checkbox" /> Show coordinates
                            <input type="checkbox" id="show-filtered-mp-checkbox" /> Filtered out parameters
                            <input type="checkbox" id="show-standardnames-mp-checkbox" /> Standard Names
                            <fieldset>
                            <table id="measuredparameter-table" class="table table-condensed">
                                <thead>
                                    <tr>
                                        <th colspan="4" style="text-align:center; text-decoration:underline; font-style:italic;display:none;" class="pp-header">Parameter-Parameter</th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic"></th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic"></th>
                                        <th colspan="1" style="text-align:center; text-decoration: underline; font-style:italic">Filter &amp; Select for data access</th>
                                        <th colspan="1" style="text-align:center; text-decoration:underline; font-style:italic"></th>
                                    </tr>
                                    <tr>
                                        <th style="text-align:center;display:none;" class="pp-header">X</th>
                                        <th style="text-align:center;display:none;" class="pp-header">Y</th>
                                        <th style="text-align:center;display:none;" class="pp-header">Z</th>
                                        <th style="text-align:center;display:none;" class="pp-header">C</th>
                                        <th style="text-align:center;">Plot Data</th>
                                        <th style="text-align:center;"></th>
                                        <th style="text-align:center;"></th>
                                        <th style="text-align:center;"></th>
                                    </tr>
                                </thead>                             
                                <tbody>
                                    <tr>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="" class="parameter-radio" /></td>
                                        <td style="text-align:center;">
                                            <input type="radio" name="parameters_plot" value="" class="parameter-plot-radio" />
                                            <input type="checkbox" name="mp_all_parameters_plot_cb" value="" class="parameter-plot-checkbox checkall_parametertime" style="display:none;"/>
                                        </td>
                                        <td colspan="3" class="all-plot-instruction">Clear Selection</td>
                                    </tr>
                                    <tr class="mp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="longitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Longitude</td>
                                    </tr>
                                    <tr class="mp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="latitude" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Latitude</td>
                                    </tr>
                                    <tr class="mp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="depth" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Depth</td>
                                    </tr>
                                    <tr class="mp-pp-coordinates" style="display:none;">
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_x" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_y" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_z" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;display:none;"><input type="radio" name="parameters_c" value="time" class="parameter-radio" /></td>
                                        <td style="text-align:center;">&nbsp;</td>
                                        <td colspan="3">Time</td>
                                    </tr>
                                </tbody>
                            </table>
                            </fieldset>
                        </div>
                    </div>
                </div><!-- accordian-group -->

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="parameter-values-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseParameterValues">
                        Parameter Values</a>
                        <button id="resetparametervaluesselections" class="btn btn-mini disabled">Clear Selection</button> 
                        </h3>
                        <input type="hidden" id="parametervalues-data" name="parametervalues-data" />
                    </div>
                    <div id="collapseParameterValues" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <div id="histogram-instruction">Show distribution of parameter values</div>
                            <div class="span6">
                                Histogram display: 
                                <input type="checkbox" class="pv-histogram-checkbox" id="showstandardnameparametervalues" /> Standard Names
                                <input type="checkbox" class="pv-histogram-checkbox" id="showallparametervalues" /> All Parameters
                            </div>
                            <table id="parameter-value-table" class="table table-condensed">
                            </table>
                        </div>
                    </div>
                </div><!-- accordian-group -->

                <div id="attributes-group" class="accordian-group" style="display:none;">
                    <div class="accordian-heading">
                        <h3><a id="attributes-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseAttributes">
                        Attributes</a>
                        <button id="clear-attributes-button" class="btn btn-mini disabled">Clear Selection</button>
                        </h3>
                    </div>

                    <div id="collapseAttributes" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul id=attributesTabs" class="nav nav-tabs">
                                <li class="active"><a href="#amp" data-toggle="tab">Measurement</a></li>
                                <li><a href="#asp" data-toggle="tab">Sample</a></li>
                                <li><a href="#ac" data-toggle="tab">Campaign</a></li>
                                <li><a href="#apl" data-toggle="tab">Platform</a></li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" id="amp">
                                    <div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="asp">
                                    <div>
                                        <div class="row-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="platforms-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapsePlatforms">
                        Platforms</a>
                        <button id="clear-platforms-button" class="btn btn-mini disabled">Clear Selection</button>
                        </h3>
                    </div>
                    <div id="collapsePlatforms" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <table class="table table-condensed" style="margin-bottom:0px;">
                                <thead>
                                    <tr>
                                        <th style="width:15%;border-top-width:0;"></th>
                                        <th style="text-align:center;width:5%;border-top-width:0;display:none;" class="platform-plot-instruction">Space</th>
                                        <th style="text-align:center;width:5%;border-top-width:0;display:none;" class="platform-plot-instruction">Time</th>
                                        <th style="width:75%;border-top-width:0;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width:15%;border-top-width:0;"></td>
                                        <td style="text-align:center;width:5%;border-top-width:0;">
                                            <input type="checkbox" name="platforms_plot_map" value="" class="platform-plot-map-checkbox" style="display:none;" />
                                        </td>
                                        <td style="text-align:center;width:5%;border-top-width:0;">
                                            <input type="radio" name="platforms_plot_section" value="" class="platform-plot-section-radio checkall_parametertime" style="display:none;"/>
                                        </td>
                                        <td style="width:75%;border-top-width:0;display:none;" class="all-platform-plot-instruction">Check all / Clear</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- accordian-group -->

            </div><!-- accordian well -->

        </div><!-- span -->

    </div><!-- row-fluid -->

  </div> <!-- container -->

    <!-- The javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.dateFormat-1.0.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.selection.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.resize.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.image.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.navigate.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.axislabels.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.flot.crosshair.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.cookie.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.debounce.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}jquery/js/jquery.color-2.1.2.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-transition.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-alert.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-modal.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-dropdown.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-scrollspy.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-tab.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-button.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-collapse.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-carousel.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}bootstrap/js/bootstrap-typeahead.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}OpenLayers-2.11/OpenLayers.js"></script> 
    <script type="text/javascript" src="{{STATIC_URL}}OpenLayers-2.11/LoadingPanel.js"></script> 
    <script type="text/javascript" src="{{STATIC_URL}}permalink/json2.js"></script> 
    <script type="text/javascript" src="{{STATIC_URL}}permalink/purl.js"></script> 
    <script type="text/javascript" src="{{STATIC_URL}}permalink/lz-string.js"></script> 
    <script type="text/javascript" src="{{STATIC_URL}}x3dom-1.7.1/x3dom-full.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}x3dom/js/components/GeoOriginTransform.js"></script>
    <!--<script type="text/javascript" src="http://www.x3dom.org/x3dom/dist/x3dom-full.js"></script>-->
    <script type="text/javascript" src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>

    <script type="text/javascript"><!--
    
    var summaryQuery='{{site_uri}}{% url 'stoqs:stoqs-query-summary' dbAlias=request.META.dbAlias %}';
    var mapQuery='{{site_uri}}{% url 'stoqs:stoqs-query-map' dbAlias=request.META.dbAlias %}';
    var params={}
    var initData;
    var lcZoomed = false;
    var rcZoomed = false;
    var rifted = false;
    var request=''
    var map = null; 
    var parametervalues={};     
    var permalink_bypass=false;
    var client_side_permalink = true;
    var polyLayer = new OpenLayers.Layer.Vector( " Selection polygon", {visibility: false} );
    var timedepthplot;
    var timeparameterplot;
    var zoom_simpledepthtime_stack = [];
    var zoom_parametertime_stack = [];
    var simpledepthtime_options;
    var simpledepthtime_options_zoom;
    var parametertime_options;
    var parametertime_options_zoom;
    var sp_cmincmax = ''
    var mp_cmincmax = ''
    var hasTrajectory;
    var hasTimeSeries;
    var hasTimeSeriesProfile;
    var hasTrajectoryProfile;
    var clearingTemporalFlag = false;
    var PIXELS_WIDE = 800;                              // Approximate width of $("#time-depth-flot")
    var timeAxis;
    var sliderLimits;
    var runtime = null;
    var rtLeft, rtRight;
    var lastW, lastH;

    var vrHMD = null, vrSensor = null;
    var pyr = new x3dom.fields.SFVec3f(0, 0, 0);        // For the Leap Motion

    // Callback from X3DOM TimeSensor added to scene with 'showplatforms' checkbox 
    function setSlider(eventObject) {
        if(eventObject.type != "outputchange" || eventObject.fieldName != "fraction_changed")
            return;
        var fraction = eventObject.value;
        $('#spatial-3d-x3d-slider').val(fraction);
        updateCrosshairs(fraction, timeAxis, sliderLimits);
    }

    function setScale(event) {
        var viewpoint = $('#spatial-3d-x3d')[0].runtime.viewpoint();
        // Proxy location of platform - set centerOfRotation for the scene
        var pl = viewpoint._vf.centerOfRotation;
        if ( $.isEmptyObject(event.position) ) {
            var vp = viewpoint._vf.position;
        }
        else {
            var vp = event.position;
        }

        // Compute distance from viewpoint and set scales of models
        // The f factor properly adjusts models to a suitable proportion of the screen
        var f = 1 / 75.0;
        var d = Math.sqrt(Math.pow((vp.x - pl.x), 2) + Math.pow((vp.y - pl.y), 2) + Math.pow((vp.z - pl.z), 2));
        var sc = f * d;
        var scale = sc + ',' + sc + ',' + sc;

        // Set scale attribute and distance text for all platforms in the scene
        $.each($('body').data()['platformAnimation'].concat( 
                $.map($('body').data()['platformModels'], function(v, k) {return k})), function(index, plat) {
            $('#' + plat + '_SCALE').attr('scale', scale);
            // Axes are 10m long in the axes_enu.x3d inlined file
            up_text = Math.round(sc  * 10 / $('body').data()['ve'])  + ' m';
            e_text = Math.round(sc * 10) + ' m';
            $('#' + plat + '_axesENU__upString').attr('string', up_text);
            $('#' + plat + '_axesENU__eString').attr('string', e_text);
        });
    }

    function updateCrosshairs(fraction, timeAxis, limits) {
        var index = Math.floor(limits[0] + fraction * (limits[1] - limits[0]))
        timedepthplot.lockCrosshair({x: timeAxis[index], y:0});
        if ( ! $.isEmptyObject(timeparameterplot) ) {
            timeparameterplot.lockCrosshair({x: timeAxis[index], y:0});
        }
    }

    function downloadsFinished(event) {
        // Trigger the viewpoint parameters setting, probably not needed
        // to be in this event handler, but it's nice feedback.
        if ($('body').data()['init']) {
            $('input[name=terrain_view][value="' + $('body').data()['terrain_view'] + '"]').prop('checked', true).trigger("click");
        }
    }

    // Called with an element that was selectable, should make that element non-selectable.
    function disableButton(element) {
        if (! $(element).is('.disabled')) {
            $(element).removeClass('btn-primary');      // Unselect if it's selected.
            $(element).addClass('disabled');            // Add the disabled class to it.
            $(element).attr('title', ' ').tooltip('fixTitle').tooltip('show');     // Remove tooltip
        }
    }
    function disableXYZColorPlot(element) {
        $(element).attr('disabled',true);    // disable the X, Y, Z, Color radio buttons in the row
    }

    function SelectText(element) {
        var doc = document
            , text = doc.getElementById(element)
            , range, selection
        ;    
        if (doc.body.createTextRange) {
            range = document.body.createTextRange();
            range.moveToElementText(text);
            range.select();
        } else if (window.getSelection) {
            selection = window.getSelection();        
            range = document.createRange();
            range.selectNodeContents(text);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }

    function disableParameterRow(group, element) {
        if (group == 'sp') {
            $(element).addClass('disabled');
            if ( $('#show-filtered-sp-checkbox').is(':checked') ) {
                $(element).show();
            }
            else {
                $(element).hide();
            }
        }
        else if (group == 'mp') {
            $(element).addClass('disabled');
            if ( $('#show-filtered-mp-checkbox').is(':checked') ) {
                $(element).show();
            }
            else {
                $(element).hide();
            }
        }
    }
    
    // Called with an element that was selectable, should make that element selectable.
    function enableButton(element) {
        if ($(element).is('.disabled')) {
            $(element).removeClass('disabled');
            //$(element).attr('title', 'Click to Select').tooltip('fixTitle').tooltip('hide');     // Add generic tooltip
        }
    }
    function enableXYZColorPlot(element) {
        $(element).removeAttr('disabled');    // enable the X, Y, Z, Color radio buttons in the row
    }

    function enableParameterRow(element) {
        $(element).removeClass('disabled');
        $(element).show();
    }

    function addPlatformSymbols(e, p) {
        var symbols = '';
        if ( ! $.isEmptyObject($('body').data().parameterplatforms[p]) ) {
            $.each($('body').data().parameterplatforms[p], function(index, plat) {
                if ($('body').data().platformFeatureTypes[plat].toLowerCase() === 'trajectory') {
                    symbols += '<span style="color:#' + $('body').data().platformColors[plat] + '">|</span>';
                }
                else {
                    symbols += '<span style="color:#' + $('body').data().platformColors[plat] + '">*</span>';
                }
            });
            e.html(symbols);
        }
    }

    function updateKMLcmincmax(group) {
        if ($('#' + group + '-cmin').val() && $('#' + group + '-cmax').val()) {
            cmincmax = 'cmin=' + $('#' + group + '-cmin').val() + '&cmax=' + $('#' + group + '-cmax').val();
        }
        if ($('body').data()[group + '_kmlurl'] && typeof cmincmax != 'undefined') {
            $('#' + group + '-kml-field').text($('body').data()[group + '_kmlurl'] + cmincmax);
            $('#' + group + '-kml-link').attr('href', $('body').data()[group + '_kmlurl'] + cmincmax);
        }
        else {
            $('#' + group + '-kml-field').text('');
            $('#' + group + '-kml-link').removeAttr('href');
        }
    }

    function update_sensortrackskml() {
        if ( $('#showsensortracks').is(':checked') && $('input:radio[name=parameters_plot]').is(':checked') ) {
            if ( $('input:radio[name=parameters_plot]:checked').val() ) {
                // Generate KML url for the parameters_plot radio button selection - this is separate from the filtered selection for Measurement Data Access
                var base_url_mp = '{{site_uri}}{% url 'stoqs:show-measuredparmeter' dbAlias=request.META.dbAlias fmt='.kml'%}';
                var base_url_sp = '{{site_uri}}{% url 'stoqs:show-sampledparmeter' dbAlias=request.META.dbAlias fmt='.kml'%}';
                var param=($.param($.map(params, function(v, k) { return ($.type(v) == "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })))
                if (param != '') {
                    param = '?' + param;
                } 

                // Override any parameter__name or parameter__standard_name with parameter__id from radio button selection
                var orig_kmlurl;
                if ( $.inArray($('input:radio[name=parameters_plot]:checked').val(), $('#measuredparameters-anchor').data()['ids']) != -1 ) {
                    mp_param = getMPparms('mp', params);
                    orig_kmlurl = base_url_mp + mp_param + '&parameter__id=' + $('input:radio[name=parameters_plot]:checked').val() + '&';
                }
                else if ( $.inArray($('input:radio[name=parameters_plot]:checked').val(), $('#sampledparameters-anchor').data()['ids']) != -1 ) {
                    mp_param = getMPparms('sp', params);
                    orig_kmlurl = base_url_sp + mp_param + '&parameter__id=' + $('input:radio[name=parameters_plot]:checked').val() + '&';
                }

                // strideVal is adjusted based on the current count of measured/sampled_parameters so as to prevent long waits for the KML transfer
                $.get( orig_kmlurl.replace('.kml', '.count')).
                done( function(count, status) {
                    // Ensure that no more that about 300 points are plotted - stride as necessary
                    if (count == 0) {
                        alert('Sensortracks: No data returned from selection');
                    }
                    else {
                        strideVal = Math.floor(count / 300);
                        if (strideVal < 1) {
                            strideVal = 1;
                        }
                        $('#showsensortrackstext').text($('#temporalparameterplotinfo').data()['info'] + ' (every ' + getValueOrdinal(strideVal) + ' point)');
                        // Set colorbar as an attribution - must get the url to the .png from the sensor tracks being turned on
                        // See: http://stackoverflow.com/questions/5539633/adding-a-absolutely-positioned-div-to-the-bottom-of-an-openlayers-map/5568762#5568762
                        //sensortrackskml.attribution = '<img src="{{MEDIA_URL}}sections/' + data['parameterplatformdatavaluepng'][1] + '" />';
                        // Dynamically set url for sensor tracks display in openlayers
                        //sensortrackskml.loaded = false;
                        strided_kmlurl = orig_kmlurl.replace('.kml', '.kmln') + '&cmin=' + $('body').data()['parameterminmax']['plot'][1] + 
                                                                           '&cmax=' + $('body').data()['parameterminmax']['plot'][2] + '&stride=' + strideVal;
                        sensortrackskml.refresh({url: strided_kmlurl});
                    }
                }).
                fail( function (data, response, jqXHR) {
                    if (jqXHR.toUpperCase() == 'INTERNAL SERVER ERROR') {
                        $('#showsensortracks').attr({checked: false});
                        sensortrackskml.removeAllFeatures();
                    }
                    else {
                        alert('Could not get count of sensor track data: ' + jqXHR);
                    }
                });
            }
            else {
                sensortrackskml.removeAllFeatures();
            }
        }
        else {
            sensortrackskml.removeAllFeatures();
        }
    }

    function addStationaryPlatformModels() {
        // For platforms in the selection look in $('body').data()['platformModels'] for x3dModels and add to the scene
        x3d = ''
        $.each($('body').data()['platformModels'], function(plat, m) {
            x3d += '<GeoLocation geoCoords="' + m[1] + ',' + m[2] + ',' + m[3] + '">';
            x3d += $('body').data()['geoorigin_use'];
            if (m[0].match("^http")) {
                x3d += '<Transform id="' + plat + '_SCALE" def="' + plat + '_SCALE" scale="2000,2000,2000"><Inline url="' + m[0] + '"></Inline></Transform>';
            }
            else {
                x3d += '<Transform id="' + plat + '_SCALE" def="' + plat + '_SCALE" scale="200,200,200"><Inline url="{{STATIC_URL}}' + m[0] + '"></Inline></Transform>';
            }
            x3d += '</GeoLocation>';
        });
        $('#platform-models').html(x3d);
    }

    function getMPparms(group, params) {
        // Construct querystring for measuredparameter or sampledparameter REST request, mapping params to Django queries for the MP & SP tables
        // Good for .json, .csv, .tsv, .html responses
        var group_name;
        if ( group == 'mp' ) {
            group_name1 = 'measured';
            group_name2 = 'measurement';
        }
        else if ( group == 'sp' ) {
            group_name1 = 'sampled';
            group_name2 = 'sample';
        }
        
        var mp_param = '?';
        if (typeof params[group_name1 + 'parametersgroup'] != 'undefined') {
            if ( group == 'mp' ) {
                for (var i=0; i<params[group_name1 + 'parametersgroup'].length; i++) {
                    mp_param = mp_param + 'parameter__name=' + params[group_name1 + 'parametersgroup'][i] + '&';
                }
            }
            else if ( group == 'sp' ) {
                for (var i=0; i<params[group_name1 + 'parametersgroup'].length; i++) {
                    mp_param = mp_param + 'parameter__id=' + params[group_name1 + 'parametersgroup'][i] + '&';
                }
            }
        }
        if (typeof params['parameterstandardname'] != 'undefined') {
            for (var i=0; i<params['parameterstandardname'].length; i++) {
                mp_param = mp_param + 'parameter__standard_name=' + params['parameterstandardname'][i] + '&';
            }
        }
        if (typeof params['platforms'] != 'undefined') {
            for (var i=0; i<params['platforms'].length; i++) {
                mp_param = mp_param + group_name2 + '__instantpoint__activity__platform__name=' + params['platforms'][i] + '&';
            }
        }
        if (typeof params['start_time'] != 'undefined') {
            mp_param = mp_param + group_name2 + '__instantpoint__timevalue__gt=' + params['start_time'] + '&';
        }
        if (typeof params['end_time'] != 'undefined') {
            mp_param = mp_param + group_name2 + '__instantpoint__timevalue__lt=' + params['end_time'] + '&';
        }
        if (typeof params['min_depth'] != 'undefined') {
            mp_param = mp_param + group_name2 + '__depth__gte=' + params['min_depth'] + '&';
        }
        if (typeof params['max_depth'] != 'undefined') {
            mp_param = mp_param + group_name2 + '__depth__lte=' + params['max_depth'] + '&';
        }

        if (parametervalues) {
            for (var parameter in parametervalues) {
                var min = parametervalues[parameter]['xmin'];
                var max = parametervalues[parameter]['xmax'];
                if (typeof min != 'undefined' && typeof max != 'undefined') {
                    mp_param = mp_param + parameter + "_MIN=" + min.toPrecision(4) + "&";
                    mp_param = mp_param + parameter + "_MAX=" + max.toPrecision(4) + "&";
                }
            };
        }

        if ( ! $.isEmptyObject(params['mplabels']) ) {
            for (var i=0; i<params['mplabels'].length; i++) {
                mp_param = mp_param + 'mplabels=' + params['mplabels'][i] + '&';
            }
        }

        return mp_param
    }
    
    // Set the URL fields and buttons to use the current queried URL, group is either 'mp' or 'sp'
    function setDataAccess(group, data) {
        var group_name;
        var base_url;
        if ( group == 'mp' ) {
            group_name = 'measured';
            base_url = '{{site_uri}}{% url 'stoqs:show-measuredparmeter' dbAlias=request.META.dbAlias fmt='.'%}';
        }
        else if ( group == 'sp' ) {
            group_name = 'sampled';
            base_url = '{{site_uri}}{% url 'stoqs:show-sampledparmeter' dbAlias=request.META.dbAlias fmt='.'%}';
        }
        var query_url = '{{site_uri}}{% url 'stoqs:stoqs-query-ui' dbAlias=request.META.dbAlias %}';
        var param=($.param($.map(params, function(v, k) { return ($.type(v) == "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })))
        if (param != '') {
            param = '?' + param;
        } 
        mp_param = getMPparms(group, params);

        var formats=[{% for format in formats %}'{{format.0}}'{% if not forloop.last %},{% endif %}{%endfor%}]
        // Iterate over the formats and update the fields/buttons to use the new URL's to get the data.
        $.each(formats, function (index, value) {
            var url = query_url + value + param;
            if (value == 'sql') {
                $('#'+group+'-'+value+'-field').text(data[group+'sql']);
            }
            else if (value == 'kml' && ! $.isEmptyObject(data['parameterminmax'])) {
                var url = base_url + 'kml' + mp_param;
                $('#'+group+'-kml-parameter').html('Select a single ' + group_name + ' parameter <i>for data access</i> to view your selection in Google Earth');
                $('#'+group+'-kml-parameter').css( { 'color': 'red' } );
                if (typeof params[group_name + 'parametersgroup'] != 'undefined') {
                    if (params[group_name + 'parametersgroup'].length == 1) {
                        // Use button text of id for parameter name - expects only one such element in the DOM
                        $('#'+group+'-kml-parameter').text($('#' + params[group_name + 'parametersgroup'][0]).text());
                        $('#'+group+'-kml-parameter').css( { 'color': 'black' } );
                        $('#'+group+'-cmin').val(data['parameterminmax']['dataaccess'][1]);
                        $('#'+group+'-cmax').val(data['parameterminmax']['dataaccess'][2]);
                        $('body').data()[group + '_kmlurl'] = url;
                        updateKMLcmincmax(group);
                    }
                    else if (params['parameterstandardname'].length == 1) {
                        $('#'+group+'-kml-parameter').text(params['parameterstandardname'][0]);
                        $('#'+group+'-kml-parameter').css( { 'color': 'black' } );
                        $('#'+group+'-cmin').val(data['parameterminmax']['dataaccess'][1]);
                        $('#'+group+'-cmax').val(data['parameterminmax']['dataaccess'][2]);
                        $('body').data()[group + '_kmlurl'] = url;
                        updateKMLcmincmax(group);
                    }
                    else {
                        $('#'+group+'-cmin').val('');
                        $('#'+group+'-cmax').val('');
                        $('body').data()[group + '_kmlurl'] = '';
                        updateKMLcmincmax(group);
                    }
                }
            }
            else if (value == 'stoqstoolbox') {
                // Required parameters for stoqs_down as of stoqstoolbox release noted in the Matlab comment below
                var req_params = ['campaign', 'start_time', 'end_time', 'min_depth', 'max_depth', 'platforms', group_name + 'parametersgroup', 'parameterstandardname'];
                var hasParametervalues = false;
                var st_text_comm = "% Copy and paste into a Matlab session where stoqstoolbox build 2013-01-08 or\n";
                st_text_comm = st_text_comm + "% later has been installed from https://code.google.com/p/stoqs/downloads\n\n";
                st_text = st_text_comm;
                st_text = st_text + "campaign = '{{site_uri}}{% url 'stoqs:base-campaign' dbAlias=request.META.dbAlias %}';\n";
                $.each(req_params, function(k, v) {
                    if (typeof params[v] != "undefined") {
                        if (v.match(/depth$/)) {
                            // Numeric value, don't quote
                            st_text = st_text + v + " = " + params[v] + ";\n";
                        }
                        else {
                            st_text = st_text + v + " = '" + params[v] + "';\n";
                        }
                    }
                    else if (v != 'campaign') {
                        st_text = st_text + v + " = '';\n";
                    }
                });

                if (parametervalues) {
                    for (var parameter in parametervalues) {
                        var min = parametervalues[parameter]['xmin'];
                        var max = parametervalues[parameter]['xmax'];
                        if (typeof min != 'undefined' && typeof max != 'undefined') {
                            st_text = st_text + parameter + "_MIN = " + min.toPrecision(4) + ";\n";
                            st_text = st_text + parameter + "_MAX = " + max.toPrecision(4) + ";\n";
                            hasParametervalues = true;
                        }
                    };
                }
                if (hasParametervalues) {
                    $('#'+group+'-'+value+'-field').text(st_text_comm + "data = stoqs_down('" + base_url + "json" + mp_param + "');\n");
                }
                else {
                    $('#'+group+'-'+value+'-field').text(st_text + "\ndata = stoqs_down(" + req_params.join() + ");\n");
                }
            }
            // Queries made using measuredparameter or sampledparamter REST requests - use mp_parm for Django queries 
            else if (value == 'json') {
                var url = base_url + 'json' + mp_param;
                url = url.replace(/ /g, '%20');
                $('#'+group+'-'+value+'-field').text(url);
                $('#'+group+'-'+value+'-link').attr('href',url);
            }
            else if (value == 'csv') {
                var url = base_url + 'csv' + mp_param;
                url = url.replace(/ /g, '%20');
                $('#'+group+'-'+value+'-field').text(url);
                $('#'+group+'-'+value+'-link').attr('href',url);
            }
            else if (value == 'tsv') {
                var url = base_url + 'tsv' + mp_param;
                url = url.replace(/ /g, '%20');
                $('#'+group+'-'+value+'-field').text(url);
                $('#'+group+'-'+value+'-link').attr('href',url);
            }
            else if (value == 'html') {
                var url = base_url + 'html' + mp_param;
                url = url.replace(/ /g, '%20');
                $('#'+group+'-'+value+'-field').text(url);
                $('#'+group+'-'+value+'-link').attr('href',url);
            }
            else {
                $('#'+group+'-'+value+'-field').text(url);
                $('#'+group+'-'+value+'-link').attr('href',url);
            }
        });
    }

    function toggleField(element) {
        var $element=$(element);
        if (! $(element).is('.disabled')) { // If it's disabled, then don't bother toggling it.
            if ($element.is('.btn-primary')) {
                $element.removeClass('btn-primary');
            } else {
                $element.addClass('btn-primary');
                if ($(element).hasClass('sampledparametersgroup')) {
                    $('#clear-sampledparameter-button').removeClass('disabled');
                    $('#clear-sampledparameter-button').addClass('btn-primary');
                }
                if ($(element).hasClass('measuredparametersgroup')) {
                    $('#clear-measuredparameter-button').removeClass('disabled');
                    $('#clear-measuredparameter-button').addClass('btn-primary');
                }
                if ($(element).hasClass('parameterstandardname')) {
                    $('#clear-measuredparameter-button').removeClass('disabled');
                    $('#clear-measuredparameter-button').addClass('btn-primary');
                }
                if ($(element).hasClass('platform')) {
                    $('#clear-platforms-button').removeClass('disabled');
                    $('#clear-platforms-button').addClass('btn-primary');
                }
                if ($(element).hasClass('attributes')) {
                    $('#clear-attributes-button').removeClass('disabled');
                    $('#clear-attributes-button').addClass('btn-primary');
                }
            }
        }
    } // toggleField()
    
    function getUTCDateString(date) {
        // $.format.date(date,'yyyy-MM-dd hh:mm:ss') is broken in Safari, construct SQL friendly date string this way
        var mon = new String(date.getUTCMonth() + 1);
        mon = mon.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var day = new String(date.getUTCDate());
        day = day.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var hr = new String(date.getUTCHours());
        hr = hr.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var mn = new String(date.getUTCMinutes());
        mn = mn.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var se = new String(date.getUTCSeconds());
        se = se.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });

        var date_str = date.getUTCFullYear() + '-' + mon + '-' + day;
        date_str = date_str + ' ' + hr + ':' + mn + ':' + se;

        return date_str
    }

    function getValueOrdinal(value) {
        // Add a suffix (st, nd, th) to a number 
        if (value == 1) {
            ordinal = 'single';
        }
        else if (value == 11 || value == 12 || value == 13) {
            ordinal = value + 'th';
        }
        else if (value.toString().match(/1$/)) {
            ordinal = value + 'st';
        }
        else if (value.toString().match(/2$/)) {
            ordinal = value + 'nd';
        }
        else if (value.toString().match(/3$/)) {
            ordinal = value + 'rd';
        }
        else {
            ordinal = value + 'th';
        }
                                
        return ordinal
    }

    function makeSlider(divid, type, data) {
        if (type == 'time') {
            var start=new Date(data[0]);
            var end=new Date(data[1]);
            var max=Math.abs((start.getTime() - end.getTime()));
            var min=0
        } else if (type == 'depth') {
            // Float/Decimal type
            var min=Math.floor(data[0]*10000);
            var max=Math.ceil(data[1]*10000);
        }
        if (type == 'time') {
            var formatter=function (value) { 
                var start=new Date(data[0]);
                var cur=new Date(start.getTime() + value);
                return getUTCDateString(cur);
            };
            var reverseformatter=function (value) {
                var start=new Date(data[0]);
                try {
                    var end=new Date(value);
                } catch (err) {
                    var end=new Data(data[1]).getTime();
                }
                var cur=Math.abs((start.getTime() - end.getTime()));
                return cur;
            };
        } else if (type == 'depth') {
            // Float/Decimal type
            var formatter=function(value) { return value/10000; };
            var reverseformatter=function(value) { return value *10000; };
        }
        var options={max: max,
                     min: min,
                     values: [min, max],
                     range: true
        };
        
        var div=$('#' + divid);
        div.bind({
            //slide : function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, false); },
            //slidechange:function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, true); }
            slide : function (event, ui) { },
            slidechange:function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, true); }
        })
        div.slider(options);
        
        div.data("reverseformatter", reverseformatter);
        if (typeof postaddfunc != "undefined") {
           //div.data("postaddfunction", postaddfunc);
        }
        return div;

    } // makeSlider()

    function recordUpdatedValues(values, divid, type, formatter, updateTable) {
        var min=formatter(values[0])
        var max=formatter(values[1])
        $('#start-' + type).val(min)
        $('#end-' + type).val(max)
        if (updateTable) {
            rebuildFilters();
        }
    }
    
    function rebuildFilters(only) {
        if ((typeof permalink_bypass !== 'undefined') &&
            (permalink_bypass == true)) {
            return ;
        } 
        params = {};
        // To tell the backend to process for the list of options in the only list
        // Useful for radio button and checkbox events that do not change the selection
        // and for not updating data for panels not visible in the UI.  Items in the 
        // only list are the keys of options_functions in utils/STOQSQManager.py.
        if ( ! $.isEmptyObject(only) ) {
            params['only'] = only
        }
        // Tell the backend what not to build a response for. Typically used for mpsql
        // and spsql, which should only be generated if those tabs are open.
        params['except'] = [];
        if ( ! $('#sp-sql').hasClass('active') && ($.inArray('spsql', only) == -1) ) {
            params['except'].push('spsql');
        }
        if ( ! $('#mp-sql').hasClass('active') && ($.inArray('mpsql', only) == -1) ) {
            params['except'].push('mpsql');
        }

        params['sampledparametersgroup']=[]
        $('td',$('#sampledparameter-table > tbody')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                if ( $('.sampledparametersgroup', $(element)).length) {
                    params['sampledparametersgroup'].push(element.id);
                }
            }
        });
        if (params['sampledparametersgroup'].length) {
            $('#sampledparameters-anchor').html('Sampled Parameter id(s): ' + params['sampledparametersgroup'].join())
        }
        else {
            $('#sampledparameters-anchor').html('Sampled Parameters')
            $('#clear-sampledparameter-button').removeClass('btn-primary');
            $('#clear-sampledparameter-button').addClass('disabled');
        }

        params['measuredparametersgroup']=[]
        params['parameterstandardname']=[]
        var regExp = new RegExp('--.+-sn');
        $('td',$('#measuredparameter-table > tbody')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                if ( $('.measuredparametersgroup', $(element)).length) {
                    params['measuredparametersgroup'].push(element.id);
                }
                if ( $('.parameterstandardname', $(element)).length) {
                    params['parameterstandardname'].push(element.id.replace(regExp,''));
                }
            }
        });
        $('#measuredparameters-anchor').html('Measured Parameter: ')
        if (params['measuredparametersgroup'].length) {
            $('#measuredparameters-anchor').append('name(s): ' + params['measuredparametersgroup'].join())
        }
        if (params['parameterstandardname'].length) {
            $('#measuredparameters-anchor').append('standard name(s): ' + params['parameterstandardname'].join())
        }
        if ( ! params['measuredparametersgroup'].length && ! params['parameterstandardname'].length) {
            $('#measuredparameters-anchor').html('Measured Parameters')
            $('#clear-measuredparameter-button').removeClass('btn-primary');
            $('#clear-measuredparameter-button').addClass('disabled');
        }

        if ($('.btn-primary', $('#temporal-anchor').parent()).length) {
            params['start_time'] = $('body').data()['start-time'];
            params['end_time'] = $('body').data()['end-time'];
            params['min_depth'] = $('body').data()['start-depth'];
            params['max_depth'] = $('body').data()['end-depth'];
        }
        else {
            // Not Zoomed in - set params from the current flot axis limits
            params['xaxis_min'] = timedepthplot.getAxes().xaxis.min;
            params['xaxis_max'] = timedepthplot.getAxes().xaxis.max;
            params['yaxis_min'] = timedepthplot.getAxes().yaxis.min;
            params['yaxis_max'] = timedepthplot.getAxes().yaxis.max;
        }

        params['platforms']=[]
        $('tr',$('.stoqs-platform')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                params['platforms'].push(element.id);
            }
        });
        if (params['platforms'].length) {
            $('#platforms-anchor').html('Platform name: ' + params['platforms'].join())
        }
        else {
            $('#platforms-anchor').html('Platforms')
            $('#clear-platforms-button').removeClass('btn-primary');
            $('#clear-platforms-button').addClass('disabled');
        }

        params['mplabels']=[]
        $('tr',$('#amp')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                params['mplabels'].push(element.id);
            }
        });
        if (params['mplabels'].length) {
            $('#attributes-anchor').html('Attributes: ' + params['mplabels'].join())
        }
        else {
            $('#attributes-anchor').html('Attributes')
            $('#clear-attributes-button').removeClass('btn-primary');
            $('#clear-attributes-button').addClass('disabled');
        }

        if (parametervalues) {
            valueText = ': ';
            for (var parameter in parametervalues) {
                // No CF standard names end with '_MIN' or '_MAX' and none have upper case letters, so the convention
                // of adding these identifiers and taking them off should work.
                var min = parametervalues[parameter]['xmin'];
                var max = parametervalues[parameter]['xmax'];
                if (typeof min != 'undefined' && typeof max != 'undefined') {
                    params[parameter + '_MIN'] = min.toPrecision(4);
                    params[parameter + '_MAX'] = max.toPrecision(4);
                    valueText = valueText + parameter + ': ' + min.toPrecision(4) + ' to ' + max.toPrecision(4) + ', ';
                    $('#resetparametervaluesselections').removeClass('disabled');
                    $('#resetparametervaluesselections').addClass('btn-primary');
                }
            };
            valueText = valueText.substring(0, valueText.length - 2); 
            $('#parameter-values-anchor').html('Parameter Values' + valueText);
        }

        pp_html = '';
        if ($('input:radio[name=parameters_x]').is(':checked')) {
            if ( $('input:radio[name=parameters_x]:checked').val() ) {
                params['px'] = $('input:radio[name=parameters_x]:checked').val();
                pp_html = pp_html + 'x:' + params['px'] + ' ';
            }
        }
        if ($('input:radio[name=parameters_y]').is(':checked')) {
            if ( $('input:radio[name=parameters_y]:checked').val() ) {
                params['py'] = $('input:radio[name=parameters_y]:checked').val();
                pp_html = pp_html + 'y:' + params['py'] + ' ';
            }
        }
        if ($('input:radio[name=parameters_z]').is(':checked')) {
            if ( $('input:radio[name=parameters_z]:checked').val() ) {
                params['pz'] = $('input:radio[name=parameters_z]:checked').val();
                pp_html = pp_html + 'z:' + params['pz'] + ' ';
            }
        }
        if ($('input:radio[name=parameters_c]').is(':checked')) {
            if ( $('input:radio[name=parameters_c]:checked').val() ) {
                params['pc'] = $('input:radio[name=parameters_c]:checked').val();
                pp_html = pp_html + 'c:' + params['pc'] + ' ';
            }
        }
        if ( $('input:radio[name=parameters_x]').is(':checked') || $('input:radio[name=parameters_y]').is(':checked') ||
             $('input:radio[name=parameters_z]').is(':checked') || $('input:radio[name=parameters_c]').is(':checked') ) {
            $('#parameter-parameter-anchor').html('Parameter-Parameter: ' + pp_html.substring(0, pp_html.length - 1))
        }
        else {
            $('#parameter-parameter-anchor').html('Parameter-Parameter')
        }
        if ($('#temporal-parameter-li').hasClass('active')) {
            params['parametertab'] = 1;
            params['secondsperpixel'] = ($('body').data()['end-ems'] - $('body').data()['start-ems']) / PIXELS_WIDE / 1000.0;
        }

        // Add activitynames to the query string only when the Metadata -> NetCDF tab is opened
        if ( $('input:checkbox[name=activity_select_cb]').is(':checked') ) {
            if ( $('#collapseMetadata').hasClass('in') && $('#metadata-netcdf-li').hasClass('active') ) {
                // Metadata section is opened and NetCDF tab is active, offer selection of Activities
                params['activitynames'] = [];
                $('input:checked[name=activity_select_cb]').each(function (index, elem) {
                    params['activitynames'].push(elem.value);
                });
            }
        }

        // Since the old link (if there was one) for the permalink is no longer valid, hide it
        $('#permalink-box').hide();
        
        //updateShowDataInfo();
        updateSummaryData();

        polyLayer.removeAllFeatures();

    } // rebuildFilters()
    

    function clearMap() {
        // Clear the map of all WMS layers
        track_lines.clearGrid();
        stations.clearGrid();
        sample_points.clearGrid();
    }
    function refreshMap(e) {
        if ( $.isEmptyObject(e) ) {
            return;
        }
        if (hasTrajectory) {
            track_lines.setVisibility(true);
            track_lines.redraw(true);
        }
        else {
            track_lines.setVisibility(false);
        }
        if (hasTimeSeries || hasTimeSeriesProfile || hasTrajectoryProfile) {
            stations.setVisibility(true);
            stations.redraw(true);
        }
        else {
            stations.setVisibility(false);
        }
        sample_points.redraw(true);

        if ($('#zoomtoextentonupdate').is(':checked')) {
            map.zoomToExtent(new OpenLayers.Bounds(e[0][0],e[0][1],e[1][0],e[1][1]));
        }
    }

    // Special handling for unzooming (Clear Selection) the time-depth-plot and time-parameter-plot
    $("#zoomed-button").click(function() {
        if ( $('.btn-primary', $('#time-depth-plot').length) ) {
            var zoom_sdt = zoom_simpledepthtime_stack[0];
            $('body').data()['start-ems'] = zoom_sdt[0];
            $('body').data()['end-ems'] = zoom_sdt[1];
            $('body').data()['start-depth'] = zoom_sdt[2];
            $('body').data()['end-depth'] = zoom_sdt[3];
            simpledepthtime_options_zoom = zoom_sdt[4];

            // Clear zoom_parametertime_stack but not zoom_simpledepthtime_stack
            // as the former starts empty on init and the latter is pushed on init
            zoom_parametertime_stack = [];
            parametertime_options_zoom = parametertime_options;

            $("#zoomed-button").removeClass('btn-primary');
            $("#zoomed-button").addClass('disabled');
            $('#zoomed-button').attr('title', ' ').tooltip('fixTitle').tooltip('hide');

            var items = []
            var plotDataSelection = $('input:radio[class=parameter-plot-radio]:checked').val();
            if ( typeof plotDataSelection != 'undefined') {
                if (plotDataSelection) {
                    // Setting clearingTemporalFlag to true here causes rebuildFilters() to call itself again in order
                    // to get the flot axis limits resulting from the remaining selections so that the image for
                    // parameterplatformdatavaluepng can be properly generated with those axis limits.
                    clearingTemporalFlag = true;
                    items = ['parameters', 'platforms', 'simpledepthtime', 'sampledepthtime', 'sampledurationsdepthtime'];
                }
            }
            updateTemporal();
            rebuildFilters(items);
        }
    });

    $(document).on('click', ".stoqs-toggle", function (event) {
        toggleField(this);
        rebuildFilters();
    });

    $('#spatial-3d-x3d-pause-play').on('click', function (event) {
        if ($('#spatial-3d-x3d-pause-play').hasClass('icon-pause')) {
            $('#spatial-3d-x3d-pause-play').removeClass('icon-pause')
            $('#spatial-3d-x3d-pause-play').addClass('icon-play')
            $('#PLATFORMS_TS').attr('enabled','false');
        }
        else if ($('#spatial-3d-x3d-pause-play').hasClass('icon-play')) {
            $('#spatial-3d-x3d-pause-play').removeClass('icon-play')
            $('#spatial-3d-x3d-pause-play').addClass('icon-pause')
            $('#PLATFORMS_TS').attr('enabled','true');
            setScale(event);
        }
    });

    $('#getactualcount').on('click', function (event) {
        // Don't need to get everything from queryData, only the count
        rebuildFilters(['counts']);
    });

    $('.pv-histogram-checkbox').on('click', function (event) {
        // Don't need to get everything from queryData, only the new histogramdata
        $('#histogram-instruction').html('<em>Click and drag on plots to select parameter ranges</em>');
        rebuildFilters(['activityparameterhistograms']);
    });

    $('input[name="showdataas"]').on('click', function (event) {
        // Don't need to get everything from queryData, only the response with the PNG image
        rebuildFilters(['parameterplatformdatavaluepng', 'parameterminmax']);
    });

    $('#showgeox3dmeasurement').on('click', function (event) {
        // Don't need to get everything from queryData, only the response with the X3D data
        rebuildFilters(['measuredparameterx3d']);
    });

    $('#showplatforms').on('click', function (event) {
        if ( $('#showplatforms').is(':checked') ) {
            // Need time series data to redraw with crosshairs, so get everything
            rebuildFilters();
            addStationaryPlatformModels();
            $('#showgeox3dlabels').parent().show();
            $('#showgeox3denuaxes').parent().show();
            $('#showplatforms').parent().parent().css( {'padding': '3px',
                                                        'background-color': 'lightgray'});
        }
        else {
            if ( ! $.isEmptyObject($('body').data()['platformAnimation']) ) {
                $.each($('body').data()['platformAnimation'], function (index, platform) {
                    $('#' + platform + '_LOCATION')[0].setAttribute('render', false);
                });
            }
            $('body').data()['platformAnimation'] = [];
            $('#showgeox3dlabels').parent().hide();
            $('#showgeox3denuaxes').parent().hide();
            $('#showplatforms').parent().parent().removeAttr('style');
        }
    });


    $('#showsensortracks').on('click', function (event) {
        update_sensortrackskml();
    });

    $('#show-filtered-sp-checkbox').on('click', function (e) {
        if ( $('#show-filtered-sp-checkbox').is(':checked') ) {
            $('tr.disabled',$('#sampledparameter-table')).show();
        }
        else {
            $('tr.disabled',$('#sampledparameter-table')).hide();
        }
    });

    $('#show-filtered-mp-checkbox').on('click', function (e) {
        if ( $('#show-filtered-mp-checkbox').is(':checked') ) {
            $('tr.disabled',$('#measuredparameter-table')).show();
        }
        else {
            $('tr.disabled',$('#measuredparameter-table')).hide();
        }
    });

    $('#show-parameter-parameter-sp-checkbox').on('click', function (e) {
        if ( $('#show-parameter-parameter-sp-checkbox').is(':checked') ) {
            $('#show-parameter-parameter-mp-checkbox').prop('checked', true);
            $('.parameter-radio').parent().show();
            $('.sn-leader').attr('colspan', '5');
            $('.pp-header').show();
        }
        else {
            $('#show-parameter-parameter-mp-checkbox').prop('checked', false);
            $('.parameter-radio').parent().hide();
            $('.sn-leader').attr('colspan', '1');
            $('.pp-header').hide();
        }
    });

    $('#show-parameter-parameter-mp-checkbox').on('click', function (e) {
        if ( $('#show-parameter-parameter-mp-checkbox').is(':checked') ) {
            $('#show-parameter-parameter-sp-checkbox').prop('checked', true);
            $('.parameter-radio').parent().show();
            $('.sn-leader').attr('colspan', '5');
            $('.pp-header').show();
        }
        else {
            $('#show-parameter-parameter-sp-checkbox').prop('checked', false);
            $('.parameter-radio').parent().hide();
            $('.sn-leader').attr('colspan', '1');
            $('.pp-header').hide();
        }
    });

    $('#show-standardnames-mp-checkbox').on('click', function (e) {
        if ( $('#show-standardnames-mp-checkbox').is(':checked') ) {
            $('.parameterstandardname').parent().parent().show();
            enableButton($('.parameterstandardname'));
        }
        else {
            $('.parameterstandardname').parent().parent().hide();
            disableButton($('.parameterstandardname'));
        }
    });

    $('#show-coordinates-sp-checkbox').on('click', function (e) {
        if ( $('#show-coordinates-sp-checkbox').is(':checked') ) {
            $('.sp-pp-coordinates').show();
        }
        else {
            $('.sp-pp-coordinates').hide();
        }
    });

    $('#show-coordinates-mp-checkbox').on('click', function (e) {
        if ( $('#show-coordinates-mp-checkbox').is(':checked') ) {
            $('.mp-pp-coordinates').show();
        }
        else {
            $('.mp-pp-coordinates').hide();
        }
    });

    $('#showgeox3dlabels').on('click', function (e) {
        // Turn off and on all text labels to make BEDs animation less 'busy'
        if ( $('#showgeox3dlabels').is(':checked') ) {
            $.each($('body').data()['platformAnimation'], function (index, platform) {
                $('#' + platform + '_SCALE > transform > billboard')[0].setAttribute('render', true);
                $.each($('#' + platform + '_SCALE > transform > inline > transform > billboard'), function (index, axislabel) {
                    axislabel.setAttribute('render', true);
                });
            });
        }
        else {
            $.each($('body').data()['platformAnimation'], function (index, platform) {
                $('#' + platform + '_SCALE > transform > billboard')[0].setAttribute('render', false);
                $.each($('#' + platform + '_SCALE > transform > inline > transform > billboard'), function (index, axislabel) {
                    axislabel.setAttribute('render', false);
                });
            });
        }
    });

    $('#showgeox3denuaxes').on('click', function (e) {
        // turn off and on all East North Up orientation axes
        if ( $('#showgeox3denuaxes').is(':checked') ) {
            $.each($('body').data()['platformAnimation'], function (index, platform) {
                $('#' + platform + '_SCALE > transform > inline')[0].setAttribute('render', true);
            });
        }
        else {
            $.each($('body').data()['platformAnimation'], function (index, platform) {
                $('#' + platform + '_SCALE > transform > inline')[0].setAttribute('render', false);
            });
        }
    });

    $('#colormap').on('click', function(e) {
        // Togggle show/hide the Colormaps accordion section
        var $elem = $('#colormap-anchor').parent().parent().parent();
        if ( $elem.css('display') == 'none' ) {
            $('#colormap-anchor').parent().parent().parent().show();
        }
        else {
            $('#colormap-anchor').parent().parent().parent().hide();
        }
        return true;
    });

    $('#mp-cmin').on('keypress', function (event, previousText) {
        setTimeout(updateKMLcmincmax('mp'));
    });

    $('#mp-cmax').on('keypress', function (event, previousText) {
        setTimeout(updateKMLcmincmax('mp'));
    });

    $('#sp-cmin').on('keypress', function (event, previousText) {
        setTimeout(updateKMLcmincmax('sp'));
    });

    $('#sp-cmax').on('keypress', function (event, previousText) {
        setTimeout(updateKMLcmincmax('sp'));
    });

    $('body').on('change', '.parameter-radio', function (e) {
        $("#clear-pp-button").addClass('btn-primary');
        $("#clear-pp-button").removeClass('disabled');
        if ( $('input:radio[name=parameters_x]').is(':checked') && $('input:radio[name=parameters_y]').is(':checked') ) {
            rebuildFilters(['parameterparameterpng', 'parameterparameterx3d']);
        }
    });

    $('body').on('change', '.parameter-plot-radio', function (e) {
        if ( $('body').data()['parameterplatforms'][e.target.value] ) {
            if ( $('button.btn-primary.stoqs-toggle.platform').length != 1 ) {
                //alert('WARNING: Platforms ' + $('body').data()['parameterplatforms'][e.target.value] + ' measured this Parameter.');
            }
            $('#contour-scatter-buttons').show();
            $('#sensor-tracks-checkbox').show();
            $('#temporalparameterplotinfo').data('info', $('button', $('input:radio[name=parameters_plot]:checked').parent().siblings()[5]).text() + ' from ' + 
                                                         $('body').data()['parameterplatforms'][$('input:radio[name=parameters_plot]:checked').val()]);
            $('#temporalparameterplotinfo').text('Plotting ' + $('#temporalparameterplotinfo').data()['info'] + '...');
            $('#showsensortrackstext').text($('#temporalparameterplotinfo').data()['info']);
            $('#showsensortracks').removeAttr('disabled');
            $('#showgeox3dmeasurementtext').text($('#temporalparameterplotinfo').data()['info']);
            rebuildFilters(['parameterplatformdatavaluepng', 'measuredparameterx3d', 'parameterminmax']);
        }
        else {
            // Remove sensortracks and image from Flot plot
            $('#contour-scatter-buttons').hide();
            $('#sensor-tracks-checkbox').hide();
            $('#temporalparameterplotinfo').data('info', '');
            $('#temporalparameterplotinfo').text('');
            $('#showsensortrackstext').text('');
            $('#showsensortracks').attr('disabled', true);
            $('#showgeox3dmeasurementtext').text('');
            $('#sectioncolorbarimg').removeAttr('src');
            $('#temporalparameterstrideinfo').text('');
            rebuildFilters(['parameterminmax', 'simpledepthtime', 'simplebottomdepthtime', 'platforms', 'sampledepthtime', 'sampledurationsdepthtime']);
        }
    });

    $("#clear-pp-button").click(function() {
        if ( $('#clear-pp-button').hasClass('btn-primary')) {
            $("#clear-pp-button").removeClass('btn-primary');
            $("#clear-pp-button").addClass('disabled');
            $('#parameter-parameter-anchor').html('Parameter-Parameter')
            $("input:radio[name='parameters_x'][value='']").prop('checked', true)
            $("input:radio[name='parameters_y'][value='']").prop('checked', true)
            $("input:radio[name='parameters_z'][value='']").prop('checked', true)
            $("input:radio[name='parameters_c'][value='']").prop('checked', true)
            $('#parameter-parameter-2dplot > img').removeAttr('src');
            $('#parameter-parameter-2dplot > pre').html('');
            //$('#pp2d').html('');
            //$('#pp3d').html('');
            //$('#ppdata').html('');
        }
    });

    $("#clear-sampledparameter-button").click(function() {
        if ( $('#clear-sampledparameter-button').hasClass('btn-primary')) {
            $("#clear-sampledparameter-button").removeClass('btn-primary');
            $("#clear-sampledparameter-button").addClass('disabled');
            $('td',$('#sampledparameter-table')).each(function (index, element) {
                if ($('.btn-primary', $(element)).length) {
                    $('#' + element.id + ' > button').removeClass('btn-primary');
                }
            });
            rebuildFilters();
            $('#sampledparameters-anchor').html('Sampled Parameters')
        }
    });

    $("#clear-measuredparameter-button").click(function() {
        if ( $('#clear-measuredparameter-button').hasClass('btn-primary')) {
            $("#clear-measuredparameter-button").removeClass('btn-primary');
            $("#clear-measuredparameter-button").addClass('disabled');
            $('td',$('#measuredparameter-table')).each(function (index, element) {
                if ($('.btn-primary', $(element)).length) {
                    $('#' + element.id + ' > button').removeClass('btn-primary');
                }
            });
            rebuildFilters();
            $('#measuredparameters-anchor').html('Measured Parameters')
        }
    });

    $("#resetparametervaluesselections").click(function() {
        if ( $('#resetparametervaluesselections').hasClass('btn-primary')) {
            $("#resetparametervaluesselections").removeClass('btn-primary');
            $("#resetparametervaluesselections").addClass('disabled');
            parametervalues = {};
            rebuildFilters();
        }
    });

    $("#clear-attributes-button").click(function() {
        if ( $('#clear-attributes-button').hasClass('btn-primary')) {
            $("#clear-attributes-button").removeClass('btn-primary');
            $("#clear-attributes-button").addClass('disabled');
            $('tr',$('.stoqs-attributes')).each(function (index, element) {
                if ($('.btn-primary', $(element)).length) {
                    $('#' + element.id + ' > td > button').removeClass('btn-primary');
                }
            });
            rebuildFilters();
            $('#attributes-anchor').html('Attributes')
        }
    });
    $("#clear-platforms-button").click(function() {
        if ( $('#clear-platforms-button').hasClass('btn-primary')) {
            $("#clear-platforms-button").removeClass('btn-primary');
            $("#clear-platforms-button").addClass('disabled');
            $('tr',$('.stoqs-platform')).each(function (index, element) {
                if ($('.btn-primary', $(element)).length) {
                    $('#' + element.id + ' > td > button').removeClass('btn-primary');
                }
            });
            rebuildFilters();
            $('#platforms-anchor').html('Platforms')
        }
    });

    $("#parameter-values-anchor").click(function() {
        //if ( $("#parameter-values-anchor").hasClass('in') ) {
            // Force load of some histograms when this accordian is opened
            $('#showstandardnameparametervalues').attr({checked: true});
            $('#histogram-instruction').html('<em>Click and drag on plots to select parameter ranges</em>');
            rebuildFilters(['activityparameterhistograms']);
        //}
    });

    $('#parameter-parameter-sql').click( function() { 
        SelectText('parameter-parameter-sql') 
    });

    var formats=[{% for format in formats %}'{{format.0}}'{% if not forloop.last %},{% endif %}{%endfor%}]
    $.each(formats, function (index, value) {
        $('#mp-' + value + '-field').click( function() { 
            SelectText('mp-' + value + '-field') 
        });
        $('#sp-' + value + '-field').click( function() { 
            SelectText('sp-' + value + '-field') 
        });
    });
    
    
    $(".zoom-lc-button").click(function(element) {
        if (lcZoomed) {
            if ($('.stoqs-zoom-width').hasClass('span12')) {
                $('.stoqs-zoom-width').removeClass('span12');
            }
            if (! $('.stoqs-zoom-width').hasClass('span6')) {
                $('.stoqs-zoom-width').addClass('span6');
            }
            $('.navbar').show();
            $('body').css({'padding-top': '35px'});
            $('#accordion1').addClass('well');
            $('#metadata-group').show();
            $('#sp-data-access-group').show();
            $('#mp-data-access-group').show();
            $('#right-column').show();
            if (this.id == 'pp-zoom-lc-button') {
                $('#spatial-group').children().show();
                $('#parameter-parameter-anchor').parent().show();
                $('#parameterParameterTabs').show();
                $('#parameter-parameter-3dplot').css( { 'height': '500px',
                                                        'width': '',
                                                        'position': ''
                                                      } );
            }
            if (this.id == 'geo-zoom-lc-button') {
                $('#parameter-parameter-group').children().show();
                $('#spatial-anchor').parent().show();
                $('#spatialTabs').show();
                $('#geo-3dplot').css( { 'height': '500px',
                                        'width': '',
                                        'position': ''
                                      } );
            }
            $(this).html('<i class="icon-resize-full" title="Full Screen"></i>');
        } else {
            if ($('.stoqs-zoom-width').hasClass('span6')) {
                $('.stoqs-zoom-width').removeClass('span6');
            }
            if (! $('.stoqs-zoom-width').hasClass('span12')) {
                $('.stoqs-zoom-width').addClass('span12');
            }
            $('.navbar').hide();
            $('body').css({'padding-top': '0px'});
            $('#accordion1').removeClass('well');
            $('#metadata-group').hide();
            $('#sp-data-access-group').hide();
            $('#mp-data-access-group').hide();
            $('#right-column').hide();
            if (this.id == 'pp-zoom-lc-button') {
                $('#spatial-group').children().hide();
                $('#parameter-parameter-anchor').parent().hide();
                $('#parameterParameterTabs').hide();
                $('#parameter-parameter-3dplot').css( { 'height': '90%',
                                                        'width': '100%',
                                                        'position': 'fixed'
                                                      });
            }
            if (this.id == 'geo-zoom-lc-button') {
                $('#parameter-parameter-group').children().hide();
                $('#spatial-anchor').parent().hide();
                $('#spatialTabs').hide();
                $('#geo-3dplot').css( { 'height': '100%',
                                        'width': '100%',
                                        'position': 'fixed'
                                      });
            }
            $(this).html('<i class="icon-resize-small" title="Not Full Screen"></i>');
        }
        lcZoomed = ! lcZoomed;
    });

    $(".zoom-rc-button").click(function(element) {
        if (rcZoomed) {
            if ($('.stoqs-zoom-width').hasClass('span12')) {
                $('.stoqs-zoom-width').removeClass('span12');
            }
            if (! $('.stoqs-zoom-width').hasClass('span6')) {
                $('.stoqs-zoom-width').addClass('span6');
            }
            $('#left-column').show()
            $('#accordion2').css( { 'margin-right': '' } );
            $('#right-column').css( { 'margin-left': '' } );
            $('#time-depth-plot').css( { 'height': '400px',
                                         'resize': '',
                                         'overflow': '' } );
            $('#time-parameter-plot').css( { 'height': '400px',
                                             'resize': '',
                                             'overflow': '' } );
            $(this).html('<i class="icon-resize-full" title="Full Screen"></i>');
        } else {
            if ($('.stoqs-zoom-width').hasClass('span6')) {
                $('.stoqs-zoom-width').removeClass('span6');
            }
            if (! $('.stoqs-zoom-width').hasClass('span12')) {
                $('.stoqs-zoom-width').addClass('span12');
            }
            $('#left-column').hide()
            $('#accordion2').css( { 'margin-right': '18px' } );
            $('#right-column').css( { 'margin-left': '0px' } );
            $('#time-depth-plot').css( { 'resize': 'vertical',
                                         'overflow': 'auto' } );
            $('#time-parameter-plot').css( { 'resize': 'vertical',
                                             'overflow': 'auto' } );
            $(this).html('<i class="icon-resize-small" title="Not Full Screen"></i>');
        }
        rcZoomed = ! rcZoomed;
    });

    function enable_vr() {
        // Follows example from http://examples.x3dom.org/Demos/ClassroomVR/classroom-rift-webvr-2.html

        runtime = $('#spatial-3d-x3d')[0].runtime;

        rtLeft = document.getElementById('rtLeft');
        rtRight = document.getElementById('rtRight');

        lastW = +runtime.getWidth();
        lastH = +runtime.getHeight();

        var hw = Math.round(lastW / 2);
        rtLeft.setAttribute('dimensions',  hw + ' ' + lastH + ' 4');
        rtRight.setAttribute('dimensions', hw + ' ' + lastH + ' 4');

        var viewpoint = document.getElementById('mp-x3d-geoviewpoint1');
        var initDone = false;

        var old_vp = runtime.getActiveBindable('geoviewpoint');
        var vp_ori_matrix = viewpoint.getFieldValue('orientation').toMatrix(); // as matrix
        var vp_pos = viewpoint.getFieldValue('position');
        

        runtime.enterFrame = function () {
            if (!vrSensor)
                return;
            var state = vrSensor.getState();

            if (!initDone) {
                console.log(state);
            }

            if (state.orientation !== null) {
                var h = state.orientation;
                var q = new x3dom.fields.Quaternion(h.x, h.y, h.z, h.w);

                var aa = q.toAxisAngle();
                //console.log(aa[0].x + " " + aa[0].y + " " + aa[0].z + " " + aa[1]);
                viewpoint.setAttribute("orientation", aa[0].x + " " + aa[0].y + " " + aa[0].z + " " + aa[1]); // triggers viewpointchanged event
            }

            if (state.position !== null) {
                pos = old_vp.requestFieldRef('position');

Â  Â  Â  Â  Â  Â  Â  Â  //multiply head position with initial viewpoint orientation to align

Â  Â  Â  Â  Â  Â  Â  Â  aHdPos = new x3dom.fields.SFVec3f(state.position.x, state.position.y, state.position.z);
                giant_factor = 100;
Â  Â  Â  Â  Â  Â  Â  Â  aHdPos = vp_ori_matrix.multMatrixVec(aHdPos.multiply(giant_factor)).add(pyr);

Â  Â  Â  Â  Â  Â  Â  Â  //pos.x = vp_pos.x + aHdPos.x;
Â  Â  Â  Â  Â  Â  Â  Â  //pos.y = vp_pos.y + aHdPos.y;
Â  Â  Â  Â  Â  Â  Â  Â  //pos.z = vp_pos.z + aHdPos.z;

Â  Â  Â  Â  Â  Â  Â  Â  //old_vp.releaseFieldRef('position'); // triggers viewpointchanged event
            }

        };

        runtime.exitFrame = function () {
            var w = +runtime.getWidth() * 2;
            var h = +runtime.getHeight() * 2;

            if (w != lastW || h != lastH)
            {
                var half = Math.round(w / 2);
                rtLeft.setAttribute('dimensions',  half + ' ' + h + ' 4');
                rtRight.setAttribute('dimensions', half + ' ' + h + ' 4');

                console.log(w + ", " + h);

                lastW = w;
                lastH = h;
            }

            if (!initDone) {
                initDone = true;
            }

            runtime.triggerRedraw();
        };

        /* ----------------------------------------------------------- */
        function vrDeviceCallback(vrdevs) {
            var i;

            // First, find a HMD -- just use the first one we find
            for (i = 0; i < vrdevs.length; ++i) {
                if (vrdevs[i] instanceof HMDVRDevice) {
                    vrHMD = vrdevs[i];
                    console.log(vrHMD);
                    break;
                }
            }

            if (!vrHMD)
                return;

            // Then, find that HMD's position sensor
            for (i = 0; i < vrdevs.length; ++i) {
                if (vrdevs[i] instanceof PositionSensorVRDevice &&
                    vrdevs[i].hardwareUnitId == vrHMD.hardwareUnitId) {
                    vrSensor = vrdevs[i];
                    console.log(vrSensor);
                    break;
                }
            }

            if (!vrHMD || !vrSensor) {
                alert("Didn't find a HMD and sensor!");
                return;
            }

            var leftEyeParams, 
                rightEyeParams, 
                leftFOV, 
                rightFOV, 
                leftTranslation, 
                rightTranslation;
            
            
            if (vrHMD.getEyeParameters !== undefined) {
                leftEyeParams = vrHMD.getEyeParameters("left");
                rightEyeParams = vrHMD.getEyeParameters("right");
                
                console.log(leftEyeParams);
                console.log(rightEyeParams);
                        
                leftFOV = leftEyeParams.currentFieldOfView;
                rightFOV = rightEyeParams.currentFieldOfView;

                console.log(leftFOV);
                console.log(rightFOV);

                leftTranslation = leftEyeParams.eyeTranslation;
                rightTranslation = rightEyeParams.eyeTranslation;

                console.log(leftTranslation);
                console.log(rightTranslation);
            } else {
                leftFOV = vrHMD.getCurrentEyeFieldOfView("left");
                rightFOV = vrHMD.getCurrentEyeFieldOfView("right");

                console.log(leftFOV);
                console.log(rightFOV);

                leftTranslation = vrHMD.getEyeTranslation("left");
                rightTranslation = vrHMD.getEyeTranslation("right");

                console.log(leftTranslation);
                console.log(rightTranslation);
            }
        }
        /* ----------------------------------------------------------- */


        // Modeled after Andreas's LeapFistThumb.txt sent to me from Mike Aratow and 
        // http://examples.x3dom.org/Demos/ClassroomVR/classroom-rift-leap-webvr-2.html

        var hand = document.getElementById("hand");

        function init()
        {
            // TODO create hand here

            // bones
            for (var i = 0; i < 5; i++)
            {
                finger = document.createElement("transform");

                for (var j = 0; j < 4; ++j)
                {
                    mtransform = document.createElement("MatrixTransform");
                    finger.appendChild(mtransform);

                    transform = document.createElement("transform");
                    mtransform.appendChild(transform);

                    transform.setAttribute("scale", "10 10 10");
                    shape = document.createElement("shape");
                    transform.appendChild(shape);

                    app = document.createElement("appearance");
                    mat = document.createElement("material");
                    mat.setAttribute("diffuseColor", "0.603 0.894 0.909");
                    app.appendChild(mat);
                    shape.appendChild(app);

                    geometry = document.createElement("box");
                    shape.appendChild(geometry);
                }

                document.getElementById("bones").appendChild(finger);
            }
        }

Â  Â  Â  Â  Leap.loop ( function(frame) {
Â  Â  Â  Â  Â  Â  var state, hand_frame, vpOrientation, m, d, dy, speed ;
Â  Â  Â  Â  Â  Â  var pyrYSpeed = 2;
Â  Â  Â  Â  Â  Â  if (!vrSensor)
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  state = vrSensor.getState();
Â  Â  Â  Â  Â  Â  if (frame.hands.length && state.position !== null)
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  hand_frame = frame.hands[0];
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  var hand = document.getElementById("hand");

Â  Â  Â  Â  Â  Â  Â  Â  var yaw = hand.children[0];
Â  Â  Â  Â  Â  Â  Â  Â  var pitch = yaw.children[0];
Â  Â  Â  Â  Â  Â  Â  Â  var roll = pitch.children[0];

Â  Â  Â  Â  Â  Â  Â  Â  yaw.setAttribute("translation", hand_frame.palmPosition[0] + " " + hand_frame.palmPosition[1] + " " + hand_frame.palmPosition[2]);

Â  Â  Â  Â  Â  Â  Â  Â  yaw.setAttribute("rotation", "0 1 0 " + -hand_frame.yaw());
Â  Â  Â  Â  Â  Â  Â  Â  pitch.setAttribute("rotation", "1 0 0 " + hand_frame.pitch());
Â  Â  Â  Â  Â  Â  Â  Â  roll.setAttribute("rotation", "0 0 1 " + hand_frame.roll());
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  //var viewpoint = document.getElementById("viewpoint"); //old_vp
Â  Â  Â  Â  Â  Â  Â  Â  vpOrientation = old_vp.getAttribute("orientation");
Â  Â  Â  Â  Â  Â  Â  Â  //relative to current orientaton
Â  Â  Â  Â  Â  Â  Â  Â  //var m = x3dom.fields.Quaternion.parseAxisAngle( vpOrientation ).toMatrix();
Â  Â  Â  Â  Â  Â  Â  Â  //relative to initial viewpoint
Â  Â  Â  Â  Â  Â  Â  Â  m = vp_ori_matrix;
Â  Â  Â  Â  Â  Â  Â  Â  //y from fist
Â  Â  Â  Â  Â  Â  Â  Â  dy = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (isFist(hand_frame)) {dy = pyrYSpeed;}
Â  Â  Â  Â  Â  Â  Â  Â  if (isThumb(hand_frame)) {dy = -pyrYSpeed;}
Â  Â  Â  Â  Â  Â  Â  Â  d = new x3dom.fields.SFVec3f(-hand_frame.roll(), dy, hand_frame.pitch());
Â  Â  Â  Â  Â  Â  Â  Â  //d = new x3dom.fields.SFVec3f(-hand_frame.roll(), hand_frame.yaw(), hand_frame.pitch());
Â  Â  Â  Â  Â  Â  Â  Â  //d = vp_ori_matrix.multMatrixVec(d);

Â  Â  Â  Â  Â  Â  Â  Â  if(d.z < 0)
Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.z *= 3.0;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  speed = 400; // runtime.speed()/100; scale speed by absolute elevation

Â  Â  Â  Â  Â  Â  Â  Â  pyr = pyr.addScaled(m.multMatrixVec(d), speed);

Â  Â  Â  Â  Â  Â  Â  Â  pyr_changed = true;

Â  Â  Â  Â  Â  Â  Â  Â  console.log("ll", d);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  for (var i = 0; i < Math.min(frame.fingers.length, 5); i++)
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  for (var j = 0; j < Math.min(frame.fingers[j].bones.length, 4); ++j)
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  finger = document.getElementById("bones").children[i];
Â  Â  Â  Â  Â  Â  Â  Â  bone = finger.children[j];
Â  Â  Â  Â  Â  Â  Â  Â  finger_frame = frame.fingers[i];

Â  Â  Â  Â  Â  Â  Â  Â  m = finger_frame.bones[j].matrix();
Â  Â  Â  Â  Â  Â  Â  Â  arr = new Array;

Â  Â  Â  Â  Â  Â  Â  Â  for (var x = 0; x < 4; ++x)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (var y = 0; y < 4; ++y)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  arr.push(m[y*4+x]);

Â  Â  Â  Â  Â  Â  Â  Â  bone.setAttribute("matrix", arr.join(" "));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â 

Â  Â  Â  Â  });

Â  Â  Â  Â  function isFist(hand) {
Â  Â  Â  Â  Â  Â  return Â !(hand.thumb.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.indexFinger.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.middleFinger.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.ringFinger.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.pinky.extended) ;

Â  Â  Â  Â  Â  Â  //return hand.fingers.every(function(f){return f.extended == false;});
Â  Â  Â  Â  };

Â  Â  Â  Â  function isThumb(hand) {
Â  Â  Â  Â  Â  Â  /*
Â  Â  Â  Â  Â  Â  console.log(hand.thumb.extended,
Â  Â  Â  Â  Â  Â  hand.indexFinger.extended,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.middleFinger.extended,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.ringFinger.extended,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.pinky.extended
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â  Â  return Â hand.thumb.extended &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  !(hand.indexFinger.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.middleFinger.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.ringFinger.extended ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hand.pinky.extended) ;

Â  Â  Â  Â  Â  Â  //hand.fingers.every(function(f){return f.type == 0 || f.extended == false;})
Â  Â  Â  Â  };
        // End of Modeled after Andreas's LeapFistThumb.txt sent to me from Mike Aratow


        if (navigator.getVRDevices)
            navigator.getVRDevices().then(vrDeviceCallback);

       init(); 

        // End of using template from http://examples.x3dom.org/Demos/ClassroomVR/classroom-rift-leap-webvr-2.html
    }


    $(".rift-button").click(function(element) {
        
        var vrHMD = null, vrSensor = null;


        if ( rifted ) {
            $('#spatial-3d-root').attr('render', 'true');
            $('#spatial-3d-left').attr('render', 'false');
            $('#spatial-3d-right').attr('render', 'false');
            $('#spatial-3d-x3d > Scene > Background').attr('skyColor', '.9608 .9608 .9608');
            var newSpeed = $('#spatial-3d-x3d > Scene > NavigationInfo').attr('speed') / 100000;
            $('#spatial-3d-x3d > Scene > NavigationInfo').attr('speed', newSpeed);
            $('#mp-x3d-viewpoint1').attr('zNear', '10');
            $('#mp-x3d-viewpoint1').attr('zFar', '300000');
            $('#mp-x3d-geoviewpoint1').attr('zNear', '100');
            $('#mp-x3d-geoviewpoint1').attr('zFar', '300000');
            $('#mp-x3d-geoviewpoint1').attr('position', $('body').data()['extent'][2] + ' ' + $('body').data()['extent'][1] + ' 1000');
            $('#mp-x3d-geoviewpoint1').attr('orientation', '1 0 0 -1.57');
            $('#left-column').parent().parent().css( { 'padding-left': '20px' } );
            $('#collapseSpatial > div').css( { 'padding-top': '9px' } );
            $('#collapseSpatial > div').css( { 'padding-left': '15px' } );
            $('#geo-3dplot').css( { 'background-color': '' } );
            $(this).html('Enter VR');
            runtime.exitFrame = function() {}
        }
        else {
            $('#spatial-3d-root').attr('render', 'false');
            $('#spatial-3d-left').attr('render', 'true');
            $('#spatial-3d-right').attr('render', 'true');
            $('#spatial-3d-x3d > Scene > Background').attr('skyColor', '0 0 0');
            // Fly mode still has the flipping problem, assume Examine mode is used which has a higher speed factor (100000)
            var newSpeed = $('#spatial-3d-x3d > Scene > NavigationInfo').attr('speed') * 100000;
            $('#spatial-3d-x3d > Scene > NavigationInfo').attr('speed', newSpeed);
            $('#mp-x3d-viewpoint1').attr('zNear', '10');
            $('#mp-x3d-viewpoint1').attr('zFar', '300000');
            $('#mp-x3d-geoviewpoint1').attr('zNear', '100');
            $('#mp-x3d-geoviewpoint1').attr('zFar', '30000');
            // put this viewpoint in the center of the horizontal extent and 100 units above sea level 
            $('#mp-x3d-geoviewpoint1').attr('position', $('body').data()['extent'][2] + ' ' + $('body').data()['extent'][1] + ' 100');
            $('#mp-x3d-geoviewpoint1').attr('orientation', '0 0 1 0');
            $('#left-column').parent().parent().css( { 'padding-left': '0px' } );
            $('#collapseSpatial > div').css( { 'padding-top': '0px' } );
            $('#collapseSpatial > div').css( { 'padding-left': '0px' } );
            $('#geo-3dplot').css( { 'background-color': '#2f2f2f' } );
            $(this).html('Leave VR');
            enable_vr();
            if(vrHMD) {
                var canvas = document.getElementsByTagName("canvas")[0];
                if (canvas.webkitRequestFullscreen) {
                    canvas.webkitRequestFullscreen({ vrDisplay: vrHMD });
                } else if (canvas.mozRequestFullScreen) {
                    canvas.mozRequestFullScreen({ vrDisplay: vrHMD });
                }
            }

        }

        rifted = ! rifted;

    });





    $('.temporal-tab > li').on('click', function (event) {
        // Show the tab then plot the data so that axes are properly drawn
        $('a', event.delegateTarget).tab('show');
       
        if ( event.delegateTarget.id == 'temporal-parameter-li' ) { 
            $('.parameter-plot-radio').hide();
            $('.parameter-plot-checkbox').show();
            $('.all-plot-instruction').text('Check all');
            if ( ! $('input:checkbox[class=parameter-plot-checkbox]').is(':checked') ) {
                if ( $('input:radio[name=parameters_plot]:checked').val() ) {
                    var parm_id = $('input:radio[name=parameters_plot]:checked').val();
                    $('input:checkbox[name=parameters_plot_cb][value=' + parm_id + ']').prop('checked',true);
                }
                else {
                    $('input:checkbox[name=mp_all_parameters_plot_cb]').prop('checked',true).triggerHandler('click');
                }
            }
            rebuildFilters(['parametertime', 'platformanimation', 'measuredparameterx3d']);
        }
        else if ( event.delegateTarget.id == 'temporal-depth-li' ) {
            $('.parameter-plot-radio').show();
            $('.parameter-plot-checkbox').hide();
            $('.all-plot-instruction').text('Clear Selection');
            var ranges={xaxis: {  to: $('body').data()['end-ems'],
                                from: $('body').data()['start-ems']},
                        yaxis: {  to: $('body').data()['end-depth'],
                                from: $('body').data()['start-depth']}
                        };
            ZoomIn(event, ranges);    // Calls rebuildFilters() for everything
        }
    });

    $('.sql-tab').on('click', function (event) {
        rebuildFilters([event.delegateTarget.id]);
    });

    $('body').on('change', '.parameter-plot-checkbox', function (e) {
        if ( ! $(this).hasClass('checkall_parametertime') ) {
            rebuildFilters(['parametertime']);
        }
    });

    $('.checkall_parametertime').on('click', function () {
        $(this).closest('fieldset').find(':checkbox:enabled').prop('checked', this.checked);
        // 'change' event handler on .parameter-plot-checkbox handles calling rebuildFilters()
    });

    $('.pp-options').on('click', function (event) {
        rebuildFilters(['parameterparameterpng']);
    });

    $('body').on('change', '.activity-select-checkbox', function (e) {
        if ( ! $(this).hasClass('checkall_activity') ) {
            // Remember the selection
            if ( $(this).is(':checked') ) {
                $('body').data()['activitynames'][$(this).val()] = true;
            }
            else {
                $('body').data()['activitynames'][$(this).val()] = false;
            }
            rebuildFilters();
        }
    });


    simpledepthtime_options = { grid: { 
                                        backgroundColor: "rgb(192, 211, 228)",      // c0d3e4
                                        hoverable: true, 
                                        clickable: true 
                                    },
                                    xaxis: { mode: "time" },
                                    yaxis: {
                                        transform: function (v) { return -v; },
                                        inverseTransform: function (v) { return -v; }
                                    },
                                    xaxes: [{
                                                axisLabel: 'Time (gmt)'
                                            }],
                                    yaxes: [{
                                                position: 'left',
                                                axisLabel: 'Depth (m)'
                                            }],
                                    series: {
                                        lines: { show: true, fill: false, lineWidth: 1 },
                                        points: { show: false, fill: false },
                                        shadowSize: 0
                                    },
                                    legend: { show: false },
                                    selection: { mode: "xy" }
                                  };
    histogram_options = {   yaxis: {
                                    autoscaleMargin: null
                                },
                                grid: {
                                    backgroundColor: "rgb(192, 211, 228)"      //c0d3e4
                                },
                                series: {
                                    lines: { show: false }
                                },
                                legend: { show: false },
                                selection: { mode: "x" },
                                hoverable: true
                            };
    parametertime_options = {   grid: {
                                        backgroundColor: "rgb(192, 211, 228)",      // c0d3e4
                                        hoverable: true
                                    },
                                    xaxis: { mode: "time" },
                                    xaxes: [{
                                                axisLabel: 'Time (gmt)'
                                            }],
                                    series: {
                                        lines: { show: true, fill: false, lineWidth: 1 },
                                        points: { show: false, fill: false },
                                        shadowSize: 0
                                    },
                                    legend: { show: false },
                                    selection: { mode: "x" }
                                };
    // Rotate from red to green - See http://www.benknowscode.com/2013/02/graphing-with-flot-controlling-series_9976.html
    parametertime_options.colors = [];
    var maxColors = 16;
    for (var i=0; i<=maxColors; i++) {
        var hue = i * 360 / maxColors;
        parametertime_options.colors.push(jQuery.Color({ hue: hue, saturation: 0.95, lightness: 0.35, alpha: 1 }).toHexString());
    }

    /* Default class modification for DataTable*/
    /*
    $.extend( $.fn.dataTableExt.oStdClasses, {
        "sSortAsc": "header headerSortDown",
        "sSortDesc": "header headerSortUp",
        "sSortable": "header",
        "sWrapper": "dataTables_wrapper form-inline",
        "sPaginationType": "full_numbers",
        "bJQueryUI": true,
        "aoColumnDefs": [ { "sWidth": "10%", "aTargets": [ -1 ] }
    ]
    });
    */

    function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 5,
            border: '1px solid #fdd',
            padding: '2px',
            'background-color': '#fee',
            opacity: 0.80
        }).appendTo("body").fadeIn(200);
    }

    $("#time-depth-flot").bind("plothover", function (event, pos, item) {
        if (item) {
            if (typeof previousPoint != 'undefined') {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;
                    
                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);
               
                    showTooltip(item.pageX, item.pageY,
                                item.series.label);
                }
            }
        }
        else {
            $("#tooltip").remove();
            previousPoint = null;            
        }
    });

    $("#time-parameter-flot").bind("plothover", function (event, pos, item) {
        if (item) {
            if (typeof previousPoint != 'undefined') {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;
                    
                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);
               
                    showTooltip(item.pageX, item.pageY,
                                item.series.label);
                }
            }
        }
        else {
            $("#tooltip").remove();
            previousPoint = null;            
        }
    });

    function showSampleData(label) {
            //http://172.16.130.129:8000/stoqs_october2010/sample.json?instantpoint__activity__name__contains=Dorado389_2010_278_01_278_01&name=4.0
            var sample_url = '{{site_uri}}{% url 'stoqs:show-sample-datatable' dbAlias=request.META.dbAlias fmt=".json" %}';
            sample_url = sample_url + '?instantpoint__activity__name__contains=' + label.split(' ')[0] + '&name=' + label.split(' ')[1];
            console.log('sample_url = ' + sample_url);

            request = $.ajax({
                type : 'GET',
                url : sample_url,
                success: function (json) {
                    $("#sample-table").dataTable( {
                        "bProcessing":  true,
                        "bDestroy":     true,
                        "aaData":       json.aaData,
                        "aoColumns":    json.aoColumns
                    });
                },
                dataType: "json"
            });

            $('#sample-instructions').text('')
            if (! $('#sp-collapseDataAccess').hasClass('in')) {
                $('#sp-data-access-anchor').click();
            }
    }

    function showQuickLooks(label) {
            // http://172.16.130.135:8000/stoqs_may2012/resourceactivity.json?resourcetype__name=quick_look&activityresource__activity__name__contains=Dorado389_2012_150_00_150_00_decim
            //var quicklook_url = '{{site_uri}}{% url 'stoqs:show-resourceactivity' dbAlias=request.META.dbAlias fmt=".json" %}?resourcetype__name=quick_look&';
            var quicklook_url = '{{site_uri}}{% url 'stoqs:show-quicklookplots' dbAlias=request.META.dbAlias %}?';
            quicklook_url = quicklook_url + 'activityresource__activity__name__contains=' + label.split(' ')[0];
            //var nwin = window.open(quicklook_url, '', 'height=800,width=1000');
            //if (window.focus) {
                //nwin.focus();
            //}
    }
                
    $("#time-depth-flot").bind("plotclick", function (event, pos, item) {
        // This method of providing quick look plots is annoying as click-n-drag operations will sometimes trigger a plotclick
        if (item) {
            // Crude test whether sample or activity click, activities 2nd element may be '(stride=..'
            //console.log(item.series.label)
            if (item.series.label.split(' ').length == 2) {
                if (item.series.label.split(' ')[1].indexOf('(') == -1) {
                    showSampleData(item.series.label)
                }
                else if (item.series.label.split(' ')[1].indexOf('(') != -1) {
                    // Crude test that we have an activity name
                    showQuickLooks(item.series.label)
                }
            }
        }
    });

    function getDepthDataset(data, x1, x2) {
        // Return a dataset of simpledepthtime for flot for only the data between times x1 and x2
        var dataset = [];
        var platform_seen = [];
        if ( ! data ) {
            return;
        }
        var maxLength = 0;
        $.each(data['platforms'], function (ptype, platforms) {
            $.each(platforms, function (index, platform_value) {
                // Now add each activity for this platform - separated so that they are not connected with a line
                //console.log('Getting sdt for ' + platform_value[0])
                if ( ! $.isEmptyObject(data['simpledepthtime']['sdt'][platform_value[0]]) ) {
                    $.each(data['simpledepthtime']['sdt'][platform_value[0]], function (label, depth_time_series) {
                        var rec = [];
                        //console.log('Checking time for ' + platform_value[0] + ' label = ' + label + ', times between ' + x1 + ' and ' + x2);
                        subset_dts = [];
                        bottomdepth_time_series = [];
                        if ( ! $.isEmptyObject(data.simplebottomdepthtime ) ) {
                            if ( ! $.isEmptyObject(data.simplebottomdepthtime.sbdt[platform_value[0]][label]) ) {
                                bottomdepth_time_series = data.simplebottomdepthtime.sbdt[platform_value[0]][label];
                            }
                        }
                        if ( ! $.isEmptyObject(depth_time_series) ) {
                            // Test for overlap of zoom window with data; push an item to mark this dts being in zoom window
                            d1 = depth_time_series[0][0];
                            d2 = depth_time_series[depth_time_series.length-1][0];
                            if ((x1 <= d2) && (d1 <= x2)){
                                subset_dts.push(depth_time_series[0]);
                            }
                        }
                        if (subset_dts.length > 0) {
                            if (subset_dts.length > maxLength) {
                                maxLength = subset_dts.length;
                            }
                            if (! platform_seen[platform_value[0]]) {
                                //rec["label"] = platform_value[0];
                                platform_seen[platform_value[0]] = true;
                            }
                            //console.log('>>> ' + platform_value[0]);
                            dataset.push({'label': label, 'data': depth_time_series, 'color': "#" + data['simpledepthtime']['colors'][platform_value[0]]});
                            dataset.push({'data': bottomdepth_time_series, 'color': "#lightgrey", 'lines': {lineWidth: 0, fill: true}});
                         }
                    });
                }
            });
        });

        // Add the sample locations, each with a label
        $.each(data['sampledepthtime'], function (index, sample) {
            sample["color"] = "#000000";
            sample["fillColor"] = "#ffffff";
            sample["points"] = {show: true, fill: true, lineWidth: 1};
            sample["lines"] = {show: false};
            sample["hoverable"] = true;
            sample["clickable"] = true;
            dataset.push(sample);
        });
        if (data['sampledepthtime'].length == 0) {
            sample_points.setVisibility(false);         // Turn off sample view openlayers
        }
        else {
            sample_points.setVisibility(true);         // Turn on sample view openlayers
        }

        // Add the sampledurations lines, each with a label
        $.each(data['sampledurationsdepthtime'], function (index, sampledurations) {
            sampledurations["color"] = "#000000";
            sampledurations["fillColor"] = "#ffffff";
            sampledurations["points"] = {show: true, fill: true, lineWidth: 1};
            sampledurations["lines"] = {show: true, lineWidth: 4};
            sampledurations["hoverable"] = true;
            sampledurations["clickable"] = true;
            dataset.push(sampledurations);
        });

        return dataset;

    } // getDepthDataset()

    function getParameterDataset(data, x1, x2) {
        // Return a dataset of parameter time series for flot for only the data between times x1 and x2
        var dataset = [];
        if ( ! data ) {
            return;
        }
        if ( $.isEmptyObject(data.parametertime.pt) ) {
            return;
        }

        var yaxisNumber = {};
        var yaxisCount = 0;
        var yaxesOptions = [];
        var pos;
        $.each(data.parametertime.pt, function (unit, activity_time_series) {
            //console.log('unit = ' + unit);
            //console.log('activity_time_series = ' + activity_time_series);
            $.each(activity_time_series, function (activity, time_series) {
                var hasData = false;
                $.each(time_series, function (index, td) {
                    // Test activity for data between times x1 and x2
                    if (td[0] >= x1 && td[0] <= x2) {
                        hasData = true;
                        return false;
                    }
                });

                if (hasData) {
                    if (! (unit in yaxisNumber)) {
                        yaxisCount = yaxisCount + 1;
                        yaxisNumber[unit] = yaxisCount;
                        if (yaxisNumber[unit] % 2 == 0) {
                            pos = 'right';
                        }
                        else {
                            pos = 'left';
                        }
                        yAxisLabel = data.parametertime.units[unit] + ' (' + unit + ')';
                        yaxesOptions.push({position: pos, axisLabel: yAxisLabel});
                    }
                    dataset.push({'label': activity, 'data': time_series, 'yaxis': yaxisNumber[unit], 'color': data.parametertime.colors[activity.split(' ')[0]]});
                }
            });
        });

        return { 
            'dataset': dataset,
            'yaxesOptions': yaxesOptions
        };

    } // getParameterDataset()

    function collectHistData(histdata, platform, color, activity, histbyactivity) {
        var rec = [];
        rec["label"] = activity;
        rec["color"] = color;
        rec["data"] = histbyactivity['hist'];
        rec["bars"] = { show: true, barWidth: histbyactivity['binwidth'], fill: true, fillColor: color };
        histdata.push(rec);
        return histdata;
    }

    function addSelectedParameterValue(histdata, parameter) {
        var rec = [];
        color = 'rgba(244, 164, 96, 0.2)';
        rec["label"] = 'selection';
        rec["color"] = color;
        //console.log(parametervalues[parameter]);
        rec["data"] = [[parametervalues[parameter]['xmin'], parametervalues[parameter]['ymax']]];
        //console.log(rec['data']);
        binwidth = parametervalues[parameter]['xmax'] - parametervalues[parameter]['xmin'];
        rec["bars"] = { show: true, barWidth: binwidth, fill: true, fillColor: color };
        histdata.push(rec);
        return histdata;
    }
    
    function plotHistData(parameter, histdata, parameterunits) {
        var units = parameterunits[parameter];
        histogram_options_labels = $.extend(true, {}, histogram_options, {
                                                            xaxes: [{
                                                                        axisLabel: parameter + ' (' + units + ')'
                                                                    }],
                                                            yaxes: [{
                                                                        position: 'left',
                                                                        axisLabel: 'Count'
                                                                    }]
                                                                          });
        parameter_idsafe = parameter.replace(/[\s\.\[\]]/g, '_');
        $.plot($("#" + parameter_idsafe + "-histogram-flot"), histdata, histogram_options_labels);
        $("#" + parameter_idsafe + "-histogram-flot").trigger('plotloaded');
    }

    function updateTemporal() {
        var ds = new Date($('body').data()['start-ems']);
        var de = new Date($('body').data()['end-ems']);
        $('body').data()['start-time'] = getUTCDateString(ds); 
        $('body').data()['end-time'] = getUTCDateString(de);

        var tLabel = 'Temporal: ' + $('body').data()['start-time'] + ' to ' + $('body').data()['end-time'];
        var dLabel = 'Depth: ' + $('body').data()['start-depth'] + ' to ' + $('body').data()['end-depth'];
        $('#temporal-anchor').html(tLabel);
        $('#temporal-depth-label').html(dLabel);
    }

    function ZoomIn(event, ranges) {
        // ZoomIn for Temporal-Depth (simpledepthtime) plots
        // clamp the zooming to prevent eternal zoom
        if (ranges.xaxis.to - ranges.xaxis.from < 0.00001)
            ranges.xaxis.to = ranges.xaxis.from + 0.00001;
        if (ranges.yaxis.to - ranges.yaxis.from < 0.00001)
            ranges.yaxis.to = ranges.yaxis.from + 0.00001;

        $('body').data()['start-ems'] = ranges.xaxis.from;
        $('body').data()['end-ems'] = ranges.xaxis.to;
        $('body').data()['start-depth'] = Math.round(ranges.yaxis.from*100)/100;
        $('body').data()['end-depth'] = Math.round(ranges.yaxis.to*100)/100;

        simpledepthtime_options_zoom = $.extend(true, {}, simpledepthtime_options, {
                                                              xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                                                              yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to } 
                                                          });

        zoom_simpledepthtime_stack.push([ $('body').data()['start-ems'], $('body').data()['end-ems'],
                                          $('body').data()['start-depth'], $('body').data()['end-depth'],
                                          simpledepthtime_options_zoom ]);

        // Apply new depth & time ranges to the query and redraw the plot in rebuildFilters()
        $('#zoomed-button').removeClass('disabled'); 
        $('#zoomed-button').addClass('btn-primary');
        //$('#zoomed-button').attr('title', 'Click to unzoom to original extent. Right-click on plot to unzoom to last zoom level.').tooltip('fixTitle').tooltip('hide');

        updateTemporal();
        rebuildFilters();
        $('#time-depth-instr').html('Click and drag to zoom, right-click to un-zoom');

    }

    function ZoomOut(event) {
        // Coordinate temporal zoom level between Depth and Parameter tabs
        if (event.delegateTarget.id == 'time-depth-flot') {
            // Leave inital values on the stack for unzoom button (clear selection) click
            if (zoom_simpledepthtime_stack.length > 1 ) {
                var zoom_sdt = zoom_simpledepthtime_stack.pop();
                // Test for first ZoomOut by comparing existing zoom parameters
                if ( zoom_sdt[0] == $('body').data()['start-ems'] && zoom_sdt[1] == $('body').data()['end-ems'] && 
                     zoom_sdt[2] == $('body').data()['start-depth'] && zoom_sdt[3] == $('body').data()['end-depth'] ){
                    if (zoom_simpledepthtime_stack.length == 1) {
                        zoom_sdt = zoom_simpledepthtime_stack[0];
                    }
                    else {
                        zoom_sdt = zoom_simpledepthtime_stack.pop();
                    }
                }
                $('body').data()['start-ems'] = zoom_sdt[0];
                $('body').data()['end-ems'] = zoom_sdt[1];
                $('body').data()['start-depth'] = zoom_sdt[2];
                $('body').data()['end-depth'] = zoom_sdt[3];
                simpledepthtime_options_zoom = zoom_sdt[4];
            
                updateTemporal();
                rebuildFilters();
            } 
            if (zoom_simpledepthtime_stack.length == 1 ) {
                $('#time-depth-instr').html('Click and drag to zoom');
                // zoom_parametertime_stack gets a push on a tab click, unzoom if length is 0 or 1
                if (!$('#zoomed-button').hasClass('disabled') && zoom_parametertime_stack.length <= 1) {
                    $('#zoomed-button').click();
                }
            }
        }
        else if (event.delegateTarget.id == 'time-parameter-flot') {
            if (zoom_parametertime_stack.length > 1 ) {
                var zoom_pt = zoom_parametertime_stack.pop();
                // Test for first ZoomOut by comparing existing zoom parameters
                if ( zoom_pt[0] == $('body').data()['start-ems'] && zoom_pt[1] == $('body').data()['end-ems'] ) {
                    if (zoom_parametertime_stack.length == 1 ) {
                        zoom_pt = zoom_parametertime_stack[0];
                    }
                    else {
                        zoom_pt = zoom_parametertime_stack.pop();
                    }
                }
                $('body').data()['start-ems'] = zoom_pt[0];
                $('body').data()['end-ems'] = zoom_pt[1];
                parametertime_options_zoom = zoom_pt[4];

                updateTemporal();
                rebuildFilters();
            }
            if (zoom_parametertime_stack.length == 1 ) {
                $('#time-parameter-instr').html('Click and drag to zoom');
                if (!$('#zoomed-button').hasClass('disabled') && zoom_simpledepthtime_stack.length == 1) {
                    $('#zoomed-button').click();
                }
            }
        }

        // return false to suppress the right-mouse context menu from appearing 
        return false;
    }

    $("#time-depth-flot").bind("plotselected", ZoomIn);
    $("#time-depth-flot").bind("contextmenu",  ZoomOut);

    $("#time-parameter-flot").bind("plotselected", function (event, ranges) {
        $('body').data()['start-ems'] = ranges.xaxis.from;
        $('body').data()['end-ems'] = ranges.xaxis.to;

        $('#zoomed-button').removeClass('disabled'); 
        $('#zoomed-button').addClass('btn-primary');

        parametertime_options_zoom = $.extend(true, {}, parametertime_options, {
                                              xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to }
                                              });

        zoom_parametertime_stack.push([ $('body').data()['start-ems'], $('body').data()['end-ems'],
                                        $('body').data()['start-depth'], $('body').data()['end-depth'],
                                        parametertime_options_zoom ]);

        updateTemporal();
        if ($('#showplatforms').is(':checked')) {
            rebuildFilters(['parametertime', 'parameterparameterpng', 'parameterparameterx3d', 'measuredparameterx3d', 'platformanimation']);
        }
        else {
            rebuildFilters(['parametertime', 'parameterparameterpng', 'parameterparameterx3d', 'measuredparameterx3d']);
        }
        $('#time-parameter-instr').html('Click and drag zoom, right-click to un-zoom');
    });
    $("#time-parameter-flot").bind("contextmenu",  ZoomOut);


    /*
     * Perform the AJAX call to get a list of parametername and parameterstandardname, and enable/disable them
     * If "init" is true then this is the initial page load, and we need to populate the fields rather than toggle them.
     */
    function updateSummaryData(init) {
        var init = typeof init !== 'undefined' ? init : false;
        $('body').data()['init'] = init;
        var qstring=($.param($.map(params, function(v, k) { return ($.type(v) === "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })));
        if ($('#getactualcount').is(':checked')) {
            qstring = qstring + '&get_actual_count=1';
        }
        if ($('#showsigmatparametervalues').is(':checked')) {
            qstring = qstring + '&showsigmatparametervalues=1';
        }
        if ($('#showstandardnameparametervalues').is(':checked')) {
            qstring = qstring + '&showstandardnameparametervalues=1';
        }
        if ($('#showallparametervalues').is(':checked')) {
            qstring = qstring + '&showallparametervalues=1';
        }

        // Plotting options are separate from the filters - so set them here rather than in rebuildFilters()
        // Add to query string if that tab is active, do one OR the other, not both
        if ( $('input:radio[name=parameters_plot]').is(':checked') ) {
            if ($('#temporal-depth-li').hasClass('active')) {
                if ( $('input:radio[name=parameters_plot]:checked').val() ) {
                    qstring = qstring + '&parameterplotid=' + $('input:radio[name=parameters_plot]:checked').val();
                    qstring = qstring + '&platformplotname=' + $('body').data()['parameterplatforms'][$('input:radio[name=parameters_plot]:checked').val()];
                    if ($('input:radio[name=showdataas]:checked').val()) {
                        qstring = qstring + '&showdataas=' + $('input:radio[name=showdataas]:checked').val();
                    }
                }
            }
        }
        if ( $('input:checkbox[name=parameters_plot_cb]').is(':checked') ) {
            if ($('#temporal-parameter-li').hasClass('active')) {
                $('input:checked[name=parameters_plot_cb]').each(function (index, elem) {
                    qstring = qstring + '&parametertimeplotid=' + elem.value;
                });
                if ( $('input:radio[name=parameters_plot]:checked').val() ) {
                    // Send parameterplotid if on Parameter tab so that Spatial pane updates
                    qstring = qstring + '&parameterplotid=' + $('input:radio[name=parameters_plot]:checked').val();
                    qstring = qstring + '&platformplotname=' + $('body').data()['parameterplatforms'][$('input:radio[name=parameters_plot]:checked').val()];
                }
            }
        }

        if ($('#showgeox3dmeasurement').is(':checked') || $('#showplatforms').is(':checked')) {
            if ($('#showgeox3dmeasurement').is(':checked')) {
                qstring += '&showgeox3dmeasurement=1';
            }
            if ($('#showplatforms').is(':checked')) {
                qstring += '&showplatforms=1';
            }
            if ($('body').data()['ve']) {
                qstring += '&ve=' + $('body').data()['ve'];
            }
            if ($('body').data()['geoorigin']) {
                qstring += '&geoorigin=' + $('body').data()['geoorigin'];
            }
        }
        if ($('#pp-linear-regression').is(':checked')) {
            qstring = qstring + '&pplr=1';
        }
        if ($('#pp-free-range').is(':checked')) {
            qstring = qstring + '&ppfr=1';
        }
        if ($('#pp-sample-locations').is(':checked')) {
            qstring = qstring + '&ppsl=1';
        }

        if ( ! $('#showallparametervalues').is(':checked')) {
            //$('#parameter-value-table').html('<tbody></tbody>');
        }
        if (! init) {
            if (request.readyState < 3) {
                // Happens when response not received
                request.abort();
                $('#time-depth-flot').addClass('stoqs-background-ajax-loader-pulse ');
                $('#time-parameter-flot').addClass('stoqs-background-ajax-loader-pulse ');
            }
        }
        var me = this;

        function buildMetadataHtml(data, init) {
                // Sort the Activities by platform and build HTML for NetCDF tab
                var platforms = $.map(data.resources.netcdf, function(activities, plat) {return plat}).sort();
                var platformActivitiesHtml = '<fieldset>';
                platformActivitiesHtml += '<input type="checkbox" name="all_activity_select_cb" value="" class="activity-select-checkbox checkall_activity" />' +
                                          ' Check/Uncheck all for Spatial Temporal plotting (leave this section open for selections to apply)'; 
                $.each(platforms, function (index, plat) {
                    var activities = $.map(data.resources.netcdf[plat], function(activities, a) {return a}).sort();
                    platformActivitiesHtml += '<div id="' + plat + '-group" class="accordian-group">' +
                    '<div class="accordian-heading">' + 
                       '<h5><a id="' + plat + '-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#platform-anchor" href="#collapse-' + plat + '">' + 
                        plat + 
                        '</a></h5>' + 
                    '</div>' + 
                    '<div id="collapse-' + plat + '" class="accordion-body collapse in">' + 
                        '<div class="accordion-inner" style="padding:0;">';

                    for (var i = 0; i < activities.length; i++) {
                        var activity = activities[i];
                        var attributes = data.resources.netcdf[plat][activity];
                        var dsLink = activity;
                        if (attributes.opendap_url) {
                            dsLink = '<input type="checkbox" name="activity_select_cb" value="' + activity + '" class="activity-select-checkbox" style="margin:0px;"/> ';
                            dsLink += '<a target="_blank" href="' + attributes.opendap_url + '.html">';
                            dsLink += '<span style="overflow:hidden;text-overflow:ellipsis;display:block;">' + activity + '</span></a>';
                        }
                        var title = attributes.title;
                        var summary = attributes.summary;
                        if ( $.isEmptyObject(title) ) {
                            title = '(No title in NetCDF file)';
                        }
                        if ( $.isEmptyObject(summary) ) {
                            summary = '(No summary in NetCDF file)';
                        }
                        platformActivitiesHtml += '<div class="row-fluid">' +
                            '<div class="span3">' + dsLink + '</div>' +
                            '<div class="span3"><br><span style="overflow:hidden;text-overflow:ellipsis;display:block;white-space:normal;">' + title + '</span></div>' +
                            '<div class="span3"><br><span style="overflow:hidden;text-overflow:ellipsis;display:block;white-space:normal;">' + summary + '</span></div>' +
                            '<div class="span3"><br><span style="overflow:hidden;text-overflow:ellipsis;display:block;white-space:normal;">' + attributes.comment + '</span></div>' +
                            '</div>';
                    }
                    platformActivitiesHtml += '</div></div></div></fieldset>';
                });
                $('#metadatanetcdf > div').html(platformActivitiesHtml);

                // Check the Activities that need checking and initialize checkbox state in $('body').data()
                if ( init ) {
                    $('body').data()['activitynames'] = {};
                    $('input[name=activity_select_cb]').prop('checked', true);
                    $('input[name=all_activity_select_cb]').prop('checked', true);
                    $.each(data.resources.netcdf, function (plat, activities) {
                        $.each(activities, function (name, activity) {
                            $('body').data()['activitynames'][name] = true;
                        });
                    });
                }
                else {
                    if ( ! $.isEmptyObject($('body').data()['activitynames']) ) {
                        $.each($('body').data()['activitynames'], function (activityname, checked) {
                            if (checked) {
                                $('input[name=activity_select_cb][value="' + activityname + '"]').prop('checked', true);
                            }
                            else {
                                $('input[name=activity_select_cb][value="' + activityname + '"]').prop('checked', false);
                            }
                        });
                    }
                }

                // Sort the QuickLook plot URLs by platform and build HTML for Quick look plots tab
                var platforms = $.map(data.resources.quick_look, function(activities, plat) {return plat}).sort();
                var platformActivitiesHtml = '';
                $.each(platforms, function (index, plat) {
                    activities = $.map(data.resources.quick_look[plat], function(activities, a) {return a}).sort();
                    platformActivitiesHtml += '<div id="' + plat + '-group" class="accordian-group">' +
                    '<div class="accordian-heading">' + 
                       '<h5><a id="' + plat + '-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#platform-anchor" href="#collapse-' + plat + '">' + 
                        plat + 
                        '</a></h5>' + 
                    '</div>' + 
                    '<div id="collapse-' + plat + '" class="accordion-body collapse in">' + 
                        '<div class="accordion-inner" style="padding:0;">';
                    platformActivitiesHtml += '<table class="table table-condensed"><tbody>';

                    for (var i=0; i<activities.length; i++) {
                        activity = activities[i];
                        plots = data.resources.quick_look[plat][activity];
                        platformActivitiesHtml += '<tr id="' + activity +'">' +
                                '<td>' + activity + '</td>';
                        $.each(plots, function (type, url) {
                            if ( ! url == '' ) {
                                platformActivitiesHtml += '<td><a target="_blank" href="' + url + '">' + type + '</a></td>';
                            }
                        });
                        platformActivitiesHtml += '</tr>';
                    }
                    platformActivitiesHtml += '</tbody></table></div></div></div>';
                });
                if ( platformActivitiesHtml == '' ) {
                    $('#metadata-qlp-li').hide()
                }
                else {
                    $('#metadata-qlp-li').show()
                    $('#metadataquicklookplots > div').html(platformActivitiesHtml);
                }

                // Register event handler here as it is not recognized where the others are located in this file
                $('.checkall_activity').on('click', function () {
                    $.each(data.resources.netcdf, function (plat, activities) {
                        $.each(activities, function (name, activity) {
                            if ( $('.checkall_activity').is(':checked') ) {
                                $('body').data()['activitynames'][name] = true;
                                $('input[name=activity_select_cb][value="' + name + '"]').prop('checked', true);
                            }
                            else {
                                $('body').data()['activitynames'][name] = false;
                                $('input[name=activity_select_cb][value="' + name + '"]').prop('checked', false);
                            }
                        });
                    });
                    // 'change' event handler on .activity-select-checkbox handles calling rebuildFilters()
                });
        } // End buildMetadataHtml()

        function saveBodyData(data) {
            // Save the dictionary in the body so that asynchronous event handlers can get at it
            $.each(['parameterplatforms', 'parameterminmax', 'platformColors', 'platformFeatureTypes', 'counts'], function(index, key) {
                if ( ! $.isEmptyObject(data[key]) ) {
                    $('body').data(key, data[key]);
                }
            });
            if ( ! $.isEmptyObject(data.platforms) ) {
                // Save platform colors and featureTypes for lookup
                var platformColors = {}
                var platformFeatureTypes = {}
                $.each(data.platforms, function (type, list) {
                    $.each(list, function (index, value) {
                        platformColors[value[0]] = value[2];
                        platformFeatureTypes[value[0]] = value[3];
                    });
                });
                $('body').data('platformColors', platformColors);
                $('body').data('platformFeatureTypes', platformFeatureTypes);
            }
        }

        function onInit(data, key) {
            // Called from ajax on initial request
            initData = data;
            $('.p-info').tooltip('fixTitle').tooltip('hide');
            if (key == 'platforms') {
                hasTrajectory = false;
                hasTimeSeries = false;
                hasTimeSeriesProfile = false;
                hasTrajectoryProfile = false;
                platformTypeHtml = '';
                $('body').data()['platformModels'] = {};

                // Sort the platformTypes for display
                platformTypes = $.map(data[key], function(platforms, ptype) {return ptype}).sort();
                $.each(platformTypes, function (index, ptype) {
                    platforms = data[key][ptype];
                    platformTypeHtml += '<div id="' + ptype + '-group" class="accordian-group">' +
                    '<div class="accordian-heading">' + 
                       '<h5><a id="' + ptype + '-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#platform-anchor" href="#collapse-' + ptype + '">' + 
                        ptype + 
                        '</a></h5>' + 
                    '</div>' + 
                    '<div id="collapse-' + ptype + '" class="accordion-body collapse in">' + 
                        '<div class="accordion-inner" style="padding:0;">';
                    platformTypeHtml += '<table class="table table-condensed stoqs-platform"><tbody>';

                    $.each(platforms, function (index, value) {
                        platformTypeHtml += '<tr id="' + value[1] +'"><td style="text-align:center;width:15%;border-top-width:0;">' +
                                '<div id="' + value[1] + '_icon" style="text-align: center;float:left;width:90%;height:20px;background-color: rgb(192, 211, 228)">' +
                                    '<div id="' + value[1] + '_color" style="border-bottom:2px solid;width:90%;height:9px;margin-left:auto;margin-right:auto;border-bottom-color:#' + 
                                        data['simpledepthtime']['colors'][value[1]] + ';">' +
                                '</div></div></td>' +
                                '<td style="text-align:center;width:5%;border-top-width:0;">' +
                                    '<input type="checkbox" name="platforms_plot" value="' + value[1] + '" class="platform-plot-map-checkbox" style="display:none;" />' +
                                '</td>' +
                                '<td style="text-align:center;width:5%;border-top-width:0;">' +
                                    '<input type="radio" name="platforms_plot_cb" value="' + value[1] + '" class="platform-plot-section-radio" style="display:none;" />' +
                                '</td>' +
                                '<td style="width:75%;border-top-width:0;"><button class="btn btn-mini stoqs-toggle platform" style="float:left;">'+ value[0] +'</button></td>' +
                            '</tr>';
                        $('#' + value[1] + '_icon').click( function () { $('#' + value[1] + ' > td > button').click() } );
                        if (value[3].toLowerCase() == 'trajectory') {
                            hasTrajectory = true;
                        }
                        if (value[3].toLowerCase() == 'timeseries') {
                            hasTimeSeries = true;
                        }
                        if (value[3].toLowerCase() == 'timeseriesprofile') {
                            hasTimeSeriesProfile = true;
                        }
                        if (value[3].toLowerCase() == 'trajectoryprofile') {
                            hasTrajectoryProfile = true;
                        }
                        if ( value[3].toLowerCase() == 'timeseries' || value[3].toLowerCase() == 'timeseriesprofile') {
                            if ( ! $.isEmptyObject(value[4]) ) {
                                // We have a model, expect to have x, y, and z coordinates to follow
                                $('body').data()['platformModels'][value[1]] = [value[4], value[5], value[6], value[7]];
                            }
                        }
                    });
                    platformTypeHtml += '</tbody></table></div></div></div>';

                });
                $('#collapsePlatforms > div').append(platformTypeHtml);
            }
            else if (key == 'sampledparametersgroup') {
                if ( ! $.isEmptyObject(data[key]) ) {
                    $('#sampledparameters-anchor').parent().parent().parent().show();
                    $('#sp-data-access-anchor').parent().parent().parent().show();
                }
                var parameterButtonText = '';
                var sp_ids = [];
                var pi_url;
                var pi_url_base = "{% url 'stoqs:parameterinfo' dbAlias=request.META.dbAlias pid='REPLACE' %}";
                $.each(data[key], function (index, value) {
                    // Save ids in list for assigning as a data item on Sampled Parameters for easy lookup
                    sp_ids.push(value[2].toString()); 
                    pi_url = pi_url_base.replace('REPLACE', value[2]);
                    // Use [2], the id for sampledparameters to allow wierd characters in [0], the name
                    parameterButtonText = parameterButtonText + '<tr>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_x" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_y" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_z" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_c" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;">' +
                                '<input type="radio" name="parameters_plot" value="' + value[2] + '" class="parameter-plot-radio" />' +
                                '<input type="checkbox" name="parameters_plot_cb" value="' + value[2] + '" class="parameter-plot-checkbox" style="display:none;" />' +
                            '</td>' +
                            '<td style="width:1%">' +
                                '<span title="' + value[4] + '. ' + value[1] + '. ' + value[5] + '. ' + value[6] + '" class="p-info">' +
                                    '<i class="icon-info-sign"></i>' +
                                '</span>' +
                            '</td>' +
                            '<td id="' + value[2] +'" style="text-align:center;">' +
                                '<button class="btn btn-mini stoqs-toggle sampledparametersgroup">'+ value[0] +'</button>' + 
                            '</td>' +
                            '<td style="width:1%">' +
                                '<span id="' + value[0] + '_plats" style="background-color:rgb(192, 211, 228);"></span>' + 
                            '</td>';
                    if (value[1].length != 0) {
                        // Append '--' + value[0] + '-sn' to the id to distinguish them from parameter names that have the same standard_name
                        // A bit of a kludge, but should be robust as CF standard_names do not contain dashes
                        parameterButtonText = parameterButtonText +
                        '<tr style="display:none;">' +
                            '<td id="' + value[1] + '--' + value[0] + '-sn" style="border-color: transparent;">' +
                                '<button class="btn btn-mini stoqs-toggle sampledparameterstandardname">'+ value[1] +'</button>' + 
                            '</td>' +
                        '</tr>';
                    }
                    parameterButtonText = parameterButtonText + '</tr>';
                });
                $('#sampledparameters-anchor').data('ids', sp_ids);
                parameterButtonText = parameterButtonText + '';
                $('#sampledparameter-table > tbody:last').append(parameterButtonText);
                $.each(data[key], function (index, value) {
                    addPlatformSymbols($('#' + value[0] + '_plats'), value[2]);                                 // show which platforms have this parameter
                });
            }
            else if (key == 'measuredparametersgroup') {
                var parameterButtonText = '';
                var mp_ids = [];
                var pi_url;
                var pi_url_base = "{% url 'stoqs:parameterinfo' dbAlias=request.META.dbAlias pid='REPLACE' %}";
                $.each(data[key], function (index, value) {
                    // Save ids in list for assigning as a data item on Sampled Parameters for easy lookup
                    mp_ids.push(value[2].toString()); 
                    pi_url = pi_url_base.replace('REPLACE', value[2]);
                    parameterButtonText = parameterButtonText + '<tr>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_x" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_y" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_z" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;display:none;">' +
                                '<input type="radio" name="parameters_c" value="' + value[2] + '" class="parameter-radio" />' +
                            '</td>' +
                            '<td style="text-align:center;">' +
                                '<input type="radio" name="parameters_plot" value="' + value[2] + '" class="parameter-plot-radio" />' +
                                '<input type="checkbox" name="parameters_plot_cb" value="' + value[2] + '" class="parameter-plot-checkbox" style="display:none;"/>' +
                            '</td>' +
                            '<td style="width:1%">' +
                                '<span title="' + value[4] + '. ' + value[1] + '. ' + value[5] + '. ' + value[6] + '" class="p-info">' +
                                    '<i class="icon-info-sign"></i>' +
                                '</span>' +
                            '</td>' +
                            '<td id="' + value[0] +'">' +
                                '<button class="btn btn-mini stoqs-toggle measuredparametersgroup">'+ value[0] +'</button>' + 
                            '</td>' + 
                            '<td style="width:1%">' +
                                '<span id="' + value[0] + '_plats" style="background-color:rgb(192, 211, 228);"></span>' + 
                            '</td>';
                    if (value[1].length != 0) {
                        // Append '--' + value[0] + '-sn' to the id to distinguish them from parameter names that have the same standard_name
                        // A bit of a kludge, but should be robust as CF standard_names do not contain dashes
                        // Change colspan to 5 when Parameter-Parameter radio buttons are shown
                        parameterButtonText = parameterButtonText +
                        '<tr style="display:none;">' +
                            '<td colspan="1" style="text-align:center;border-color:transparent;" class="sn-leader"></td>' +
                            '<td id="' + value[1] + '--' + value[0] + '-sn" style="border-color:transparent;text-align:center;">' +
                                '<button class="btn btn-mini stoqs-toggle parameterstandardname" style="width:75%;">'+ value[1] +'</button>' + 
                            '</td>' +
                        '</tr>';
                    }
                    parameterButtonText = parameterButtonText + '</tr>';
                });

                $('#measuredparameters-anchor').data('ids', mp_ids);
                $('#measuredparameter-table > tbody:last').append(parameterButtonText);
                $.each(data[key], function (index, value) {
                    addPlatformSymbols($('#' + value[0] + '_plats'), value[2]);                                 // show which platforms have this parameter
                });
            }
            else if (key == 'simpledepthtime') {
                //flotPlot(data)
                var start = new Date(data['time'][0]);
                var end = new Date(data['time'][1]);
                simpledepthtime_options_zoom = simpledepthtime_options;
                timedepthplot = $.plot($("#time-depth-flot"), getDepthDataset(initData, start.getTime(), end.getTime()), 
                                                              simpledepthtime_options_zoom);
            }
            else if (key == 'parametertime') {
                // Just check the count and enable tab if not 0
                if (data.parametertime.counts != 0) {
                    $("#temporal-parameter-li").show();
                }
            }
            else if (key == 'x3dterrains') {
                function get_tname(terrain, item) {
                    if ( $.isEmptyObject(item.name) ) {
                        // Support legacy DBs w/o short name assigned
                        tname = terrain.substr(terrain.lastIndexOf('/') + 1);
                    }
                    else {
                        tname = item.name
                    }
                    // Could use a more rigourous regex for legal id names...
                    tname = tname.replace(/[\+\.]+/g, '');
                    return tname;
                }
                // Save all the terrains for selection in terrain-3d
                $('body').data()['terrains'] = data['x3dterrains'];
                if ( ! $.isEmptyObject(data[key]) ) {
                    // Only a single terrain is supported for now
                    $.each(data[key], function (terrain, item) {
                        var tname = get_tname(terrain, item);
                        $('#terrain3D-choices').append('<input type="radio" name="terrain_view" class="terrain-view" style="margin:3px;" value="' + terrain + '"/>' +
                                            '<label class="checkbox" style="padding:0px;">' +
                                            '<input type="checkbox" style="margin:3px;" name="terrain_choice" class="terrain-choice"' + 
                                            ' value="' + terrain + '"/>' + tname + '</label><br>');
                        $('#mp-x3d-terrain').append('<Inline id="terrain-' + tname + '"></Inline>');
                        $('#terrain-' + tname).attr('url', terrain);
                    });
                    $('#terrain3D-choices').append(' * radio button selects viewpoint for the terrain');
                    $('#spatial-3d-li').show();

                    // Register listeners for terrain selections
                    $('.terrain-choice').on('click', function (event) {
                        $('input[name=terrain_choice]').each(function (index, elem) {
                            tname = get_tname(elem.value, $('body').data()['terrains'][elem.value]);
                            if (elem.checked) {
                                $('#terrain-' + tname).attr('render', 'true');
                            }
                            else {
                                $('#terrain-' + tname).attr('render', 'false');
                            }
                        });
                    });
                    $('input[name="terrain_view"]').on('click', function (event) {
                        var item = $('body').data()['terrains'][event.delegateTarget.value];
                        $('#spatial-3d-x3d > Scene > NavigationInfo').attr('speed', item.speed);
                        $('#mp-x3d-viewpoint1').attr('centerOfRotation', item.centerOfRotation);
                        $('#mp-x3d-viewpoint1').attr('position', item.position);
                        $('#mp-x3d-viewpoint1').attr('orientation', item.orientation);
                        $('#mp-x3d-viewpoint1').attr('zNear', item.zNear);
                        $('#mp-x3d-viewpoint1').attr('zFar', item.zFar);
                        if ( ! $.isEmptyObject(item.geoOrigin) ) { 
                            var geoOrigin_def = '<GeoOrigin def="GO" geoSystem=\'"GD" "WE"\' geoCoords="' + item.geoOrigin + '" ';
                            geoOrigin_def += ' rotateYUp="true" elevationScaling="true"></GeoOrigin>' ;
                            $('#mp-x3d-geoviewpoint1').append(geoOrigin_def);
                            $('body').data()['geoorigin'] = item.geoOrigin;
                            $('body').data()['geoorigin_use'] = '<GeoOrigin use="GO"></GeoOrigin>';
                            $('#spatial-3d-root > Group > GeoOriginTransform').append($('body').data()['geoorigin_use']);
                        }
                        else {
                            $('body').data()['geoorigin_use'] = '';
                        }
                        if ( ! $.isEmptyObject(item.VerticalExaggeration) ) {
                            $('#x3d-ve').text('Vertical Exaggeration: ' + item.VerticalExaggeration + 'x');
                            $('body').data()['ve'] = item.VerticalExaggeration;
                        }
                    });

                    // Activate the selected terrain(s) and view
                    var terrain_selected = false;
                    $.each(data[key], function (terrain, item) {
                        if ( ! $.isEmptyObject(item.selected) ) {
                            // Last selection will have radio button checked after ondownloadsfinished
                            $('input[name=terrain_choice][value="' + terrain + '"]').prop('checked', true);
                            $('body').data()['terrain_view'] = terrain;
                            terrain_selected = true;
                        }
                        else {
                            $('#terrain-' + tname).attr('render', 'false');
                        }
                    });
                    if ( ! terrain_selected ) {
                        $.each(data[key], function (terrain, item) {
                            // Select first terrain in the list if selected not specified (legacy support)
                            $('input[name=terrain_choice][value="' + terrain + '"]').prop('checked', true);
                            $('body').data()['terrain_view'] = terrain;
                            tname = get_tname(terrain, $('body').data()['terrains'][terrain]);
                            $('#terrain-' + tname).attr('render', 'true');
                            return false;
                        });

                    }
                }
            }
            else if (key == 'x3dplaybacks') {
                if ( ! $.isEmptyObject(data[key]) ) {
                    $.each(data[key], function (modelurl, item) {
                        var playbackX3D = "<GeoLocation geoSystem='GD' geoCoords='" + item.startGeoCoords + "'>";
                        playbackX3D += "<inline url='" + modelurl + "'></inline>" + $('body').data()['geoorigin_use'];
                        playbackX3D += "</GeoLocation>";
                        $('#spatial-3d-x3d > Scene').append(playbackX3D);
                    });
                }
            }
            else if (key == 'resources') {
                buildMetadataHtml(data, true);
            }
            else if (key == 'attributes') {
                if ( ! $.isEmptyObject(data[key]) ) {
                    if ( ! $.isEmptyObject(data[key]['measurement']) ) {
                        $('#attributes-anchor').parent().parent().parent().show();
                        labelTypeHtml = '<div style="font-style:italic;font-weight:bold;">Filter by labeled Measured Parameter (co-located measurements remain in selection)</div>';
                        labelTypes = $.map(data[key]['measurement'], function(labels, labelType) {return labelType}).sort();
                        $.each(labelTypes, function (index, labelType) {
                            if (labelType != 'commandlines') {
                                labels = data[key]['measurement'][labelType];
                                labelTypeID = labelType.replace(/ /g, '-');
                                labelTypeHtml += '<div id="' + labelType + '-group" class="accordian-group">' +
                                '<div class="accordian-heading">' + 
                                '<h5><a id="' + labelType + '-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#attributes-anchor" href="#collapse-' + 
                                    labelTypeID + '">' + labelType + 
                                    '</a></h5>' + 
                                '</div>' + 
                                '<div id="collapse-' + labelTypeID + '" class="accordion-body collapse in">' + 
                                    '<div class="accordion-inner" style="padding:0;">';
                                labelTypeHtml += '<table class="table table-condensed stoqs-attributes"><tbody>';
                                labelTypeHtml += '<tr><td>Source</td><td style="font-family:monospace;font-size:xx-small;">' + 
                                                        data[key]['measurement']['commandlines'][labelType] + '</td></tr>';
                                $.each(labels, function (index, label) {
                                    labelTypeHtml += '<tr id="' + label[0] +'">' +
                                                     '<td><button class="btn btn-mini stoqs-toggle attributes">'+ label[1] +'</button></td>' +
                                                     '<td>'+ label[2] +'</td>' +
                                                     '</tr>';
                                });
                                labelTypeHtml += '</tbody></table></div></div></div>';
                            }
                        });
                        $('#amp > div').append(labelTypeHtml);
                    }
                }
            }
        
        } // onInit()

        function redrawSimpleDepthTime(data) {
                var theData;
                // Redraw the plot given the saved values
                if ( $.isEmptyObject(data.simpledepthtime.sdt) ) {
                    if (! $.isEmptyObject(data.parametertime.pt) ) {
                        // Show parameter-time data if no trajectory data shown 
                        // TODO: perhaps better to do with an event listener on presence of data in the flot object
                        $('#temporal-parameter-li').show();
                    }
                    else if (! data.counts.approximate_count) {
                        alert('No data in your selection.  Clear the Temporal selection and try again.');
                    }
                    return;
                }
                if ( $('#zoomed-button').hasClass('btn-primary') ) {
                    theData = getDepthDataset(data, $('body').data()['start-ems'], $('body').data()['end-ems']);
                }
                else {
                    //theData = getDepthDataset(data, initData.time[0], initData.time[1]);
                    var zoom_sdt = zoom_simpledepthtime_stack[0];
                    theData = getDepthDataset(data, zoom_sdt[0], zoom_sdt[1]);
                }
                var options = simpledepthtime_options_zoom;
                if ( ! $.isEmptyObject($('body').data()['platformAnimation']) ) {
                    options = $.extend(true, {}, simpledepthtime_options_zoom, { crosshair: { mode: "x" } });
                }
                timedepthplot = $.plot($("#time-depth-flot"), theData, options);

        } // redrawSimpleDepthTime()


        function redrawParameterTime(data) {
            if ( data.parametertime.counts != 0 ) {
                $("#temporal-parameter-li").show();
                parmData = getParameterDataset(data, $('body').data()['start-ems'], $('body').data()['end-ems']);
                if ( $.isEmptyObject(parmData) ) {
                    return;
                }
                var options = $.extend(true, {}, parametertime_options, {
                                                          yaxes: parmData.yaxesOptions
                                      });
                var len = parmData.dataset.length;
                if ( ! $.isEmptyObject($('body').data()['platformAnimation']) ) {
                    options = $.extend(true, {}, options, { crosshair: { mode: "x" } });
                }
                timeparameterplot = $.plot($("#time-parameter-flot"), parmData.dataset, options);

                $.each(timeparameterplot.getData(), function(index, series) {
                    // TODO: color the lables
                    series.label;
                    series.color;
                });
                if ( ! $.isEmptyObject(data.parametertime.strides) ) {
                    $('#stride-info').html('');
                    var i = 0;
                    var not_listed = 0;
                    $.each(data.parametertime.strides, function(p, act_value) {
                        $.each(act_value, function(act, value) {
                            i = i + 1;
                            if (i <= 3) {
                                ordinal = getValueOrdinal(value);
                                $('#stride-info').append('<b>' + p + '</b>: every ' + ordinal + ' point from ' + act + '<br>');
                            }
                            else {
                                not_listed = not_listed + 1;
                            }
                        });
                    });
                    if (not_listed > 0) {
                        $('#stride-info').append('...<b>' + not_listed + '</b> more parameters not listed...<br>');
                    }
                }
                // Event data shown in plot may be inside original start-ems and end-ems bounds requested, update display with actual
                var sd = getUTCDateString(new Date(timeparameterplot.getXAxes()[0].datamin));
                var ed = getUTCDateString(new Date(timeparameterplot.getXAxes()[0].datamax));
                $('#temporal-anchor').html('Temporal: ' + sd + ' to ' + ed);
                
                // Add initial view to zoom stack
                if (zoom_parametertime_stack.length == 0) {
                    parametertime_options_zoom = $.extend(true, {}, parametertime_options, {
                                                            xaxis: { min: timeparameterplot.getXAxes()[0].datamin, 
                                                                     max: timeparameterplot.getXAxes()[0].datamax }
                                                          });
                    zoom_parametertime_stack.push([ timeparameterplot.getXAxes()[0].datamin, timeparameterplot.getXAxes()[0].datamax, 
                                                    $('body').data()['start-depth'], $('body').data()['end-depth'],
                                                    parametertime_options_zoom ]);
                }
            }
            else {
                $("#temporal-parameter-li").hide();
            }
        } // redrawParameterTime()

        function startWaitIndicators() {
            $('#time-depth-flot').addClass('stoqs-background-ajax-loader-pulse ');
            $('#time-parameter-flot').addClass('stoqs-background-ajax-loader-pulse ');
            $('#parameter-parameter-2dplot').addClass('stoqs-background-ajax-loader-pp ');
            $('#parameter-parameter-3dplot').addClass('stoqs-background-ajax-loader-3d ');
            $('#geo-3dplot').addClass('stoqs-background-ajax-loader-3d-topright ');
            $('#metadata-ajaxtime').css( { 'color': 'grey' } );
            $('#metadata-loading').html(" loading...");
        }

        function resetWaitIndicators() {
            $('#time-depth-flot').removeClass('stoqs-background-ajax-loader-pulse ');
            $('#time-parameter-flot').removeClass('stoqs-background-ajax-loader-pulse ');
            $('#parameter-parameter-2dplot').removeClass('stoqs-background-ajax-loader-pp ');
            $('#parameter-parameter-3dplot').removeClass('stoqs-background-ajax-loader-3d');
            $('#geo-3dplot').removeClass('stoqs-background-ajax-loader-3d-topright');

            var endAjax = new Date().getTime();
            var nsecs = (endAjax - startAjax) / 1000.0;
            if (! $.isEmptyObject($('body').data()) ) {
                if ( ! $.isEmptyObject($('body').data()['counts']) ) {
                    if ( ! $('#getactualcount').is(':checked') ) {
                        $('#metadata-count').html("about " + $('body').data()['counts'].approximate_count_localized + " data values - ");
                    }
                    else {
                        $('#metadata-count').html(data.counts.actual_count_localized + " data values - ");
                    }
                }
            }
            else {
                // No data implies error - this should not happen. Check server log for Exception and reload page.
                $('#metadata-count').html(" <span class='fail-text'>AJAX request for summary data failed</span> - ");
            }
            $('#metadata-ajaxtime').css( { 'color': 'black' } );
            $('#metadata-ajaxtime').html(" " + nsecs + " seconds");
            $('#metadata-loading').html("");
        } //resetWaitIndicators()


        function onUpdate(data, key) {
            // Called from ajax to update the selectors base on the new selection
            if (key == 'platforms') {
                hasTrajectory = false;
                hasTimeSeries = false;
                hasTimeSeriesProfile = false;
                hasTrajectoryProfile = false;
                var ids=[];
                $.each(data[key], function (ptype, platforms) {
                    $.each(platforms, function (index, value) {
                        // Here we need to enable those that are still valid.
                        var element=$('#' + value[1]);
                        enableButton($('button', element));             // enable the button in the table row
                        ids.push(value[1]);
                        if (value[3].toLowerCase() == 'trajectory') {
                            hasTrajectory = true;
                        }
                        if (value[3].toLowerCase() == 'timeseries') {
                            hasTimeSeries = true;
                        }
                        if (value[3].toLowerCase() == 'timeseriesprofile') {
                            hasTimeSeriesProfile = true;
                        }
                        if (value[3].toLowerCase() == 'trajectoryprofile') {
                            hasTrajectoryProfile = true;
                        }
                    });
                });
                $('.stoqs-platform > tbody > tr').each(function (index, elem) {     
                    if ($.inArray((elem.id).toString(), ids) == -1) {       
                        disableButton($('button', $(elem)));        // disable the button in the table row      
                    }       
                });
            }
            else if (key == 'sampledparametersgroup') {
                var ids=[];
                $.each(data[key], function (index, value) {
                    // Here we need to enable those that are still valid, convert int id to string
                    enableButton($('button', '#' + value[2]));                                                  // enable the button in the table row
                    enableXYZColorPlot($('input:radio', $('button', '#' + value[2]).parent().parent()));        // enable the X, Y, Z, Color, Plot radio buttons in the row
                    enableXYZColorPlot($('input:checkbox', $('button', '#' + value[2]).parent().parent()));     // enable the Plot checkbox in the row
                    enableParameterRow($('button', '#' + value[2]).parent().parent());                          // enable and show the whole row 
                    addPlatformSymbols($('#' + value[0] + '_plats'), value[2]);                                 // show which platforms have this parameter
                    ids.push(value[2].toString());
                });
                $('#sampledparameter-table > tbody > tr > td > button').each(function (index, elem) { 
                    if (elem.parentNode.id.length != 0) {
                        if ($.inArray(elem.parentNode.id.toString(), ids) == -1) {
                            disableButton($(elem));                                                         // disable the button in the table row
                            disableXYZColorPlot($('input:radio', $(elem).parent().parent()));               // disable the X, Y, Z, Color, Plot radio buttons in the row
                            disableXYZColorPlot($('input:checkbox', $(elem).parent().parent()));            // disable the Plot checkbox in the row
                            disableParameterRow('sp', $(elem).parent().parent());                           // disable the whole row and hide unless show-filtered-parameters is checked
                        }
                    }
                });
            }
            else if (key == 'measuredparametersgroup') {
                var ids=[];
                $.each(data[key], function (index, value) {
                    // Here we need to enable those that are still valid
                    enableButton($('button', '#' + value[0]));      // enable the name button in the table row
                    enableXYZColorPlot($('input:radio', $('button', '#' + value[0]).parent().parent()));        // enable the X, Y, Z, Color radio buttons in the row
                    enableXYZColorPlot($('input:checkbox', $('button', '#' + value[0]).parent().parent()));     // enable the Plot checkbox in the row
                    enableParameterRow($('button', '#' + value[0]).parent().parent());                          // enable and show the whole row 
                    addPlatformSymbols($('#' + value[0] + '_plats'), value[2]);                                 // show which platforms have this parameter
                    ids.push(value[0]);
                    if (value[1].length != 0 && $('#show-standardnames-mp-checkbox').is(':checked')) {
                        enableButton($('button', '#' + value[1] + '--' + value[0] + '-sn'));                                // Enable the standard_name button in the table row
                        enableParameterRow($('button', '#' + value[1] + '--' + value[0] + '-sn').parent().parent());        // enable and show the whole row 
                        ids.push(value[1] + '--' + value[0] + '-sn');
                    }
                });
                $('#measuredparameter-table > tbody > tr > td > button').each(function (index, elem) { 
                    if (elem.parentNode.id.length != 0) {
                        if ($.inArray(elem.parentNode.id.toString(), ids) == -1) {
                            disableButton($(elem));                                                         // disable the button in the table row
                            disableXYZColorPlot($('input:radio', $(elem).parent().parent()));               // disable the X, Y, Z, Color radio buttons in the row
                            disableXYZColorPlot($('input:checkbox', $(elem).parent().parent()));            // disable the Plot checkbox in the row
                            disableParameterRow('mp', $(elem).parent().parent());                           // disable the whole row and hide unless show-filtered-parameters is checked
                        }
                    }
                });
            }

            // Do not assign time or depth to $('#start-ems'), $('#start-depth'), etc. on update - it breaks parameterplatformdatavaluepng display
            //else if (key == 'time') { 
            //    var start = new Date(data[key][0]);
            //    $('#start-ems').val(start.getTime());
            //    $('#start-time').val(getUTCDateString(start));
            //    var end = new Date(data[key][1]);
            //    $('#end-ems').val(end.getTime());
            //    $('#end-time').val(getUTCDateString(end));
            //}
            //else if (key == 'depth') {
            //    $('#start-' + key).val(Math.round(data[key][0]*10)/10);
            //    $('#end-' + key ).val(Math.round(data[key][1]*10)/10);
            //}


            else if (key == 'simpledepthtime') {
                redrawSimpleDepthTime(data);
            }
            else if (key == 'parameterplatformdatavaluepng') {
                // Make the contour plot if checkbox is checked and is not disabled
                if ( $('input:radio[name=parameters_plot]').is(':checked') ) {
                    if ( $('input:radio[name=parameters_plot]:checked').val() ) {
                        if (data['parameterplatformdatavaluepng'][0]) {
                            var flotdata;
                            var options = simpledepthtime_options_zoom;
                            if ($('.btn-primary', $('#temporal-anchor').parent()).length) {
                                // Zoomed
                                flotdata = [ [ ["{{MEDIA_URL}}sections/" + data['parameterplatformdatavaluepng'][0], 
                                    $('body').data()['start-ems'], $('body').data()['start-depth'], $('body').data()['end-ems'], $('body').data()['end-depth'] ] ] ];
                                options = $.extend(true, {}, options, {
                                    series: { images: { show: true } }
                                });
                            }
                            else {
                                // Not Zooomed
                                flotdata = [ [ ["{{MEDIA_URL}}sections/" + data['parameterplatformdatavaluepng'][0], 
                                    timedepthplot.getAxes().xaxis.min, timedepthplot.getAxes().yaxis.min, timedepthplot.getAxes().xaxis.max, timedepthplot.getAxes().yaxis.max] ] ];
                                options = $.extend(true, {}, options, {
                                    series: { images: { show: true } },
                                    xaxis: { min: timedepthplot.getAxes().xaxis.min, max: timedepthplot.getAxes().xaxis.max },
                                    yaxis: { min: timedepthplot.getAxes().yaxis.min, max: timedepthplot.getAxes().yaxis.max } 
                                });
                            }
                            if ( ! $.isEmptyObject($('body').data()['platformAnimation']) ) {
                                options = $.extend(true, {}, options, { crosshair: { mode: "x" } });
                            }
                            $.plot.image.loadDataImages(flotdata, options, function () {
                                $.plot($("#time-depth-flot"), flotdata, options);
                            });
                            // Show colorbar
                            $('#sectioncolorbarimg').attr('src', '{{MEDIA_URL}}sections/' + data.parameterplatformdatavaluepng[1]);
                            $('#temporalparameterplotinfo').text($('button', $('input:radio[name=parameters_plot]:checked').parent().siblings()[5]).text() + ' from ' + 
                                                                 $('body').data()['parameterplatforms'][$('input:radio[name=parameters_plot]:checked').val()]);
                            $('#temporalparameterplotinfo').css( { 'color': 'black' } );
                            $('#temporalparameterstrideinfo').text(data['parameterplatformdatavaluepng'][2]);
                        }
                        else {
                            $('#temporalparameterplotinfo').text(data['parameterplatformdatavaluepng'][2]);
                            $('#temporalparameterplotinfo').css( { 'color': 'red' } );
                            $('#sectioncolorbarimg').removeAttr('src');
                        }
                    }
                    else {
                        // Clear button selected redraw without image
                        redrawSimpleDepthTime(data);
                    }
                }
            }
            else if (key == 'parametertime') {
                redrawParameterTime(data);

            }
            else if (key == 'activityparameterhistograms') {
                $('#parameter-value-table').html('<tbody></tbody>');
            	var histHtml='';
                var $elem=$('#parameter-value-table > tbody');
                var parameterunits = data[key]['parameterunits'];
                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    parameter_idsafe = parameter.replace(/[\s\.\[\]]/g, '_');       // HTML ids don't allow spaces
					var divid=parameter_idsafe + '-histogram-flot';
                    if ($('#' + divid).length == 0) {
	                    histHtml += '<tr>' +
	                        '<td>' +
	                            '<div id="' + parameter_idsafe + '-histogram-flot" style="width:100%;height:100px;"></div>' +
	                        '</td>' +
	                        '</tr>';
                    }
                });
                $elem.html(histHtml);
                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    parameter_idsafe = parameter.replace(/[\s\.\[\]]/g, '_');       // HTML ids don't allow spaces
                    histdata = [];
                    $("#" + parameter_idsafe + "-histogram-flot").bind("plotselected", function (event, ranges) {
                        parametervalues[parameter] = {'xmin': ranges.xaxis.from, 'xmax': ranges.xaxis.to, 'ymin':0, 'ymax': ranges.yaxis.to };
						rebuildFilters();
                    });
                    $.each(histbyplatformandactivity, function (platform, histbyplatform) {
                        $.each(histbyplatform, function(activity, histbyactivity) {
                            histdata = collectHistData(histdata, platform, data[key]['rgbacolors'][platform], activity, histbyactivity);
                        });
                    });

                    if (parametervalues) {
                        if (parametervalues[parameter]) {
                            var min = parametervalues[parameter]['xmin'];
                            var max = parametervalues[parameter]['xmax'];
                            if (typeof min != 'undefined' && typeof max != 'undefined') {
                                histdata = addSelectedParameterValue(histdata, parameter);
                                $('#parametervalues-data').val(JSON.stringify(parametervalues));
                            }
                        }
                    }

                    plotHistData(parameter, histdata, parameterunits);

                });
            }
            else if (key == 'parameterparameterpng') {
                if (data[key]) {
                    if ( ! $.isEmptyObject(data['parameterparameterx3d']) ) {
                        if ( ! $.isEmptyObject(data['parameterparameterx3d']['sql']) ) {
                            $('#parameter-parameter-sql').html(data['parameterparameterx3d']['sql']);
                        }
                    }
                    else {
                        $('#parameter-parameter-sql').html(data[key][2]);
                    }
                    if (data[key][0]) {
                        $('#parameter-parameter-2dplot > img').attr('src', '{{MEDIA_URL}}parameterparameter/' + data[key][0]);

                        if ( ! $('#collapseParameterParameter').hasClass('in') ) {
                            $('#parameter-parameter-anchor').click();
                        }
                        if ( $('#collapseParameterParameter').hasClass('in') && ! $('#ppsql').hasClass('active') ) {
                            if ( ! $('#pp2d').hasClass('active') && ! data['parameterparameterx3d']) {
                                $('a[href=#pp2d]').tab('show');
                            }
                        }
                        $('#parameter-parameter-2dplot > pre').html(data[key][1]);
                    }
                    else {
                        alert(data[key][1] + "  Try a different selection.");
                    }
                }
            }
            else if (key == 'parameterparameterx3d') {
                if (data[key]) {
                    if (data[key]['points']) {
                        if ( ! $('#pp-3d-pointset').length ) {
                            // Add Shape here to reduce X3DOM error/warnings of missing geometry in shape node
                            $('#pp-3d-scene').append('<Shape id="pp-3d-pointset"></Shape>');
                        }
                        $('#pp-3d-pointset').html(['<pointset>',
                                                   '   <color color="' + data[key]['colors'] + '"></color>',
                                                   '   <coordinate point="' + data[key]['points'] + '"></coordinate>',
                                                   '</pointset>'].join(''));
                        $('#x3d-xmin').attr('string', data[key]['x'][1]);
                        $('#x3d-xmax').attr('string', data[key]['x'][2]);
                        $('#x3d-xname').attr('string', data[key]['x'][3]);
                        $('#x3d-ymin').attr('string', data[key]['y'][1]);
                        $('#x3d-ymax').attr('string', data[key]['y'][2]);
                        $('#x3d-yname').attr('string', data[key]['y'][3]);
                        $('#x3d-zmin').attr('string', data[key]['z'][1]);
                        $('#x3d-zmax').attr('string', data[key]['z'][2]);
                        $('#x3d-zname').attr('string', data[key]['z'][3]);
                        if (data[key]['colorbar']) {
                            $('#parameter-parameter-3dplot > div > div > img').attr('src', '{{MEDIA_URL}}parameterparameter/' + data[key]['colorbar']);
                        }
                        else {
                            $('#parameter-parameter-3dplot > div > div > img').removeAttr('src');
                        }
                        //$('#pp_x3d').css( {
                        //        'background-image': 'url({{MEDIA_URL}}parameterparameter/' + data[key]['colorbar'] + ')', 
                        //        'background-repeat': 'no-repeat',
                        //        'position': 'relative' } );
                        if ( ! $('#collapseParameterParameter').hasClass('in') ) {
                            $('#parameter-parameter-anchor').click();
                        }
                        if ( $('#collapseParameterParameter').hasClass('in') ) {
                            if ( ! $('#pp3d').hasClass('active') ) {
                                $('a[href=#pp3d]').tab('show');
                            }
                        }
                    }
                }
            }
            else if (key == 'measuredparameterx3d') {
                if (data[key]) {
                    if (data[key]['points']) {
                        if ( ! $.isEmptyObject(data.measuredparameterx3d.points) ) {
                            if ( ! $('#mp-x3d-track').length ) {
                                // Add Shape here to reduce X3DOM error/warnings of missing geometry in shape node
                                $('#spatial-3d-scene').append('<Shape id="mp-x3d-track"></Shape>');
                            }
                            $('#mp-x3d-track').html([
                                '<Appearance><LineProperties linewidthScaleFactor="5"></LineProperties></Appearance>',
                                '<indexedlineset coordIndex="' + data.measuredparameterx3d.index + '">',
                                    '<color color="' + data.measuredparameterx3d.colors + '"></color>',
                                    '<geocoordinate point="' + data.measuredparameterx3d.points  + '">' + $('body').data()['geoorigin_use'] + '</geocoordinate>',
                                '</indexedlineset>',
                            ].join(''));
                        }
                        $('#geo3d-colorbar').html('<img src="{{MEDIA_URL}}sections/' + data.measuredparameterx3d.colorbar + '" />');
                    }
                }
            }
            else if (key == 'resources') {
                buildMetadataHtml(data, false);
            }
            else if (key == 'attributes') {
                if ( ! $.isEmptyObject(data[key]) ) {
                    var ids = [];
                    $.each(data[key]['measurement'], function (ltype, labels) {
                        $.each(labels, function (index, label) {
                            // Here we need to enable those that are still valid.
                            var element=$('#' + label[0]);
                            enableButton($('button', element));             // enable the button in the table row
                            ids.push(label[0]);
                        });
                    });
                    $('.stoqs-attributes > tbody > tr').each(function (index, elem) {     
                        if ($.inArray(parseInt(elem.id), ids) == -1) {       
                            disableButton($('button', $(elem)));            // disable the button in the table row      
                        }       
                    });
                }
            }
            else if (key == 'platformanimation') {
                if (data[key]['x3d']) {
                    var x3dText = '';
                    $('body').data()['platformAnimation'] = [];
                    $.each(data[key]['x3d'], function (plat, x3d) {
                        $('body').data()['platformAnimation'].push(plat);
                        x3dText += x3d;
                    });
                    $('#platform-animations').html(data[key]['all'] + x3dText);
                }
                else {
                    if ( ! $.isEmptyObject(data[key]['message']) ) {
                        alert(data[key]['message']);
                    }
                }
                // Redraw the time series so that we have the crosshair option added and can call lockCrosshair()
                if (data['simpledepthtime']) {
                    redrawSimpleDepthTime(data);
                }
                if (data['parametertime']) {
                    redrawParameterTime(data);
                }
                if (data[key]['limits']) {
                    timeAxis = data[key]['time'];
                    sliderLimits = data[key]['limits'];
                    function updateTranslateRotate(fraction) {
                        var currentInterval = $('#PLATFORMS_TS').attr('cycleInterval');
                        var timeElapsed = fraction * currentInterval;
                        var currentTime = (new Date()).getTime()/1000;
                        var newStartTime = currentTime - timeElapsed;
                        
                        $('#PLATFORMS_TS').attr('enabled','false');
                        $('#PLATFORMS_TS').attr('startTime', String(newStartTime));
                        $('#PLATFORMS_TS').attr('enabled', 'true');
                        if ($('#spatial-3d-x3d-pause-play').hasClass('icon-play')) {
                            $('#PLATFORMS_TS').attr('enabled', 'false');
                        }
                        updateCrosshairs(fraction, timeAxis, sliderLimits);
                    }
                    $('#spatial-3d-x3d-slider').mousemove( function(e) {
                        updateTranslateRotate($(this).val());
                    });
                    $('#spatial-3d-x3d-pp-slider').show();
                    $('#spatial-3d-x3d-speedup').html('Speedup: ' + data[key].speedup + 'x');
                    $('#spatial-3d-x3d-pause-play').click();
                    if ($('#spatial-3d-x3d-pause-play').hasClass('icon-play')) {
                        $('#spatial-3d-x3d-pause-play').click();
                    }
                }
                if (data[key]['platforms_not_shown']) {
                    if ( ! $.isEmptyObject(data[key]['platforms_not_shown']) ) {
                        $('#spatial-3d-x3d-message').html('Platform(s) not shown: ' + data[key]['platforms_not_shown']);
                    }
                }
            }

            // If no parametertime data and Station tab is active then disable it and switch back to Trajectory
            if ( ! $.isEmptyObject(data.parametertime) ) {
                if ( $.isEmptyObject(data.parametertime.pt) ) {
                    if ( $('#temporal-parameter-li').hasClass('active') ) {
                        //$('a', '#temporal-depth-li').tab('show');
                        $("#temporal-parameter-li").hide();
                    } 
                }
            }

        } // onUpdate()

        var startAjax = new Date().getTime();
        $.when($.ajax({
            type : 'GET',
            beforeSend: function() {
                startWaitIndicators();
            },
            url : summaryQuery + '?' + qstring,
            error: function(jqXHR, textStatus, errorThrown) {
                alert(textStatus);
                resetWaitIndicators();
            },
            success: function (data) {
                setDataAccess('mp', data);
                setDataAccess('sp', data);
                saveBodyData(data);
                if (init) {
                    save_zoom_from_permalink();
                }
                for (var key in data) {
                    if (init) {
                        onInit(data, key)
                    } else {
                        onUpdate(data, key)
                    }
                }
                if (init) {
                    if ( !$('#collapseTemporal').hasClass('in') ) {
                        $('#temporal-anchor').click();
                    }
                    if ( !$('#collapseSpatial').hasClass('in') ) {
                        $('#spatial-anchor').click();
                    }
                    // Push initial temporal/depth bounds to the stack
                    zoom_simpledepthtime_stack.push([ timedepthplot.getXAxes()[0].datamin, timedepthplot.getXAxes()[0].datamax, 
                                                      timedepthplot.getYAxes()[0].datamin, timedepthplot.getYAxes()[0].datamax,
                                                      simpledepthtime_options_zoom ]);
                    // Perform saved clicks embedded in $.url().param('permalink_id')
                    load_permalink();
                }

                // Register handler that waits for all (including permalink) requests to finish
                $(document).ajaxStop(function (data) {
                   resetWaitIndicators();
                })

                // For Development - turn on Platform plot controls
                //$('.platform-plot-instruction').show()
                //$('.platform-plot-map-checkbox').show()
                //$('.platform-plot-section-radio').show()

            },
            dataType: "json"
        }))
        .then(function( data, textStatus, jqXHR ) {
            // If Update was the result of clearing the Temporal selection and a Plot Data radio button is checked 
            // then call rebuildFilters() again to re-Update the presentation with a new parameterplatformdatavaluepng
            if (clearingTemporalFlag) {
                clearingTemporalFlag = false;
                rebuildFilters();
            }

            // Remove items that are not needed for new map generation
            var map_params = params;
            if ( ! $.isEmptyObject(map_params.only) ) {
                $.each(map_params.only, function(index, v) {
                    if ( $.inArray(v, ['parameterparameterpng', 'parameterparameterx3d']) > -1 ) {
                        delete map_params.only[index];
                    }
                });
            }

            // Update kml request after summary request finishes so that cmin and cmax are set for the current data
            update_sensortrackskml()

            // Perform mapQuery separate from summary query so that it is not cached by memcached
            var qstring=($.param($.map(map_params, function(v, k) { return ($.type(v) === "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })));
            $.ajax({
                //onInit(), onUpdate() must finish before map can be drawn
                type : 'GET',
                beforeSend: function() {
                    if ( $('#zoomtoextentonupdate').is(':checked') ) {
                        me.clearMap();
                    }
                },
                // Request only the extent and platforms in order to quickly produce the mapfile
                url : mapQuery + '?' +  qstring + '&only=extent\&only=platforms',
                success: function (data) {
                    $('body').data()['extent'] = data['extent'];
                    me.refreshMap($('body').data()['extent'][0]);
                    if (init) {
                        if ( $.isEmptyObject($.url().param('permalink_id')) ) {
                            // Set start and end time with actual axis values
                            $('body').data()['start-ems'] = timedepthplot.getXAxes()[0].datamin;
                            $('body').data()['end-ems'] = timedepthplot.getXAxes()[0].datamax;
                            $('body').data()['start-depth'] = timedepthplot.getYAxes()[0].datamin;
                            $('body').data()['end-depth'] = timedepthplot.getYAxes()[0].datamax;
                        }
                        updateTemporal();
                    }
                },
                dataType: "json"
            })
        });

    } // updateSummaryData()
   
    function setCrosshair(eventObject) {
        // Handle events from PlatformOrientation TimeSensor to update crosshair on Temporal flot plot
        // See: http://doc.x3dom.org/tutorials/animationInteraction/onoutputchange/example.html
        if(eventObject.type != "outputchange" || eventObject.fieldName != "fraction_changed")
            return;
        
        var t = $('body').data()['po_start_time'] + eventObject.value * ($('body').data()['po_end_time'] - $('body').data()['po_start_time']);

        timedepthplot.lockCrosshair({x: t, y:0});
        if ( ! $.isEmptyObject(timeparameterplot) ) {
            timeparameterplot.lockCrosshair({x: t, y:0});
        }
    }

    // Collect all the parameters on the page so we can generate our permalink.
    function collect_parameters() {
        params={'platform_clicks': [],
                'clicks': [],
                'accordian': [],
                'tabs': []}
        // Need to do the right column stuff before the left column stuff, since
        // checkboxes might appear depending on selections on the right.
        
        var columns=['#right-column','#left-column'];
        $.each(columns, function(pos, divcol) {
            // Grab all the checked radio buttons on the page and save their information.
            $('input:checked[type="radio"]', divcol).each(function(key, item) {
                var data='input[type="radio"][name="'+ item.name +'"][value="'+ item.value +'"]';
                params['clicks'].push(data);
            });
            // Grab all the checked checkboxes from Temporal->Parameter 
            $('input:checked[type="checkbox"]', divcol).each(function(key, item) {
                var data='input[type="checkbox"][name="'+ item.name +'"][value="'+ item.value +'"]';
                params['clicks'].push(data);
            });
            // Grab all the buttons that are selected, using their values.
            $('button.btn-primary.stoqs-toggle', divcol).each(function(key, item) {
                var id=$(item).closest('[id]')[0].id
                var data='#' +id +' button.stoqs-toggle:contains("'+$(item).text()+'")'
                if ( $(item).hasClass('platform') ) {
                    params['platform_clicks'].push(data);
                }
                else {
                    params['clicks'].push(data);
                }
            });
            // Grab all the checkboxes, note that openlayers seems to have ID's with
            // spaces in them, so we cannot use the '#' to locate those, need to use the
            // attribute selector instead.
            
            $('input:checked[type="checkbox"]', divcol).each(function(key, item) {
                var data=''
                if (typeof item.id !== 'undefined' &&
                    $(item).parent().css('display') != 'none') {
                    data='input[type="checkbox"][id="' + item.id + '"]'; 
                } else if ((typeof item.name !== 'undefined') && 
                           (typeof item.value !== 'undefined')) {
                    data='input[type="checkbox"][name="'+item.name+'"][value="'+item.value+'"]';
                } else {
                    alert('Unable to get unique path for input field, skipping from permalink!');
                }
                if (data != '') {
                    params['clicks'].push(data);
                }
            });

            // Grab the state of all the accordians on the page and store them
            $('.accordion-body.in', divcol).each(function (key, item) {
                params['accordian'].push(item.id);
            });
        });
        
        $('.nav-tabs').each(function (pos, item) {
            $elements=$('li', item);
            $.each($('li', item), function (pos2, item2) {
                if ($(item2).hasClass('active')) {
                    params['tabs'].push(['#' + item.id, pos2]);
                }
            });
        });
        // Grab the data so we can reset the time/depth plot and temporal values.
        params['start-ems'] = $('body').data()['start-ems'];
        params['end-ems'] = $('body').data()['end-ems'];
        params['start-depth'] = $('body').data()['start-depth'];
        params['end-depth'] = $('body').data()['end-depth'];

        // Grab the center of the map so we can restore the center and lon/lat data.
        params['map-center']={ 'lonlat': map.getCenter(), 
                                'zoom': map.getZoom() };
        params['map-layers']=[];
        $.each(map.layers, function (pos, layer) { 
            if (layer.visibility) { 
                params['map-layers'].push(layer.name); 
            }
        });
       
        if ( $('#parametervalues-data').val() ) { 
            // Grab any parametervalues selections that have been put into the hidden element
            params['histograms'] = $('#parametervalues-data').val();
            $.each(JSON.parse($('#parametervalues-data').val()), function(parameter, data) {
                if (typeof data.xmin != 'undefined' && typeof data.xmax != 'undefined') {
                    params[parameter + '_MIN'] = data.xmin.toPrecision(4);
                    params[parameter + '_MAX'] = data.xmax.toPrecision(4);
                }
            });
        }

        return JSON.stringify(params);
        
    }

    function save_zoom_from_permalink() {
        // Set Temporal/Depth zoom for handler that calls ZoomIn() on Temporal tab click event
        var permalink_id=$.url().param('permalink_id');
        if (typeof permalink_id !== 'undefined') {
            // If it's longer than 32 characters, it is a client-side permalink
            if (permalink_id.length > 32) {
                try {
                    var parameters=JSON.parse(LZString.decompressFromBase64(permalink_id));
                    $('body').data()['end-ems'] = parameters['end-ems'];
                    $('body').data()['start-ems'] = parameters['start-ems'];
                    $('body').data()['end-depth'] = parameters['end-depth'];
                    $('body').data()['start-depth'] = parameters['start-depth'];
                } catch (err) {
                    alert('Permalink loading failed: ' + err + ' (Perhaps the permalink_id value is invalid?)');
                }
            }
        }
    }

    function reset_parameters(parameters) {
        permalink_bypass = true;

        // Uncheck the zoom update, since that'll mess up our resetting the map
        var $update=$('input[type=\"checkbox\"][id=\"zoomtoextentonupdate\"]')
        if ($update.is(':checked')) { $update.click(); } // uncheck it

        save_zoom_from_permalink(parameters)

        // Click platform buttons first, then the rest of them
        $.each(parameters['platform_clicks'], function (pos, item) {
            $(item).click();
        });
        $.each(parameters['clicks'], function (pos, item) {
            $(item).click();
        });

        // Now, the rest of the information
        $.each(parameters, function (key, value) {
            switch(key) {
                case 'map-center':
                    if (lonlat && zoom) {
                         var lonlat=new OpenLayers.LonLat(value.lonlat.lon, value.lonlat.lat);
                   		 map.setCenter(lonlat,value.zoom);
                    } 
                    break;
                case 'map-layers':
                    $.each(map.layers, function (pos, layer) {
                        if ($.inArray(layer.name, value) > -1) {
                            layer.setVisibility(true);
                        } else {
                            layer.setVisibility(false);
                        }
                    });
                    break;
                case 'accordian':
                    $('.accordion-body').each(function (pos, item) {
                        if ($.inArray(item.id, value) > -1) {
                            $(item).addClass('in').height('auto');
                        } else {
                            $(item).removeClass('in').height('0px');
                        }
                    });
                    break;
                case 'tabs': 
                    $.each(value, function (pos, item) {
                        if ( item[0] != '#parameterParameterTabs' ) {
                            // ParameterParameter tab clicks happen on ajax success - don't do them here
                            var $elem=$('li > a', item[0]);
                            $elem.removeClass('active');
                            $($elem[item[1]]).click();
                        }
                    });
                    break;
                case 'histograms':
                    if ( ! $.isEmptyObject(value) ) {
                        parametervalues = JSON.parse(value);
                    }
            }
        });
        
        permalink_bypass=false;
        rebuildFilters();

        // Redraw selections on the histograms - do this after calling rebuildFilters()
        if ( ! $.isEmptyObject(parametervalues) ) {
            if (parametervalues[parameter]) {
                var min = parametervalues[parameter]['xmin'];
                var max = parametervalues[parameter]['xmax'];
                if (typeof min != 'undefined' && typeof max != 'undefined') {
                    histdata = addSelectedParameterValue(histdata, parameter);
                }
            }
        }
    }
    
    function load_permalink() {
        var permalink_id=$.url().param('permalink_id');
        if (typeof permalink_id !== 'undefined') {
            // If it's longer than 32 characters, it is a client-side permalink
            if (permalink_id.length > 32) {
                try {
                    var parameters=JSON.parse(LZString.decompressFromBase64(permalink_id));
                    reset_parameters(parameters);
                } catch (err) {
                    alert('Permalink loading failed: ' + err + ' (Perhaps the permalink_id value is invalid?)');
                }
            } else {
                var url='{% url 'stoqs:load_permalink' dbAlias=request.META.dbAlias pid='REPLACE' %}';
                url=url.replace('REPLACE', permalink_id);
                console.log(url);
                $.get(url).
                done(function (parameters, response, jqXHR) {
                    reset_parameters(parameters);
                }).
                fail(function (data, response, jqXHR) {
                    alert('Failed to load the specified permalink: ' + jqXHR);
                });
            }
        }
    }


    $(function () { 
        // Initialize the accordian fields.
        $(".collapse").collapse(); // Collapse all the accordian fields, click the Spatial and Temporal ones below
        
        // Add this behavior to all text fields, so when someone clicks on a field it highlights 
        // all the data so it's easy to copy to the clipboard.
        $(document).on('focus', 'input[type=text]', function(e) {
            // Select field contents
            var t=this
            // This has to be done after 100ms so that standard bootstrap functionality happens first.
            setTimeout(function() { t.select()}, 100);
        });

                
        /* 
         * Setup OpenLayers with some default background layers.
         */
        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 4;
        OpenLayers.Util.onImageLoadError = function() {this.style.display="none"; };
        //ctrlGraticule = new OpenLayers.Control.Graticule({autoActivate : false});
        var options = {
            projection: new OpenLayers.Projection("EPSG:3857"),
            displayProjection: new OpenLayers.Projection("EPSG:4326"),
            units: "m",
            maxResolution: 156543.0339,
            maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
                                              20037508.34, 20037508.34),
            controls: [
                new OpenLayers.Control.Navigation(
                    {dragPanOptions: {enableKinetic: true}}
                )
            ]
        };
        map = new OpenLayers.Map('map',options);

        var bathyEsri = new OpenLayers.Layer.XYZ(
            ' ESRI Ocean'
            ,'http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/${z}/${y}/${x}.jpg'
            ,{
               sphericalMercator : true
              ,isBaseLayer       : true
              ,wrapDateLine      : true
              ,opacity           : 1
              ,visibility        : true
             }
        );

        var gebco_noaa = new OpenLayers.Layer.XYZ(
            " GEBCO & NOAA Tiles",
            [
                "http://{{ mapserver_host }}/gebco_noaa/tiles/${z}/${x}/${y}.png"
            ], 
            {
                attribution: "Sources: General Bathymetric Chart of the Oceans "
                + "(<a href='http://www.gebco.net/'>GEBCO</a>)"
                + " &amp; NOAA National Geophysical Data Center"
                + " (<a href='http://www.ngdc.noaa.gov/mgg/dem/demportal.html'>NGDC</a>)",
                sphericalMercator: true,
                wrapDateLine: true,
                transitionEffect: "resize",
                buffer: 1,
                numZoomLevels: 16
            }
        );
        var osm=new OpenLayers.Layer.OSM(" OpenStreetMap");
        map.addLayers([bathyEsri,gebco_noaa,osm]);
        //ctrlGraticule.activate();

        /*
         * Maptrack layers selected by UI 
         */
        track_lines = new OpenLayers.Layer.WMS(
            " trajectories",
            "http://{{ mapserver_host }}/cgi-bin/mapserv",
            { layers: 'trajectories',
              map: '{{ mappath }}',
              transparent: 'True' },
            { units: 'degrees',
              displayInLayerSwitcher: true,
              projection: "EPSG:3857",
              reproject: false,
              visibility: true,
              singleTile: true, ratio: 1,
              displayOutsideMaxExtent: true } );

        stations = new OpenLayers.Layer.WMS(
            " stations",
            "http://{{ mapserver_host }}/cgi-bin/mapserv",
            { layers: 'timeSeries',
              map: '{{ mappath }}',
              transparent: 'True' },
            { units: 'degrees',
              displayInLayerSwitcher: true,
              projection: "EPSG:3857",
              reproject: false,
              visibility: true,
              singleTile: true, ratio: 1,
              displayOutsideMaxExtent: true } );

        sample_points = new OpenLayers.Layer.WMS(
            " Sample points",
            "http://{{ mapserver_host }}/cgi-bin/mapserv",
            { layers: 'sample_points',
              map: '{{ mappath }}',
              transparent: 'True' },
            { units: 'degrees',
              displayInLayerSwitcher: true,
              projection: "EPSG:3857",
              reproject: false,
              visibility: true,
              singleTile: true, ratio: 1,
              displayOutsideMaxExtent: true } );

        sensortrackskml = new OpenLayers.Layer.Vector(" Sensor tracks", {
            projection: map.displayProjection,
            strategies: [new OpenLayers.Strategy.Fixed()],
            // protocol is Dynamically set in update_sensortrackskml(), need placeholder url here for IE8
            protocol: new OpenLayers.Protocol.HTTP({
                url: 'measuredparameter.kmln',
                format: new OpenLayers.Format.KML({
                    extractStyles: true,
                    extractAttributes: true,
                    maxDepth: 2
                })
            })
        });

        sensortrackskml.events.register("loadend", sensortrackskml, function (e) {
            if( sensortrackskml.getDataExtent() ) {
                if ( $('#zoomtoextentonupdate').is(':checked') ) {
                    map.zoomToExtent(sensortrackskml.getDataExtent());
                }
            }
        });



        // Test of WFS using ga_wfs 
        // As of 11 Feb 2013 this request returns a MissingParameterValue Exception, but does not crash
        // Note the prerequisite software listed as a comment in urls.py before the url match for 'wfs'
        var csrf_token = $.cookie('csrftoken');
        samplewfs = new OpenLayers.Layer.Vector("Sample WFS", {
            projection: map.displayProjection,
            strategies: [new OpenLayers.Strategy.BBOX()],
            protocol: new OpenLayers.Protocol.WFS({
                url: '{{site_uri}}{% url 'stoqs:base-campaign' dbAlias=request.META.dbAlias %}wfs',
                headers: {'X-CSRFToken': csrf_token},
                featureType: 'Sample'
            }),
            styleMap: new OpenLayers.StyleMap({
                    strokeWidth: 3,
                    strokeColor: "#333333"
            })
        });
        //map.addLayer(samplewfs);


        map.addLayer(sensortrackskml);
        map.addLayer(track_lines); 
        map.addLayer(stations); 
        map.addLayer(sample_points); 

        map.addControl(new OpenLayers.Control.LoadingPanel());
        map.addControl(new OpenLayers.Control.LayerSwitcher());
        map.addControl(new OpenLayers.Control.MousePosition());
        map.addControl(new OpenLayers.Control.PanZoom());


        // Add polygon drawing tool and capture WKT of polygon as WGS84
        map.addLayer(polyLayer);
        var panelControls = [
            new OpenLayers.Control.Navigation(),
            new OpenLayers.Control.DrawFeature(polyLayer,
                OpenLayers.Handler.Polygon,
                {   'displayClass': 'olControlDrawFeaturePolygon',
                    featureAdded: function() {
                        var projWGS84 = new OpenLayers.Projection("EPSG:4326");
                        var proj3857 = new OpenLayers.Projection("EPSG:3857");
                        var polyWGS84 = polyLayer.features[0].geometry;
                        polyWGS84.transform(proj3857, projWGS84);
                        console.log(polyWGS84);
                        OpenLayers.Console.userError(polyWGS84);
                        rebuildFilters();
                    }
                }
            )
        ];
        var toolbar = new OpenLayers.Control.Panel({
            displayClass: 'olControlEditingToolbar',
            defaultControl: panelControls[0]
        });
        // Commented out until it's fully implemented
        //toolbar.addControls(panelControls);
        //map.addControl(toolbar);


        // Capture Feature info - both methods work with the data template specified as a file
        // - Put feature info into a <div>
        //map.events.register('click', map, function (e) {
        //    OpenLayers.Util.getElement('samplePoint').innerHTML = "Loading... please wait...";
        //    sample_point_url = sample_points.getFullRequestString({
        //                            REQUEST: "GetFeatureInfo",
        //                            EXCEPTIONS: "application/vnd.ogc.se_xml",
        //                            BBOX: sample_points.map.getExtent().toBBOX(),
        //                            X: e.xy.x,
        //                            Y: e.xy.y,
        //                            FEATURE_COUNT: 1,
        //                            INFO_FORMAT: 'text/html',
        //                            QUERY_LAYERS: sample_points.params.LAYERS,
        //                            WIDTH: sample_points.map.size.w,
        //                            HEIGHT: sample_points.map.size.h});
        //    
        //    OpenLayers.loadURL(sample_point_url, '', this, setHTML);
        //    OpenLayers.Event.stop(e);
        //});
        //function setHTML(response) {
        //    OpenLayers.Util.getElement('samplePoint').innerHTML = response.responseText;
        //}
        // - Create a popup window
        //var sample_points_info = new OpenLayers.Control.WMSGetFeatureInfo({
        //        url: "http://{{ mapserver_host }}/cgi-bin/mapserv",
        //        maxFeatures: 3,
        //        title: 'Identify features by clicking',
        //        queryVisible: true,
        //        layers: [sample_points],
        //        vendorParams: {
        //                 map: "{{ mappath }}",
        //        },
        //        eventListeners: {
        //            getfeatureinfo: function(event) {
        //                console.log(event);
        //                map.addPopup(new OpenLayers.Popup.FramedCloud(
        //                    "chicken",
        //                    map.getLonLatFromPixel(event.xy),
        //                    null,
        //                    event.text,
        //                    null,
        //                    true
        //                )); //map.addPopup
        //            } // getfeatureinfo
        //        } // eventListeners
        //    });
        //map.addControl(sample_points_info);
        //sample_points_info.activate();
        //End Capture Feature info tests












        /*
         *  Initial page load - minimize list of items to load
         */
        params['except'] = ['mpsql', 'spsql'];
        updateSummaryData(true);

          
        $('body').on('change', '.slider-values', function (e) {
            var $slider=$('#slider-' + this.id.split('-').reverse()[0])
            var setting=$slider.data().reverseformatter($(this).val());
            var pos=0;
            if (this.id.split('-')[0] == 'start') {
                pos=0
            } else {
                pos=1
            }
            var oldvalue=$slider.slider('values',pos);
            var result=$slider.slider('values',pos,[setting]);
            if (Math.abs(setting-result) > 1) {
                jAlert('The data entered was not within the specified range, or exceeds the valid precision for this field. ' +
                        'the field has been reset to its original value.')
                $slider.slider("values",pos,[oldvalue])
            }
        });
        

        // Tootips that are disabled after first use - don't want to annoy users too much
        //$('#showsensortracks').parent().tooltip({title: 'Select a Measured Parameter to enable'});
        //$('#showgeox3dmeasurement').parent().tooltip({title: 'Select a Measured Parameter to enable'});

        $('#permalink').on('click', function(ev){
            ev.preventDefault();
            var $target=$(ev.currentTarget);
            var url=$target.data('action');
            var params=$target.data('parameters');
            if (typeof params === 'undefined') {
                params=''
            }
            // If the permalink is visible, then there's no point in getting
            // another one - since the one they are seeing is alredy current so just
            // ignore the clicks if that's the case.
            if ($('#permalink-box').is(":visible") == false) {
                //$.post(url, {'parameters': params })
                var $el=$('input[name="permalink"]')
                if ((typeof client_side_permalink !== 'undefined') &&
                    (client_side_permalink)) {
                    var $url=$.url();
                    var params=$url.param();
                    params['permalink_id']=LZString.compressToBase64(collect_parameters());
                    var url=$url.attr('source').split('?')[0]+'?'+$.param(params)
                    $el.val(url);
                    $('#permalink-box').show();

                } else {
                    $.post(url, {'parameters': collect_parameters() })
                    .done(function (data, response, jqXHR) {
                        $el.val(data);
                        $('#permalink-box').show();
                    });
                }
            }
        });
    });

    --></script>
  </body>
</html>
