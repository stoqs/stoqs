# PREREQUISITES 
# =============

# These commands need to be executed once on your system, they have been tested on CentOS 6.
# It is assumed that Postgres 9.1 is already installed.  Some level of familiarity with 
# Unix is required to install STOQS.  If you run into any difficulties please feel free
# to post questions on the stoqs-discuss mail list, which you may join at: 
# https://groups.google.com/forum/#!forum/stoqs-discuss

su -c "easy_install virtualenv"
su -c "yum -y install postgis rabbitmq-server gdal scipy mod_wsgi"

# Rabbitmq is used by the web app t manage long-running tasks
su -c "/sbin/chkconfig rabbitmq-server on"
su -c "/sbin/service rabbitmq-server start"
su -c "rabbitmqctl add_user stoqs stoqs"        # Note: You may want different credentials
su -c "rabbitmqctl add_vhost stoqs"             # for the Rabbitmq account - here we use 'stoqs'.
su -c 'rabbitmqctl set_permissions -p stoqs stoqs ".*" ".*" ".*"'

# For ability to generate ER diagrams using ./manage.py graph_models stoqs stoqs -g -o stoqs_model.png
su -c "yum -y install graphviz-devel"
su -c "yum -y install graphviz-python"

# A useful package for manipulating images
su -c "yum -y install ImageMagick"

# Become root and su to user postgres in order to have permissions create the postgis template database
su
su postgres

# Create the postgis template  database (Note: depending on versions, your paths may vary)
createdb postgis
createlang plpgsql postgis
psql -d postgis -f /usr/pgsql-9.1/share/contrib/postgis-1.5/postgis.sql
psql -d postgis -f /usr/pgsql-9.1/share/contrib/postgis-1.5/spatial_ref_sys.sql

# For ability for persistant storage of GIFS, assuming default location of your web server is /var/www/html
mkdir /tmp/media
su -c 'ln -s /tmp/media /var/www/html/media'

# Build GDAL from source.  Download latest (v1.9 or higher) tar ball from http://download.osgeo.org/gdal/
# Unpack, and in the top level directory (e.g. gdal-1.9.0/) run ('make install' must be done as root):
su -c "yum -y install expat-devel"              # Required for KML parsing support
./configure --with-python
make
make install

# Mapserver:
# ---------
# To build MapServer some prerequisites will need to be installed:
su -c "yum -y install freetype-devel libpng-devel giflib-devel libjpeg-devel gd-devel proj-devel"
su -c "yum -y install proj-nad proj-epsg curl-devel libxml2-devel"

# Install MapServer following the instructions for your system at http://mapserver.org/.  It is typical to
# build it from source and then copy the 'mapserv' executable to the cgi-bin directory for your web server.
# The .map templates assume that this is where the mapserv executable is located.  You will set the MapServer
# host name (MAPSERVER_HOST) for your privateSettings file.  It _can_ be a separate server from your Django 
# server, but it must be able to see the .map files produced by Django through a network mount or some other 
# mechanism.

# Make sure the file at /usr/share/proj/epsg contains a line starting with <900913>; if not, append the following lines:

# Spherical Mercator
<900913> +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs <>

# With the above prerequisites, mapserver configure can be run as follows:
./configure --with-proj=/usr --with-ogr=/usr/local/bin/gdal-config --with-gdal=/usr/local/bin/gdal-config --with-wfs --with-wfsclient --with-wmsclient --with-postgis=/usr/pgsql-9.1/bin/pg_config
make 
cp mapserv /var/www/cgi-bin


# Make sure that the apache httpd service is running on your system
chkconfig httpd on
/sbin/service httpd start

# The following prerequisites must be installed for each development directory on the system for which the 
# above system-level prerequisites have been installed.

# Go to the directory where you have checked out the stoqs project, e.g.:

cd ~/dev/stoqshg

# Instructions below are for setting up a development or "sandbox" environment.  If you are running 
# in a production environment where you have system admin support then it's likely that all of 
# these Python libraries have been installed at the system level and you will not need to create
# the venv-stoqs virtual environment with these packages, though you may find it convenient to run
# the virtual environment regargless.
 
# Create a venv for a development environment
virtualenv venv-stoqs
source venv-stoqs/bin/activate      # source venv-stoqs/bin/activate.csh if using csh or tcsh


# Install additional Python packages required by STOQS. (Make sure you are in your venv
# - your prompt should look something like "(venv-stoqs)[student@localhost stoqshg]$ "):
pip install numpy
pip install paste
pip install pydap
pip install django==1.3
pip install django-celery
pip install coards
pip install seawater
export PATH=/usr/pgsql-9.1/bin:$PATH
pip install gdal==1.9.0                # Make sure the version matches the gdal you compiled and installed
pip install psycopg2==2.4.1            # Do not use a higher version of psycopg2 - it has problems with postgresql-9.1
pip install pygraphviz
pip install django_extensions
pip install beautifulsoup4
pip install sqlparse

# For server-side Matlab-style plotting of data
pip install -e git+https://github.com/matplotlib/matplotlib.git#egg=matplotlib


# When running django-admin.py or 'python manage.py' do it in your virtualenv, making
# sure your prompt looks something like "(venv-stoqs)[student@localhost stoqshg]$ "
# Proceed to the instructions in the INSTALL file.

--
Mike McCann
MBARI 31 January 2013


